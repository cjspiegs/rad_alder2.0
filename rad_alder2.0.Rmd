---
title: "Terrestrial subsidy-associated microbes mediate accelerated decomposition in aquatic ecosystems"
author: "CJ Spiegel et al. 2023, in prep"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
  editor_options:
      chunk_output_type: console
---

### Project overview
Project ‘RAD’ Alder explores the role of resident leaf-associated microbes presence (P) and absence ((AB), i.e., gamma irradiated) leaf packs deployed at “home” (H) and “away” (AW) rivers in leaf litter decomposition. We utilized a reciprocal transplant experiment between two rivers, the Hoko (HOK) and the Sekiu (SEK), on the WA state Olympic Peninsula. This 2x2 factorial design yielded four treatments: 1) P-H, 2) P-AW, 3) AB-H, and 4) AB-AW and we asked the following questions:

i) How does dispersal from the regional species pool (i.e., source communities) influence community composition on the leaf packs?
ii) How does microbial community composition (alpha and beta diversity) and function differ between the leaf packs, as well as change over the course of decomposition?
iii) How does alder stoichiometric and secondary chemical composition differ between the leaf packs, as well as change over the course of decomposition?
iv) How does microbial metabolization differ between the leaf packs, as well as change over the course of decomposition?
v) How does particulate leaf mass loss differ between the leaf packs?


**DATA SETS**  
This data set focuses on:  

(1) **Metabolism assay** 
(2) **Leaf mass loss** using % mass loss and HFAI
(3) **Alder C and N isotopic composition**
(4) **Alder secondary chemistry (via LC-MS/MS)** 
```{r setup chunk, setup, include = FALSE, cache=FALSE, message=FALSE, warning=FALSE}
if (!require('knitr')) install.packages('knitr'); library('knitr')
knitr::opts_chunk$set(warning=FALSE, message=FALSE, fig.align='center')

# load packages
if (!require("pacman")) install.packages("pacman") # for rapid install if not in library

# use pacman to load all the packages you are missing!
pacman::p_load('knitr', 'lme4', 'tidyverse', 'magrittr', 'effects', 'plyr', 'dplyr', 'plotrix', 'car',"lmerTest", "gridExtra", "cowplot", "tools", "tidymv", "ggthemes", "ggpubr", "scales", "emmeans", "fBasics", "MASS", "stringr",
"purrr")

Fig.formatting<-(theme_classic()) +
  theme(text=element_text(size=25),
        legend.text.align = 0,
        panel.border = element_rect(fill=NA, colour = "black", size=1),
        aspect.ratio=1, 
        axis.ticks.length=unit(0.25, "cm"),
        axis.text.y=element_text(
        margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour="black", size=20), 
        axis.text.x=element_text(
        margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour="black", size=20)) +
  theme(legend.key.size = unit(0.4, "cm"), legend.position = "right") +
  theme(aspect.ratio=0.5) 




```

**Note on absorbance**
Iodonitrotetrazolium chloride (INT) is utilized as a redox dye to gauge microbial activity in assays. Microbes with metabolic activity can reduce INT to a formazan compound, causing a color change from yellow (oxidized form) to red or purple (reduced form). This reduction reaction is often catalyzed by dehydrogenase enzymes present in metabolically active cells. The formazan product is  insoluble and has a distinct color (i.e., absorbance), leading to a visible change in the solution's color. The intensity of the color or absorbance is indicative of microbial metabolic activity.

We measured absorbance at 450 nm (see Blenkinsopp & Lock, 1990; Friedel et al., 1994; Jackson et al., 2013; Bhupathiraju et al., 1998) at different intervals (e.g., 30 mins, 2 h, 16 h, 24 h, 48 h, and 72 h) to track changes in microbial metabolic activity over time.

### Import metabolism assay data
```{r}
#add data files
#day 1
meta.day1.450.df<- read.csv("/Users/cjspiegel/Desktop/GitHub/rad_alder2.0/data/assay/day_1_450_clean.csv")
#day 3
meta.day3.450.df<- read.csv("/Users/cjspiegel/Desktop/GitHub/rad_alder2.0/data/assay/day_3_450_clean.csv")
#day 5
meta.day5.450.df<- read.csv("/Users/cjspiegel/Desktop/GitHub/rad_alder2.0/data/assay/day_5_450_clean.csv")
#day 7
meta.day7.450.df<- read.csv("/Users/cjspiegel/Desktop/GitHub/rad_alder2.0/data/assay/day_7_450_clean.csv")
#day 11
meta.day11.450.df<- read.csv("/Users/cjspiegel/Desktop/GitHub/rad_alder2.0/data/assay/day_11_450_clean.csv")
#day 17
meta.day17.450.df<- read.csv("/Users/cjspiegel/Desktop/GitHub/rad_alder2.0/data/assay/day_17_450_clean.csv")

#merge all days 450nm
meta.450.df<- rbind(
  meta.day1.450.df, 
  meta.day3.450.df,
  meta.day5.450.df,
  meta.day7.450.df, 
  meta.day11.450.df, 
  meta.day17.450.df
  )

#remove well_id columns
meta.450.df<- meta.450.df[, !colnames(meta.450.df) %in% "well_id"]

#create 'home' and 'away' groups based on deployment and metabolite pair
#if deploy is HOK, metabolite is HOK (home)
#if deplpy is SEK, metaboltie is SEK (home)
#if deploy is HOK, metaboltie is SEK (away)
#if deploy is SEK, metabolite is HOK (away)
meta.450.df$group <- 
  ifelse(
  meta.450.df$deploy == "HOK" & meta.450.df$metabolite == "HOK", "H",
   ifelse(
  meta.450.df$deploy == "SEK" & meta.450.df$metabolite == "SEK", "H",
   ifelse(
   meta.450.df$deploy == "HOK" & meta.450.df$metabolite == "SEK", "AW",
   ifelse(
   meta.450.df$deploy == "SEK" & meta.450.df$metabolite == "HOK", "AW", NA  # Default value if none of the conditions are met
                )
              )
            )
          )

#add hours rather than minutes
meta.450.df$hours <- 
  ifelse(
  meta.450.df$time == "30", "0.5",
   ifelse(
  meta.450.df$time == "120", "2",
   ifelse(
   meta.450.df$time == "960", "16",
   ifelse(
   meta.450.df$time == "1440", "24",
    ifelse(
   meta.450.df$time == "2880", "48",
   ifelse(
   meta.450.df$time == "4320", "72", NA  # Default value if none of the conditions are met
                )
              )
            )
          )
)
)

#reorder hours
meta.450.df<- meta.450.df %>% mutate(hours = factor(hours, levels = c("0.5", "2", "16", "24", "48", "72")))

#make colummn factors
meta.450.df$treatment<- as.factor(meta.450.df$treatment)
meta.450.df$tree_id<- as.factor(meta.450.df$tree_id)
meta.450.df$deploy<- as.factor(meta.450.df$deploy)
meta.450.df$metabolite<- as.factor(meta.450.df$metabolite)
meta.450.df$group<- as.factor(meta.450.df$group)
meta.450.df$hours<- as.factor(meta.450.df$hours)

#subset by true home 
deploy.hok_only.df<- meta.450.df[meta.450.df$deploy=="HOK" & meta.450.df$tree_id=="HOK",]
deploy.sek_only.df<- meta.450.df[meta.450.df$deploy=="SEK" & meta.450.df$tree_id=="SEK",]
#merge
true_home.meta.df<- rbind(deploy.hok_only.df, deploy.sek_only.df)
#make colummn factors
true_home.meta.df$treatment<- as.factor(true_home.meta.df$treatment)
true_home.meta.df$tree_id<- as.factor(true_home.meta.df$tree_id)
true_home.meta.df$deploy<- as.factor(true_home.meta.df$deploy)
true_home.meta.df$metabolite<- as.factor(true_home.meta.df$metabolite)
true_home.meta.df$group<- as.factor(true_home.meta.df$group)
true_home.meta.df$hours<- as.factor(true_home.meta.df$hours)

##### false home/away #####

#subset by false home 
deploy.hok.df<- meta.450.df[meta.450.df$deploy=="HOK" & meta.450.df$tree_id=="SEK",]
deploy.sek.df<- meta.450.df[meta.450.df$deploy=="SEK" & meta.450.df$tree_id=="HOK",]
#merge
false_home.meta.df<- rbind(deploy.hok.df, deploy.sek.df)

```

We are interested in the true "home" and "away" comparisons between the treatments. Blenkinsopp & Lock (1990) found that INT was produced asymptotically over a 16 hr incubation period. Given the specific conditions of the study, researchers encourage a longer incubation for INT-formazan reduction to occur. We analyze metabolization at 16 h. 

Explore and visualize the corrected OD at 24 hr, 450 nm
```{r}
#subset at 16 h
true_home.16.meta.df<- true_home.meta.df%>%
  na.omit()%>%
  filter(hours == "16")
#convert classes
true_home.16.meta.df$treatment<- as.factor(true_home.16.meta.df$treatment)
true_home.16.meta.df$tree_id<- as.factor(true_home.16.meta.df$tree_id)
true_home.16.meta.df$deploy<- as.factor(true_home.16.meta.df$deploy)
true_home.16.meta.df$decomp_day<- as.factor(true_home.16.meta.df$decomp_day)
true_home.16.meta.df$site_num<- as.factor(true_home.16.meta.df$site_num)
true_home.16.meta.df$tree_num<- as.factor(true_home.16.meta.df$tree_num)
true_home.16.meta.df$metabolite<- as.factor(true_home.16.meta.df$metabolite)
true_home.16.meta.df$group<- as.factor(true_home.16.meta.df$group)
true_home.16.meta.df$hours<- as.factor(true_home.16.meta.df$hours)

#general plot 
true_home.16.meta.df %>%
  ggplot(aes(x = group, y = od_corrected_b_n, fill = treatment, color = treatment, alpha = 0.4)) +
  geom_point(aes(color = treatment), alpha = 0.4)+
  geom_boxplot(alpha = 0.4)+
  facet_grid(~decomp_day)+
  labs(x = "group", y = "od corrected")+
   guides(linetype = guide_legend(override.aes = list(color = "cornflowerblue")))+
  theme_bw()

#histogram of od corrected
true_home.16.meta.df%>%
  group_by(treatment, tree_id, deploy, metabolite, site_num, tree_num, decomp_day,group)%>%
  mutate(mean_od = mean(od_corrected_b_n))%>%
  pull(mean_od)%>%
  hist()

true_home.16.meta.df%>%
  group_by(treatment, tree_id, deploy, metabolite, site_num, tree_num, decomp_day,group)%>%
  pull(od_corrected_b_n)%>%
  hist()

#normality test 
library(fBasics)
true_home.16.meta.df%>%
  group_by(treatment, tree_id, deploy, metabolite, site_num, tree_num, decomp_day, group)%>%
  pull(od_corrected_b_n)%>%
  normalTest(method = "da")
#corrected od is not normally distributed. Apply log transformation.

#log transform raw od
true_home.16.meta.df<- true_home.16.meta.df %>%
  group_by(treatment, tree_id, deploy, metabolite, site_num, tree_num, decomp_day, group)%>%
  mutate(log_od = log(od_corrected_b_n))
#normality
true_home.16.meta.df%>%
  filter(treatment == "P", group == "H")%>%
  group_by(treatment, tree_id, deploy, metabolite, site_num, tree_num, decomp_day, group)%>%
 pull(log_od)%>%
  hist()
#normality
true_home.16.meta.df%>%
  filter(treatment == "AB", group == "H")%>%
  group_by(treatment, tree_id, deploy, metabolite, site_num, tree_num, decomp_day, group)%>%
 pull(log_od)%>%
  hist()
  
#double check log transformed normality for all
true_home.16.meta.df%>%
  group_by(treatment, tree_id, deploy, metabolite, site_num, tree_num, decomp_day, group)%>%
  pull(log_od)%>%
  normalTest(method = "da")

```

We can proceed with hypothesis testing now that we have explored and visualized the data.

We hypothesize that resident subsidy-associated microbes are important in some way since evidence has found that bacterial OTU's were derived more from terrestrial leaves, and increased over the course of decomposition (Jackrel et al., 2019 mBio). We therefore expect that residents influence decomposition by either facilitating or inhibiting microbial colonization that affects overall decomposition rates. 

H0: treatment = 0, group = 0, treatment:group = 0, decomposition day = 0, tree id = 0
HA: at least one predictor != 0

In this case, the null hypothesis is that there is no difference among all predictors. The alternative hypothesis states that at least one predictor is different or is not equal to zero. 
```{r}
###build some big models
##first, let's look at random effects
#triple nested
meta_bigmod<- lmer(log_od ~ treatment * group + (1 | decomp_day) + (1 | deploy) + (1 | tree_id/site_num/tree_num) , data = true_home.16.meta.df)

#double nested
meta_bigmod2<- lmer(log_od ~ treatment * group + (1 | decomp_day)  + (1 | deploy) + (1 | tree_id) + (1 | site_num/tree_num) , data = true_home.16.meta.df)

#single nested (this is inherent in the experimental design where tree num is nested within site)
meta_bigmod3<- lmer(log_od ~ treatment * group + (1 | decomp_day)  + (1 | deploy) + (1 | site_num:tree_num) , data = true_home.16.meta.df)

meta_bigmod4<- lmer(log_od ~ treatment * group + (treatment | decomp_day) + (group | decomp_day)  + (1 | deploy) + (1 | site_num:tree_num) , data = true_home.16.meta.df)

meta_bigmod5<- lmer(log_od ~ treatment * group + (treatment | decomp_day) + (1 | deploy) + (1 | site_num:tree_num) , data = true_home.16.meta.df)

meta_bigmod6<- lmer(log_od ~ treatment * group + (group | decomp_day)  + (1 | deploy) + (1 | site_num:tree_num) , data = true_home.16.meta.df)

#compare
AIC(meta_bigmod, meta_bigmod2, meta_bigmod3, meta_bigmod4, meta_bigmod5, meta_bigmod6)

#check to see if glmer is needed
meta_glmmod<- glmer(od_corrected_b_n ~ treatment * group + (treatment | decomp_day) + (1 | deploy) + (1 | site_num:tree_num) , data = true_home.16.meta.df, family = Gamma(link = "log"))

#compare lmer vs glmer
AIC(meta_bigmod5,meta_glmmod)

```

Big mod selection
```{r}
#can we remove any predictors
step(meta_bigmod5)

#even though the step function removes deploy and treatment*group interaction, the AIC difference is small. We will keep random effect deploy and interaction.
##best big model
meta_bestmod<- lmer(log_od ~ treatment * group + (treatment | decomp_day) + (1 | deploy) + (1 | site_num:tree_num) , data = true_home.16.meta.df)
#check the best mod
plot(resid(meta_bestmod))
hist(resid(meta_bestmod))
normalTest(resid(meta_bestmod), method = "da")
#create a big null mod
meta_nullmod<- lmer(log_od ~ (treatment | decomp_day) + (1 | deploy) + (1 | site_num:tree_num) , data = true_home.16.meta.df)
#compare best w/ null
anova(meta_bestmod,meta_nullmod)
#mod summary
summary(meta_bestmod)

### maybe we can see pairwise among decomp day ###
meta_decompmod<- lmer(log_od ~ treatment * group + decomp_day + (1 | deploy) + (1 | site_num:tree_num) , data = true_home.16.meta.df)
#means
decomp_means <- emmeans(meta_decompmod, ~ treatment:group + decomp_day)
summary(decomp_means)
decomp_pairs<- pairs(decomp_means)
#convert decomp_pairs to df
decomp_pairs_df <- as.data.frame(decomp_pairs)
decomp_pairs_df

```

paired t test
```{r}
true_home.16.meta.df %>%
  filter(treatment == "P", deploy == "HOK", site_num == 2, tree_num == 5, group %in% c("H", "AW"), decomp_day == "3") %>%
  pivot_wider(names_from = group, values_from = log_od, names_prefix = "log_od_") %>%
  filter(!is.na(log_od_H) & !is.na(log_od_AW)) %>%
  mutate(delta = log_od_H - log_od_AW)


```



Model for at home only
```{r}
##best big home model
meta_bighomemod<- lmer(log_od ~ treatment + (treatment | decomp_day) + (1 | deploy) + (1 | site_num:tree_num), subset= group == "H", data = true_home.16.meta.df)


meta_bighomemod2<- lmer(log_od ~ treatment + (1 | decomp_day) + (1 | deploy) + (1 | site_num:tree_num), subset= group == "H", data = true_home.16.meta.df)

meta_bighomemod3<- lmer(log_od ~ treatment + (0 + treatment| decomp_day) + (1 | deploy) + (1 | site_num:tree_num), subset= group == "H", data = true_home.16.meta.df)

#compare
AIC(meta_bighomemod,meta_bighomemod2, meta_bighomemod3)
                           
#check the best home mod
plot(resid(meta_bighomemod))
hist(resid(meta_bighomemod))
normalTest(resid(meta_bighomemod2), method = "da")

#create a home null mod
meta_homenullmod<- lmer(log_od ~  (treatment | decomp_day) + (1 | deploy) + (1 | site_num:tree_num), subset= group == "H", data = true_home.16.meta.df)

#compare the best vs null
anova(meta_homenullmod, meta_bighomemod)

#mod summary
summary(meta_bighomemod)
Anova(meta_bighomemod)
#mean difference p vs ab
#estimate for absent
exp(0.08119)
#estimate for present
exp(0.21973 )
exp(0.08119)+exp(0.21973 )
#calculate times greater...
2.330317/1.084577
#confidence intervals
bighomemod_fixed <- fixef(meta_bighomemod)
se <- sqrt(diag(vcov(meta_bighomemod)))
#calculation
lower_ci <- exp(bighomemod_fixed - 1.96 * se)
lower_ci
upper_ci <- exp(bighomemod_fixed + 1.96 * se)
upper_ci

#estimate marginal means
#maybe we can see pairwise among decomp day w/ interaction
meta_home_inter_decompmod<- lmer(log_od ~ treatment * decomp_day + (1 | deploy) + (1 | site_num:tree_num), subset= group == "H", data = true_home.16.meta.df)
summary(meta_home_inter_decompmod)

meta_home_add_decompmod<- lmer(log_od ~ treatment +  decomp_day + (1 | deploy) + (1 | site_num:tree_num), subset= group == "H", data = true_home.16.meta.df)


#compare with global home mod
AIC(meta_home_inter_decompmod,meta_bighomemod )
anova(meta_home_inter_decompmod,meta_bighomemod )

#holding decomposition day 
meta_home_add_decompmod<- lmer(log_od ~ treatment + (1 | decomp_day) + (1 | deploy) + (1 | site_num:tree_num), subset= group == "H", data = true_home.16.meta.df)

anova(meta_home_inter_decompmod,meta_home_add_decompmod )
AIC(meta_home_inter_decompmod,meta_home_add_decompmod)

#check out mod
plot(resid(meta_home_inter_decompmod))
hist(resid(meta_home_inter_decompmod))
#summary
summary(meta_home_inter_decompmod)
#backtransformed
exp(summary(meta_home_decompmod)$coefficients)

#means
home_decomp_means <- emmeans(meta_home_inter_decompmod, ~ treatment : decomp_day)
#extract the emmeans results
home_decomp_means_df <- as.data.frame(home_decomp_means)
#manually back-transform the estimates
home_decomp_means_df$emmean <- exp(home_decomp_means_df$emmean)
home_decomp_means_df$lower.CL <- exp(home_decomp_means_df$lower.CL)
home_decomp_means_df$upper.CL <- exp(home_decomp_means_df$upper.CL)
home_decomp_means_df

#perform pairwise comparisons on the original log-scale emmeans
home_decomp_pairs <- as.data.frame(pairs(home_decomp_means, adjust = "tukey"))

#convert the estimates from log scale to response scale (exponentiation)
home_decomp_pairs$estimate <- exp(home_decomp_pairs$estimate)
home_decomp_pairs$SE <- exp(home_decomp_pairs$SE)
#add sig column
home_decomp_pairs$significant <- home_decomp_pairs$p.value < 0.05
View(home_decomp_pairs)
head(home_decomp_pairs)
##plot
ggplot(home_decomp_pairs, aes(x = contrast, y = estimate, ymin = estimate - SE, ymax = estimate + SE, color = significant)) +
  geom_pointrange() +
  geom_hline(yintercept = 1, linetype = "dashed") +
  scale_color_manual(values = c("grey", "red"), labels = c("insignificant", "significant")) + 
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(color = guide_legend(title = "Comparisons"))+
  labs(
    title = "Pairwise Comparisons",
    x = "Comparison",
    y = "Estimate (with 95% CI)",
    color = "Significant")

```

Below are a few ways to visualize the data
```{r}
#general boxplot 
true_home.16.meta.df %>%
  ggplot(aes(x = group, y = log_od, fill = treatment, color = treatment, alpha = 0.4)) +
  geom_point(aes(color = treatment), alpha = 0.4)+
  geom_boxplot(alpha = 0.4)+
  facet_grid(~decomp_day)+
  labs(x = "group", y = "log trans od")+
   guides(linetype = guide_legend(override.aes = list(color = "cornflowerblue")))+
  theme_bw()

#big interaction plot: all treatments
meta.interact_plot<- true_home.16.meta.df %>%
  ggplot(aes(x = as.factor(decomp_day), y = log_od, color = group, shape = treatment)) +
  stat_summary(fun = mean, geom = "point", size = 6, position = position_dodge(width = 0.5)) +
   stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.4, position = position_dodge(width = 0.5), size = 1.2) +
  scale_color_tableau(palette = "Color Blind", labels = c("away", "home")) +
  scale_shape_manual(values = c(17, 16), labels = c("absent", "present")) +
  geom_hline(aes(yintercept = mean(log_od)), color = "red3", linetype = "dashed")+
  labs(x = "decomposition day", y = expression("log(OD"[450 * nm]*")"))+
  theme_bw()+
  theme(axis.text = element_text(size = 16),
        axis.title = element_text(size = 16),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 16))

ggsave("figures/meta.interact_plot.png", meta.interact_plot, width = 14, height = 7)

#big interaction w/ 4 separate treatment groups
meta.biginteract_plot<- true_home.16.meta.df %>%
  mutate(group_treatment = factor(interaction(group, treatment), 
                                  levels = c("AW.P", "AW.AB", "H.P", "H.AB"))) %>%
  ggplot(aes(x = as.factor(decomp_day), y = log_od, color = group_treatment, shape = group_treatment)) +
  stat_summary(fun = mean, geom = "point", size = 6, position = position_dodge(width = 0.5)) +
   stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.4, position = position_dodge(width = 0.5), size = 1.2) +
  scale_color_grey(start = 0, end = 0.6, labels = c("AW.AB" = "away,absent", "H.AB" = "home, absent", "AW.P" = "away,present", "H.P" = "home,present"))+
    scale_shape_manual(values = c(15,16,17,18), labels = c("AW.AB" = "away,absent", "H.AB" = "home, absent", "AW.P" = "away,present", "H.P" = "home,present"))+
  geom_hline(aes(yintercept = mean(log_od)), color = "red3", linetype = "dashed")+
  labs(x = "decomposition day", y = expression("log(OD"[450 * nm]*")"))+
  guides(color = guide_legend(title = "Groups"), shape = guide_legend(title = "Groups")) +
  theme_bw()+
  theme(axis.text = element_text(size = 16),
        axis.title = element_text(size = 16),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 16))

ggsave("figures/meta.biginteract_plot.png", meta.biginteract_plot, width = 14, height = 7)


###at home only——present vs absent plot
meta.homeonly_plot<- true_home.16.meta.df%>%
  filter(group == "H") %>%
  ggplot(aes(x = as.factor(decomp_day), y = log_od, color = treatment, shape = treatment)) +
  stat_summary(fun = mean, geom = "point", size = 6, position = position_dodge(width = 0.5)) +
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.4, position = position_dodge(width = 0.5), size = 1.2) +
  scale_color_manual(values = c("AB" = "black", "P" = "grey60"), labels = c("absent", "present")) +
  scale_shape_manual(values = c("AB" = 17, "P" = 16), labels = c("absent", "present")) +
  geom_hline(aes(yintercept = mean(log_od)), color = "red3", linetype = "dashed") +
  labs(x = "decomposition day", y = expression("log(OD"[450 * nm]*")")) +
  guides(color = guide_legend(override.aes = list(shape = c(17, 16))))+
  theme_bw() +
  theme(axis.text = element_text(size = 18),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18))

ggsave("figures/meta.homeonly_plot.png", meta.homeonly_plot, width = 14, height = 7)

###just present treatment——home vs away plot
meta.p_only_plot<- true_home.16.meta.df %>%
  filter(treatment == "P") %>%
  ggplot(aes(x = as.factor(decomp_day), y = log_od, color = group, shape = group)) +
  stat_summary(fun = mean, geom = "point", size = 6, position = position_dodge(width = 0.5)) +
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.4, position = position_dodge(width = 0.5), size = 1.2) +
  scale_color_manual(values = c("AW" = "black", "H" = "grey60"), labels = c("away", "home")) +
  scale_shape_manual(values = c("AW" = 17, "H" = 16), labels = c("away", "home")) +
  geom_hline(aes(yintercept = mean(log_od)), color = "red3", linetype = "dashed") +
  labs(x = "Decomposition Day", y = expression("log(OD"[450 * nm]*")")) +
  guides(color = guide_legend(override.aes = list(shape = c(17, 16))))+
  theme_bw() +
  theme(axis.text = element_text(size = 16),
        axis.title = element_text(size = 16),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 16))

meta.p_only_plot

ggsave("figures/meta.p_only_plot.png", meta.p_only_plot, width = 14, height = 7)

##present and abesent at home, as well as present at away (exlude absent/away)
# Add a column to mark rows to keep
true_home.16.meta_subset.df <- true_home.16.meta.df %>%
  mutate(keep_row = ifelse(treatment == "AB" & group == "AW", FALSE, TRUE))

# Filter based on the new column
filtered_data <- true_home.16.meta_subset.df %>%
  filter(keep_row == TRUE)
#filter again
filtered_data %>%
  group_by(treatment, tree_id, deploy, metabolite, site_num, tree_num, group)%>%
  filter(group == "AW" & treatment == "P") %>%
  tally()

#plot
meta.mean.noabaw_plot<- filtered_data %>%
  ggplot(aes(x = as.factor(decomp_day), y = log_od, color = group, shape = treatment)) +
  stat_summary(fun = mean, geom = "point", size = 6, position = position_dodge(width = 0.5)) +
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.4, position = position_dodge(width = 0.5), size = 1.2) +
  scale_color_tableau(palette = "Color Blind", labels = c("away", "home")) +
  scale_shape_manual(values = c(17, 16), labels = c("absent", "present"))+
  geom_hline(aes(yintercept = mean(log_od)), color = "red3", linetype = "dashed") +
  labs(x = "decomposition day", y = expression("log(OD"[450 * nm]*")")) +
  theme_bw() +
  theme(axis.text = element_text(size = 16),
        axis.title = element_text(size = 16),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 16))

meta.mean.noabaw_plot


ggsave("figures/meta.mean.noabaw_plot.png", meta.mean.noabaw_plot, width = 14, height = 7)


```

This shows the "true" home and away scenario for the comparison between treatments.

We can try z scoring the data rather than applying a log transformation. Spoiler: z scored OD is not normally distributed...we therefore won't use it.
```{r}
#all hok
true_home.hok.zscore.df <- true_home.16.meta.df %>%
  group_by(treatment, tree_id, deploy, metabolite, site_num, tree_num, group)%>%
  filter(deploy == "HOK") %>%
  mutate(z_score = (od_corrected_b_n - mean(od_corrected_b_n)) / sd(od_corrected_b_n))

#HOK 1 subset 
true_home.hok1.zscore.df <- true_home.16.meta.df %>%
  group_by(treatment, tree_id, deploy, metabolite, site_num, tree_num, group)%>%
  filter(deploy == "HOK" & site_num == "1") %>%
  mutate(z_score = (od_corrected_b_n - mean(od_corrected_b_n)) / sd(od_corrected_b_n))

#HOK 2 subset 
true_home.hok2.zscore.df <- true_home.16.meta.df %>%
    group_by(treatment, tree_id, deploy, metabolite, site_num, tree_num, group)%>%
  filter(deploy == "HOK" & site_num == "2") %>%
  mutate(z_score = (od_corrected_b_n - mean(od_corrected_b_n)) / sd(od_corrected_b_n))

#merge hok
true_home.hok.zscore.df<- rbind(true_home.hok1.zscore.df,true_home.hok2.zscore.df)

#all sek
true_home.sek.zscore.df <- true_home.16.meta.df %>%
  group_by(treatment, tree_id, deploy, metabolite, site_num, tree_num, group)%>%
  filter(deploy == "SEK") %>%
  mutate(z_score = (od_corrected_b_n - mean(od_corrected_b_n)) / sd(od_corrected_b_n))

#SEK 1 subset 
true_home.sek1.zscore.df <- true_home.16.meta.df %>%
    group_by(treatment, tree_id, deploy, metabolite, site_num, tree_num, group)%>%
  filter(deploy == "SEK" & site_num == "1") %>%
  mutate(z_score = (od_corrected_b_n - mean(od_corrected_b_n)) / sd(od_corrected_b_n))


#SEK 2 subset 
true_home.sek2.zscore.df <- true_home.16.meta.df %>%
    group_by(treatment, tree_id, deploy, metabolite, site_num, tree_num, group)%>%
  filter(deploy == "SEK" & site_num == "2") %>%
  mutate(z_score = (od_corrected_b_n - mean(od_corrected_b_n)) / sd(od_corrected_b_n))

#merge sek 
true_home.sek.zscore.df<- rbind(true_home.sek1.zscore.df, true_home.sek2.zscore.df)

##merge sek and hok
true_home.zscore.df<- rbind(true_home.hok.zscore.df,true_home.sek.zscore.df)
View(true_home.zscore.df)
class(true_home.zscore.df$group)

#normality
hist(true_home.zscore.df[true_home.zscore.df$group == "H" & true_home.zscore.df$treatment == "AB",]$z_score)

normalTest(true_home.zscore.df$z_score, method = "da")

#plot
true_home.zscore.df %>%
  ggplot(aes(x = as.factor(decomp_day), y = z_score, color = group, shape = treatment)) +
  stat_summary(fun = mean, geom = "point", size = 6, position = position_dodge(width = 0.5)) +
   stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.4, position = position_dodge(width = 0.5), size = 1.2) +
  scale_color_tableau(palette = "Color Blind", labels = c("away", "home")) +
  scale_shape_manual(values = c(17, 16), labels = c("absent", "present")) +
  geom_hline(aes(yintercept = mean(trans_od)), color = "red3", linetype = "dashed")+
  labs(x = "decomposition day", y = expression("log(OD"[450 * nm]*")"))+
  theme_bw()+
  theme(axis.text = element_text(size = 16),
        axis.title = element_text(size = 16),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 16))
```

----- will likely delete below chunks----

1/2/24 anova and boxplots
```{r}
######### anova and boxplots

##### present box (use response: od_corrected_b_n)
day1.p.meta_aov1=aov(z_score ~ group, subset = decomp_day == "1", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
plot(resid(day1.p.meta_aov1))

day1.p.meta_aov2=aov(od_corrected_b_n ~ group, subset = decomp_day == "1", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
plot(resid(day1.p.meta_aov2))
summary(day1.p.meta_aov)

AIC(day1.p.meta_aov1,day1.p.meta_aov2)


day1.p.meta_lmer=lmer(od_corrected_b_n ~ group + (1 | deploy) + (1|tree_id) + ( 1 | site_num) + (1|tree_num), subset = decomp_day == "1", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
summary(day1.p.meta_lmer)
plot(resid(day1.p.meta_lmer))

AIC(day1.p.meta_aov,day1.p.meta_lmer)

day3.p.meta_aov1=aov(z_score ~ group, subset = decomp_day == "3", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
summary(day3.p.meta_aov1)

day3.p.meta_aov=aov(od_corrected_b_n ~ group, subset = decomp_day == "3", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
summary(day3.p.meta_aov)
day3.p.meta_lmer=lmer(od_corrected_b_n ~ group + (1 | deploy) + (1|tree_id) + ( 1 | site_num) + (1|tree_num), subset = decomp_day == "3", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
summary(day3.p.meta_lmer)

day5.p.meta_aov1=aov(z_score ~ group, subset = decomp_day == "5", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
summary(day5.p.meta_aov1)

day5.p.meta_lmer2=lmer(z_score ~ group  + (1 | tree_id) , subset = decomp_day == "5", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
AIC(day5.p.meta_aov1,day5.p.meta_lmer2)

day5.p.meta_aov=aov(od_corrected_b_n ~ group, subset = decomp_day == "5", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
summary(day5.p.meta_aov)
day5.p.meta_lmer=lmer(od_corrected_b_n ~ group + (1 | deploy) + (1|tree_id) + ( 1 | site_num) + (1|tree_num), subset = decomp_day == "5", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
summary(day5.p.meta_lmer)


day7.p.meta_aov1=aov(z_score ~ group, subset = decomp_day == "7", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
summary(day7.p.meta_aov1)

day7.p.meta_aov=aov(od_corrected_b_n ~ group, subset = decomp_day == "7", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
summary(day7.p.meta_aov)
day7.p.meta_lmer=lmer(od_corrected_b_n ~ group + (1 | deploy) + (1|tree_id) + ( 1 | site_num) + (1|tree_num), subset = decomp_day == "7", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
summary(day7.p.meta_lmer)


day11.p.meta_aov1=aov(z_score ~ group, subset = decomp_day == "11", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
summary(day11.p.meta_aov1)

day11.p.meta_aov=aov(od_corrected_b_n ~ group, subset = decomp_day == "11", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
summary(day11.p.meta_aov)
day11.p.meta_lmer=lmer(od_corrected_b_n ~ group + (1 | deploy) + (1|tree_id) + ( 1 | site_num) + (1|tree_num), subset = decomp_day == "11", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
summary(day11.p.meta_lmer)


day17.p.meta_aov1=aov(z_score ~ group, subset = decomp_day == "17", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
summary(day17.p.meta_aov1)

day17.p.meta_aov=aov(od_corrected_b_n ~ group, subset = decomp_day == "17", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
summary(day17.p.meta_aov)
day17.p.meta_lmer=lmer(od_corrected_b_n ~ group + (1 | deploy) + (1|tree_id) + ( 1 | site_num) + (1|tree_num), subset = decomp_day == "17", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
summary(day17.p.meta_lmer)

#based on the above model comparisons (lower AIC), we will use anova with response: z score
day1.p.meta_aov1=aov(z_score ~ group, subset = decomp_day == "1", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
day3.p.meta_aov1=aov(z_score ~ group, subset = decomp_day == "3", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
day5.p.meta_aov1=aov(z_score ~ group, subset = decomp_day == "5", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
day7.p.meta_aov1=aov(z_score ~ group, subset = decomp_day == "7", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
day11.p.meta_aov1=aov(z_score ~ group, subset = decomp_day == "11", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))
day17.p.meta_aov1=aov(z_score ~ group, subset = decomp_day == "17", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="P",]))


#model ouput
summary(day1.p.meta_aov1)
summary(day3.p.meta_aov1)
summary(day5.p.meta_aov1)
summary(day7.p.meta_aov1)
summary(day11.p.meta_aov1)
summary(day17.p.meta_aov1)

#present boxplot
p.meta.true_home.boxplot=merged.true_home_z.df%>%
    na.omit() %>%
  filter(treatment == "P")%>%
  ggplot(aes(x = group, y = z_score, fill = group, group = group)) +
  geom_boxplot(alpha= 0.5)+
  xlab("group")+
  ggtitle("Present treatment only")+
    ylab(expression("standardized optical density (OD"[450~nm]*")"))+
  scale_fill_colorblind()+
    geom_hline(aes(yintercept = 0, linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
coord_cartesian(ylim = c(-2,2))+
facet_wrap(.~decomp_day, labeller = labeller(decomp_day = c("1" = "Day 1", "3" = "Day 3","5" = "Day 5","7" = "Day 7","11" = "Day 11", "17" = "Day 17")))+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting

###########
h.od.day1.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "1", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="H",]))

h.od.day1.meta_lmer1=lmer(od_corrected_b_n ~ treatment + (1|deploy), subset = decomp_day == "1", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="H",]))

AIC(h.od.day1.meta_aov1,h.od.day1.meta_lmer1)

h.od.day3.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "3", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="H",]))
h.od.day5.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "5", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="H",]))
h.od.day7.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "7", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="H",]))
h.od.day11.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "11", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="H",]))
h.od.day17.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "17", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="H",]))

h.z.day1.meta_aov1=aov(z_score ~ treatment, subset = decomp_day == "1", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="H",]))
h.z.day3.meta_aov1=aov(z_score ~ treatment, subset = decomp_day == "3", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="H",]))
h.z.day5.meta_aov1=aov(z_score ~ treatment, subset = decomp_day == "5", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="H",]))
h.z.day7.meta_aov1=aov(z_score ~ treatment, subset = decomp_day == "7", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="H",]))
h.z.day11.meta_aov1=aov(z_score ~ treatment, subset = decomp_day == "11", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="H",]))
h.z.day17.meta_aov1=aov(z_score ~ treatment, subset = decomp_day == "17", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="H",]))


plot(h.od.day1.meta_aov1)
plot(h.z.day1.meta_aov1)
AIC(h.od.day3.meta_aov1,h.z.day3.meta_aov1 )

#model ouput
summary(h.od.day1.meta_aov1)
summary(h.od.day3.meta_aov1)
summary(h.od.day5.meta_aov1)
summary(h.od.day7.meta_aov1)
summary(h.od.day11.meta_aov1)
summary(h.od.day17.meta_aov1)

#across decomp day
meta.true_home.boxplot=merged.true_home_z.df%>%
  filter(group == "AW")%>%
  ggplot(aes(x = as.factor(decomp_day), y = od_corrected_b_n, fill = treatment)) +
  geom_boxplot(alpha= 0.5)+
    geom_point(position = position_jitter(width = 0.25), alpha = 0.7, aes(color = treatment))+
  xlab("decomposition day")+
  ggtitle("Metabolization of 'home' metabolites")+
    ylab(expression("optical density (OD"[450~nm]*")"))+
      scale_color_manual(values = c("#CC79A7", "#009E73")) +
    scale_fill_manual(values = c("#CC79A7", "#009E73")) +
    geom_hline(aes(yintercept = mean(od_corrected_b_n), linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting

ggsave("figures/meta.true_home.boxplot.pdf", meta.true_home.boxplot, width = 20, height = 8)


#across decomp day for H vs AW
merged.true_home_z.df%>%
  ggplot(aes(x = as.factor(decomp_day), y = od_corrected_b_n, fill = group)) +
  geom_boxplot(alpha= 0.5)+
    geom_point(position = position_jitter(width = 0.25), alpha = 0.7, aes(color = group))+
  xlab("decomposition day")+
  ggtitle("Metabolization between treatment")+
    ylab(expression("optical density (OD"[450~nm]*")"))+
      scale_color_colorblind()+
      scale_fill_colorblind()+
    geom_hline(aes(yintercept = mean(od_corrected_b_n), linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  facet_wrap(~treatment)+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting

meta.true_H.boxplot=merged.true_home_z.df%>%
  na.omit()%>%
  filter(group == "H")%>%
  ggplot(aes(x = as.factor(decomp_day), y = od_corrected_b_n, fill = treatment)) +
  geom_boxplot(alpha= 0.5)+
    geom_point(position = position_jitter(width = 0.25), alpha = 0.7, aes(color = treatment))+
  coord_cartesian(ylim = c(0.25,4.5))+
  xlab("decomposition day")+
  ggtitle("H metabolization")+
    ylab(expression("optical density (OD"[450~nm]*")"))+
      scale_color_manual(values = c("#CC79A7", "#009E73")) +
    scale_fill_manual(values = c("#CC79A7", "#009E73")) +
    geom_hline(aes(yintercept = mean(od_corrected_b_n), linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting

meta.true_AW.boxplot=merged.true_home_z.df%>%
  na.omit()%>%
  filter(group == "AW")%>%
  ggplot(aes(x = as.factor(decomp_day), y = od_corrected_b_n, fill = treatment)) +
  geom_boxplot(alpha= 0.5)+
    geom_point(position = position_jitter(width = 0.25), alpha = 0.7, aes(color = treatment))+
  coord_cartesian(ylim = c(0.25,4.5))+
  xlab("decomposition day")+
  ggtitle("AW metabolization")+
    ylab(expression("optical density (OD"[450~nm]*")"))+
      scale_color_manual(values = c("#CC79A7", "#009E73")) +
    scale_fill_manual(values = c("#CC79A7", "#009E73")) +
    geom_hline(aes(yintercept = mean(od_corrected_b_n), linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting

merged.true_home_z.df %>%
  na.omit() %>%
  filter(group == "AW") %>%
  summarise(mean_od = mean(od_corrected_b_n))
#1.3

merged.true_home_z.df %>%
  na.omit() %>%
  filter(group == "H") %>%
  summarise(mean_od = mean(od_corrected_b_n))


meta.H_AW.plot=plot_grid(meta.true_H.boxplot, meta.true_AW.boxplot, ncol=2, rel_widths = c(8,8))

ggsave("figures/meta.H_AW.plot.pdf", meta.H_AW.plot, width = 20, height = 8)




meta_line.plot=merged.true_home_z.df %>%
  filter(group=="H")%>%
  dplyr::group_by(group, treatment, decomp_day) %>%
  dplyr::summarise(mean_od = mean(od_corrected_b_n),
            sd_od = sd(od_corrected_b_n)) %>%
  ggplot(aes(x = as.factor(decomp_day), y = mean_od, color = treatment, group = treatment, linetype=treatment)) +
  geom_line(size=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin = mean_od - sd_od, ymax = mean_od + sd_od), width = 0.1) +
  xlab("decomposition day") +
  ggtitle('Metabolization of "home" metabolites') +
  ylab(expression("Optical density (OD"[450~nm]*")")) +
  scale_color_manual(values = c("#CC79A7", "#009E73")) +
      scale_x_discrete(expand = c(0.05,0.05))+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  ) +
  Fig.formatting

ggsave("figures/meta_line.plot.pdf", meta_line.plot, width = 20, height = 8)


#away
aw.od.day1.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "1", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="AW",]))
aw.od.day3.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "3", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="AW",]))
aw.od.day5.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "5", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="AW",]))
aw.od.day7.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "7", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="AW",]))
aw.od.day11.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "11", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="AW",]))
aw.od.day17.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "17", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$group=="AW",]))

#model ouput
summary(aw.od.day1.meta_aov1)
summary(aw.od.day3.meta_aov1)
summary(aw.od.day5.meta_aov1)
summary(aw.od.day7.meta_aov1)
summary(aw.od.day11.meta_aov1)
summary(aw.od.day17.meta_aov1)



meta.plot=plot_grid(true_meta.plot, false_meta.plot, ncol= 2, rel_widths = c(8,8))
ggsave("figures/meta.plot.pdf", meta.plot, width = 20, height = 8)


#holding hfa constant
meta_aov1=aov(od_corrected_b_n ~ treatment, subset = group == "H", data = na.omit(merged.true_home_z.df))
summary(meta_aov1)

mean(merged.true_home_z.df[merged.true_home_z.df$treatment == "AB" & merged.true_home_z.df$group =="H",]$od_corrected_b_n)
#1.395 P
#1.197

((1.395-1.197)/(1.395))*100

meta_aov3=aov(z_score ~ treatment, subset=decomp_day=="3" ,data = na.omit(merged.true_home_z.df))
plot(meta_aov3)
meta_aov5=aov(z_score ~ treatment, subset=decomp_day=="5" ,data = na.omit(merged.true_home_z.df))
meta_aov7=aov(z_score ~ treatment, subset=decomp_day=="7" ,data = na.omit(merged.true_home_z.df))




Anova(meta_aov1)
summary(meta_aov3)
summary(meta_aov5)
summary(meta_aov7)



#just H metabolization
meta.true_home.boxplot=merged.true_home_z.df%>%
    na.omit() %>%
  filter(group =="H")%>%
  ggplot(aes(x = treatment, y = z_score, fill = treatment)) +
  geom_boxplot(alpha= 0.5)+
      geom_point(position = position_jitter(width = 0.25), alpha = 0.4, aes(color = treatment))+
  xlab("treatment")+
  ggtitle("Overall H metabolization between treatment")+
    ylab(expression("standardized optical density (OD"[450~nm]*")"))+
      scale_color_manual(values = c("#CC79A7", "#009E73")) +
    scale_fill_manual(values = c("#CC79A7", "#009E73")) +
    geom_hline(aes(yintercept = 0, linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting

#overall metabolization between P vs AB boxplots
meta_all.plot=merged.true_home_z.df%>%
    na.omit() %>%
  ggplot(aes(x = treatment, y = z_score, fill = treatment)) +
  geom_boxplot(alpha= 0.5)+
      geom_point(position = position_jitter(width = 0.25), alpha = 0.4, aes(color = treatment))+
  scale_color_manual(values = c("#CC79A7", "#009E73")) +
    scale_fill_manual(values = c("#CC79A7", "#009E73")) +
  facet_wrap(~group)+
  xlab("treatment")+
  ggtitle("Overall metabolization between treatment")+
    ylab(expression("standardized optical density (OD"[450~nm]*")"))+
    geom_hline(aes(yintercept = 0, linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting


```

----- will likely delete below chunks----


up to date figs 3/1/24 for metabolism assay: treatment comparisons across decomp day for home and total
stats are below this chunk
```{r}
#### 3/1/24 updated figs (use these)

#metabolization of H  metabolites across decomp day
merged.true_home_z.df%>%
  na.omit()%>%
  filter(group == "H")%>%
  ggplot(aes(x = as.factor(decomp_day), y = od_corrected_b_n, fill = treatment)) +
  geom_boxplot(alpha= 0.5)+
    geom_point(position = position_jitter(width = 0.25), alpha = 0.7, aes(color = treatment))+  
  coord_cartesian(ylim = c(0.25,4.25))+
  xlab("decomposition day")+
  ggtitle("")+
    ylab(expression("optical density (OD"[450~nm]*")"))+
      scale_color_manual(values = c("#CC79A7", "#009E73")) +
    scale_fill_manual(values = c("#CC79A7", "#009E73")) +
      geom_hline(aes(yintercept = mean(od_corrected_b_n), linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting


merged.true_home_z.df <- merged.true_home_z.df %>%
  filter(group == "H") %>%
  group_by(treatment, tree_id, deploy, site_num, decomp_day) %>%
  mutate(lambda = boxcox(od_corrected_b_n ~ 1)$x[which.max(boxcox(od_corrected_b_n ~ 1)$y)],
         trans.od = ((od_corrected_b_n^lambda) - 1) / lambda)


#day 1
compare.day1 <- merged.true_home_z.df %>%
  filter(group == "H", decomp_day == "1")

t.test(trans.od ~ treatment, data = compare.day1)

#day 3
compare.day3 <- merged.true_home_z.df %>%
  filter(group == "H", decomp_day == "3")

t.test(trans.od ~ treatment, data = compare.day3)

#day 5
compare.day5 <- merged.true_home_z.df %>%
  filter(group == "H", decomp_day == "5")

t.test(trans.od ~ treatment, data = compare.day5)






```

----- will likely delete below chunks----


```{r}
ggsave("figures/true.aw_boxplot.pdf", true.aw_boxplot, width = 14, height = 7)
merged.true_home_z.df$treatment_centered <- scale(as.numeric(merged.true_home_z.df$treatment == "AB"), scale = FALSE)

non_additive_model <- lm(od_corrected_b_n ~ treatment, subset=decomp_day=="5" ,data = na.omit(merged.true_home_z.df)) 

intercept <- coef(non_additive_model)["(Intercept)"]
coef_P <- coef(non_additive_model)["treatmentP"]

# Print the intercept and coefficient for treatment "P"
print("Intercept:")
print(intercept)
print("Coefficient for Treatment P:")
print(coef_P)


# Calculate the predicted mean for treatment "P"
predicted_mean_P <- intercept + coef_P

# Calculate the actual mean for treatment "P" from your data
actual_mean_P <- mean(merged.true_home_z.df$od_corrected_b_n[merged.true_home_z.df$treatment == "P"])

actual_mean_AB <- mean(merged.true_home_z.df$od_corrected_b_n[merged.true_home_z.df$treatment == "AB"])

 



# Print the predicted and actual means for treatment "P"
print("Predicted Mean for Treatment P:")
print(predicted_mean_P)
print("Actual Mean for Treatment P:")
print(actual_mean_P)


# Actual mean metabolization values
#actual mean values of metabolization for the absent (AB) and present (P) treatments
actual_mean_AB <- 1.266259
actual_mean_P <- 1.350785

# Predicted mean metabolization for treatment "P"
#predicted mean metabolization for the present treatment (P) from the model
predicted_mean_P <- 2.422473

# Calculate the differences
#Calculate the difference between the predicted mean for treatment "P" and the sum of the actual mean for treatment "AB" and the difference between the actual mean for treatment "P" and the actual mean for treatment "AB". This step represents the difference between the predicted and observed metabolization for treatment "P" if the effects were additive.
diff_predicted_actual <- predicted_mean_P - (actual_mean_AB + (actual_mean_P - actual_mean_AB))


diff_actual <- actual_mean_P - actual_mean_AB

# Display the results
diff_predicted_actual
#This difference represents how much the predicted mean metabolization for treatment "P" differs from what was actually observed in your experiment. If this difference were close to 0, it would suggest that the effects of resident and aquatic microbes on metabolization are additive. However, since the difference is relatively large (1.0717), it indicates a non-additive effect.



diff_actual
#This difference represents the actual difference in mean metabolization between treatment "P" (both resident and aquatic microbes) and treatment "AB" (only aquatic microbes).A small difference here suggests that the presence of resident microbes has a relatively minor additional effect on metabolization compared to when only aquatic microbes are present.

true.h_boxplot<- merged.true_home_z.df%>%
  na.omit()%>%
  filter(group == "H")%>%
  ggplot(aes(x = as.factor(decomp_day), y = od_corrected_b_n, fill = treatment)) +
  geom_boxplot(alpha= 0.5, outlier.shape = NA)+
    geom_point(position = position_dodge(width = 0.75), alpha = 0.8, aes(color = treatment))+
    coord_cartesian(ylim = c(0.25,4.25))+
  xlab("decomposition day")+
  ggtitle("")+
    ylab(expression("optical density (OD"[450~nm]*")"))+
      scale_color_manual(values = c("#CC79A7", "#009E73" ), labels = c("absent", "present")) +
    scale_fill_manual(values = c("#CC79A7", "#009E73" ), labels = c("absent", "present")) +
      geom_hline(aes(yintercept = mean(od_corrected_b_n), linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
    theme_bw()+
  theme(
    axis.text = element_text(size = 18),
    axis.title = element_text(size = 16),
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 16),
    strip.text = element_text(size = 16)
  )


true.h_boxplot

ggsave("figures/true.h_boxplot.pdf", true.h_boxplot, width = 14, height = 7)

  stat_summary(fun = "mean", geom = "point", aes(shape = treatment), size = 3, position = position_dodge(width = 0.75), color = "purple") 

  
#true home using transformed
true.h.trans_boxplot<- merged.true_home_z.df%>%
  na.omit()%>%
  filter(group == "H")%>%
  ggplot(aes(x = as.factor(decomp_day), y = trans.od, fill = treatment)) +
  geom_boxplot(alpha= 0.5)+
    geom_point(position = position_dodge(width = 0.75), alpha = 0.8, aes(color = treatment))+
  xlab("decomposition day")+
  ggtitle("")+
    ylab(expression("log optical density (OD"[450~nm]*")"))+
      scale_color_manual(values = c("#CC79A7", "#009E73")) +
    scale_fill_manual(values = c("#CC79A7", "#009E73")) +
      geom_hline(aes(yintercept = mean(trans.od), linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
theme_bw()+
  theme(
    axis.text = element_text(size = 18),
    axis.title = element_text(size = 16),
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 16),
    strip.text = element_text(size = 16)
  )

ggsave("figures/true.h.trans_boxplot.pdf", true.h.trans_boxplot, width = 14, height = 7)

#stats for h vs away metabolization across decomp day
aov1_h.meta=aov(z_score ~ treatment, data = merged.true_home_z.df, subset = group == "H" & decomp_day == "5" )

aov1_h.meta=aov(z_score ~ treatment, data = merged.true_home_z.df, subset = group == "H" & decomp_day == "3" )

summary(aov1_h.meta)

View(merged.true_home_z.df)

merged.true_home_z.df%>%
  na.omit()%>%
  filter(group == "H" &  decomp_day == "3"  & treatment == "AB")%>%
  summarise(mean(od_corrected_b_n))

#P: day 1 = 1.112, day 3 = 1.344, day 5 = 2.489
#AB: day 1 = 1.406, day 3 = 1.097, day 5 = 1.659

1.112+1.344/2
1.406+1.097/2


#P: 3.286
#AB: 3.056


#treatment comparison of home metabolization total
merged.true_home_z.df%>%
  na.omit()%>%
  filter(group == "H")%>%
  ggplot(aes(x = treatment, y = z_score, fill = treatment)) +
  geom_boxplot(alpha= 0.5)+
    geom_point(position = position_jitter(width = 0.75), alpha = 0.4, aes(color = treatment))+
  xlab("decomposition day")+
  ggtitle("")+
    ylab(expression("optical density (OD"[450~nm]*")"))+
      scale_color_manual(values = c("#CC79A7", "#009E73"), labels = c("present", "absent")) +
    scale_fill_manual(values = c("#CC79A7", "#009E73"), labels = c("present", "absent")) +
      geom_hline(aes(yintercept = 0, linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting

#metabolization across decomp day holding HFA constant
merged.true_home_z.df%>%
  na.omit()%>%
  ggplot(aes(x = as.factor(decomp_day), y = od_corrected_b_n, fill = treatment)) +
  geom_boxplot(alpha= 0.5)+
    geom_point(position = position_jitter(width = 0.25), alpha = 0.7, aes(color = treatment))+
  xlab("decomposition day")+
  ggtitle("")+
    ylab(expression("optical density (OD"[450~nm]*")"))+
      scale_color_manual(values = c("#CC79A7", "#009E73")) +
    scale_fill_manual(values = c("#CC79A7", "#009E73")) +
        geom_hline(aes(yintercept = mean(od_corrected_b_n), linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting


#treatment comparison of total metabolization holding HFA constant
merged.true_home_z.df%>%
  na.omit()%>%
  ggplot(aes(x = treatment, y = z_score, fill = treatment)) +
  geom_boxplot(alpha= 0.5)+
    geom_point(position = position_jitter(width = 0.25), alpha = 0.7, aes(color = treatment))+
  xlab("decomposition day")+
  ggtitle("")+
    ylab(expression("optical density (OD"[450~nm]*")"))+
      scale_color_manual(values = c("#CC79A7", "#009E73")) +
    scale_fill_manual(values = c("#CC79A7", "#009E73")) +
      geom_hline(aes(yintercept = 0, linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting

total.meta= lmer(z_score ~ treatment + (1|tree_id), data= merged.true_home_z.df)
summary(total.meta)


```

----- will likely delete below chunks----


These are stats for the above figures. Each are separated in a similar fashion

```{r}
aw.meta.true_home.boxplot=merged.true_home_z.df%>%
    na.omit() %>%
  filter(group == "AW")%>%
  ggplot(aes(x = as.factor(decomp_day), y = z_score, fill = treatment)) +
  geom_boxplot(alpha= 0.5)+
  xlab("decomposition day")+
  ggtitle("Differences between treatment for AW metabolites")+
    ylab(expression("standardized optical density (OD"[450~nm]*")"))+
    scale_fill_manual(values = c("#CC79A7", "#009E73")) +
    geom_hline(aes(yintercept = 0, linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
coord_cartesian(ylim = c(-2,2))+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting




meta_boxplot=plot_grid(p.meta.true_home.boxplot,ab.meta.true_home.boxplot ,meta.true_home.boxplot)

ggsave("figures/meta_boxplot.pdf", meta_boxplot, width = 14, height = 7)





merged.true_home_z.df%>%
    na.omit() %>%
  filter(group == "H")%>%
  ggplot(aes(x = treatment, y = od_corrected_b_n, fill = treatment, group = treatment)) +
  geom_boxplot(alpha= 0.5)+
  xlab("group")+
  ggtitle("Home group only")+
    ylab(expression("standardized optical density (OD"[450~nm]*")"))+
    scale_fill_manual(values = c("#CC79A7", "#009E73")) +
    geom_hline(aes(yintercept = 0, linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
coord_cartesian(ylim = c(-2,2))+
facet_wrap(.~decomp_day, labeller = labeller(decomp_day = c("1" = "Day 1", "3" = "Day 3","5" = "Day 5","7" = "Day 7","11" = "Day 11", "17" = "Day 17")))+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting


#overall metaboliztion of home between treatments
z_overall.meta.trt_aov=aov(z_score ~ treatment, data = na.omit(merged.true_home_z.df))

od_overall.meta.trt_aov=aov(od_corrected_b_n ~ treatment, data = na.omit(merged.true_home_z.df))

z_overall.meta.trt_lmer=lmer(z_score ~ treatment + (1|group) + (1 | decomp_day) + (1|tree_id) + (1 | tree_num), data = na.omit(merged.true_home_z.df))

od_overall.meta.trt_lmer=lmer(od_corrected_b_n ~ treatment + (1|group) + (1 | decomp_day) + (1|tree_id) + (1 | tree_num), data = na.omit(merged.true_home_z.df))

AIC(z_overall.meta.trt_aov,od_overall.meta.trt_aov,z_overall.meta.trt_lmer,od_overall.meta.trt_lmer)

#comparing the means
mean(merged.true_home_z.df[merged.true_home_z.df$group=="H" & merged.true_home_z.df$treatment == "P",]$od_corrected_b_n)

mean(merged.true_home_z.df[merged.true_home_z.df$group=="H" & merged.true_home_z.df$treatment == "AB",]$od_corrected_b_n)

#percent difference
((1.395-1.197)/(1.395)*100)

plot(resid(od_overall.meta.trt_lmer))
summary(od_overall.meta.trt_lmer)
anova(od_overall.meta.trt_lmer)
#home only to pair with HFA index over decomp days
home_meta.trt.plot=merged.true_home_z.df%>%
    na.omit() %>%
  filter(group == "H")%>%
  ggplot(aes(x = treatment, y = z_score, fill = treatment, group = treatment)) +
  geom_boxplot(alpha= 0.5, width = 0.6)+
  geom_point(position = position_jitter(width = 0.2), alpha = 0.7, aes(color = treatment))+
  xlab("treatment")+
  ggtitle("Metabolization of 'home' metabolites")+
    ylab(expression("standardized optical density (OD"[450~nm]*")"))+
    scale_fill_manual(values = c("#CC79A7", "#009E73")) +
      scale_color_manual(values = c("#CC79A7", "#009E73")) +
    geom_hline(aes(yintercept = mean(z_score)), color = alpha("red", 1), linetype = "dashed") +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting

ggsave("figures/home_meta.trt.plot.pdf", home_meta.trt.plot, width = 14, height = 7)


###### absent boxplot
#based on the above model comparisons (lower AIC), we will use anova with response: z score
day1.ab.meta_aov1=aov(z_score ~ group, subset = decomp_day == "1", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="AB",]))
day3.ab.meta_aov1=aov(z_score ~ group, subset = decomp_day == "3", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="AB",]))
day5.ab.meta_aov1=aov(z_score ~ group, subset = decomp_day == "5", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="AB",]))
day7.ab.meta_aov1=aov(z_score ~ group, subset = decomp_day == "7", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="AB",]))
day11.ab.meta_aov1=aov(z_score ~ group, subset = decomp_day == "11", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="AB",]))
day17.ab.meta_aov1=aov(z_score ~ group, subset = decomp_day == "17", data = na.omit(merged.true_home_z.df[merged.true_home_z.df$treatment=="AB",]))

#model ouput
summary(day1.ab.meta_aov1)
summary(day3.ab.meta_aov1)
summary(day5.ab.meta_aov1)
summary(day7.ab.meta_aov1)
summary(day11.ab.meta_aov1)
summary(day17.ab.meta_aov1)

#plot
ab.meta.true_home.boxplot=merged.true_home_z.df%>%
    na.omit() %>%
  filter(treatment == "AB")%>%
  ggplot(aes(x = group, y = z_score, fill = group, group = group)) +
  geom_boxplot(alpha= 0.5)+
  xlab("group")+
    ggtitle("Absent treatment only")+
    ylab(expression("standardized optical density (OD"[450~nm]*")"))+
  scale_fill_colorblind()+
    geom_hline(aes(yintercept = 0, linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  facet_wrap(.~decomp_day, labeller = labeller(decomp_day = c("1" = "Day 1", "3" = "Day 3","5" = "Day 5","7" = "Day 7","11" = "Day 11", "17" = "Day 17")))+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting

ab.meta.true_home.boxplot



#groups h vs vs only boxplots
#day 1
p_day1.grps.meta_aov1=aov(z_score ~ group, subset = decomp_day == "1" & treatment == "P", data = na.omit(merged.true_home_z.df))
ab_day1.grps.meta_aov1=aov(z_score ~ group, subset = decomp_day == "1" & treatment == "AB", data = na.omit(merged.true_home_z.df))

summary(ab_day1.grps.meta_aov1)
summary(p_day1.grps.meta_aov1)

#day 3
p_day3.grps.meta_aov1=aov(z_score ~ group, subset = decomp_day == "3" & treatment == "P", data = na.omit(merged.true_home_z.df))
ab_day3.grps.meta_aov1=aov(z_score ~ group, subset = decomp_day == "3" & treatment == "AB", data = na.omit(merged.true_home_z.df))

summary(ab_day3.grps.meta_aov1)
summary(p_day3.grps.meta_aov1)

#day 5
p_day5.grps.meta_aov1=aov(z_score ~ group, subset = decomp_day == "5" & treatment == "P", data = na.omit(merged.true_home_z.df))
ab_day5.grps.meta_aov1=aov(z_score ~ group, subset = decomp_day == "5" & treatment == "AB", data = na.omit(merged.true_home_z.df))

summary(ab_day5.grps.meta_aov1)
summary(p_day5.grps.meta_aov1)

#day 7
p_day7.grps.meta_aov1=aov(z_score ~ group, subset = decomp_day == "7" & treatment == "P", data = na.omit(merged.true_home_z.df))
ab_day7.grps.meta_aov1=aov(z_score ~ group, subset = decomp_day == "7" & treatment == "AB", data = na.omit(merged.true_home_z.df))

summary(ab_day7.grps.meta_aov1)
summary(p_day7.grps.meta_aov1)

#day 11
p_day11.grps.meta_aov1=aov(z_score ~ group, subset = decomp_day == "11" & treatment == "P", data = na.omit(merged.true_home_z.df))
ab_day11.grps.meta_aov1=aov(z_score ~ group, subset = decomp_day == "11" & treatment == "AB", data = na.omit(merged.true_home_z.df))

summary(ab_day11.grps.meta_aov1)
summary(p_day11.grps.meta_aov1)

#day 17
p_day17.grps.meta_aov1=aov(z_score ~ group, subset = decomp_day == "17" & treatment == "P", data = na.omit(merged.true_home_z.df))
ab_day17.grps.meta_aov1=aov(z_score ~ group, subset = decomp_day == "17" & treatment == "AB", data = na.omit(merged.true_home_z.df))

summary(ab_day17.grps.meta_aov1)
summary(p_day17.grps.meta_aov1)



#just h vs aw boxplots
aw.h.trt_boxplot=merged.true_home_z.df%>%
    na.omit() %>%
  ggplot(aes(x = group, y = z_score, fill = group, group = group)) +
  geom_boxplot(alpha= 0.5)+
  xlab("group")+
    ggtitle("PSM metabolization between groups H vs. AW")+
    ylab(expression("standardized optical density (OD"[450~nm]*")"))+
  scale_fill_colorblind()+
    geom_hline(aes(yintercept = 0, linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  facet_grid(treatment~decomp_day , labeller = labeller(decomp_day = c("1" = "Day 1", "3" = "Day 3","5" = "Day 5","7" = "Day 7","11" = "Day 11", "17" = "Day 17")))+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting

##################### Looking just at treatment differences

#anova models: treatment P vs AB only boxplots
z_day1.meta_aov1=aov(z_score ~ treatment, subset = decomp_day == "1", data = na.omit(merged.true_home_z.df))
z_day3.meta_aov1=aov(z_score ~ treatment, subset = decomp_day == "3", data = na.omit(merged.true_home_z.df))
z_day5.meta_aov1=aov(z_score ~ treatment, subset = decomp_day == "5", data = na.omit(merged.true_home_z.df))
z_day7.meta_aov1=aov(z_score ~ treatment, subset = decomp_day == "7", data = na.omit(merged.true_home_z.df))
z_day11.meta_aov1=aov(z_score ~ treatment, subset = decomp_day == "11", data = na.omit(merged.true_home_z.df))
z_day17.meta_aov1=aov(z_score ~ treatment, subset = decomp_day == "17", data = na.omit(merged.true_home_z.df))

#aov model ouput
summary(day1.meta_aov1)
summary(day3.meta_aov1)
summary(day5.meta_aov1)
summary(day7.meta_aov1)
summary(day11.meta_aov1)
summary(day17.meta_aov1)

#anova using od corrected
od_day1.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "1", data = na.omit(merged.true_home_z.df))
od_day3.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "3", data = na.omit(merged.true_home_z.df))
od_day5.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "5", data = na.omit(merged.true_home_z.df))
od_day7.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "7", data = na.omit(merged.true_home_z.df))
od_day11.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "11", data = na.omit(merged.true_home_z.df))
od_day17.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "17", data = na.omit(merged.true_home_z.df))

#z score vs od model comparison
AIC(z_day1.meta_aov1,z_day3.meta_aov1,z_day5.meta_aov1,z_day7.meta_aov1,z_day11.meta_aov1,z_day17.meta_aov1,od_day1.meta_aov1,od_day3.meta_aov1,od_day5.meta_aov1,od_day7.meta_aov1,od_day11.meta_aov1,od_day17.meta_aov1)

### od corrected wins over z score

#anova model output for od corrected
summary(od_day1.meta_aov1)
summary(od_day3.meta_aov1)
summary(od_day5.meta_aov1)
summary(od_day7.meta_aov1)
summary(od_day11.meta_aov1)
summary(od_day17.meta_aov1)


#lmer models using z score
z_day1.meta_lmer1=lmer(z_score ~ treatment + (1 | tree_id) + (1| tree_num), subset = decomp_day == "1", data = na.omit(merged.true_home_z.df))
z_day3.meta_lmer1=lmer(z_score ~ treatment + (1 | tree_id) + (1| tree_num), subset = decomp_day == "3", data = na.omit(merged.true_home_z.df))
z_day5.meta_lmer1=lmer(z_score ~ treatment + (1 | tree_id) + (1| tree_num), subset = decomp_day == "5", data = na.omit(merged.true_home_z.df))
z_day7.meta_lmer1=lmer(z_score ~ treatment + (1 | tree_id) + (1| tree_num), subset = decomp_day == "7", data = na.omit(merged.true_home_z.df))
z_day11.meta_lmer1=lmer(z_score ~ treatment + (1 | tree_id) + (1| tree_num), subset = decomp_day == "11", data = na.omit(merged.true_home_z.df))
z_day17.meta_lmer1=lmer(z_score ~ treatment + (1 | tree_id) + (1| tree_num), subset = decomp_day == "17", data = na.omit(merged.true_home_z.df))

#lmer models using od corrected
od_day1.meta_lmer1=lmer(od_corrected_b_n ~ treatment + (1 | tree_id) + (1| tree_num), subset = decomp_day == "1", data = na.omit(merged.true_home_z.df))
od_day3.meta_lmer1=lmer(od_corrected_b_n ~ treatment + (1 | tree_id) + (1| tree_num), subset = decomp_day == "3", data = na.omit(merged.true_home_z.df))
od_day5.meta_lmer1=lmer(od_corrected_b_n ~ treatment + (1 | tree_id) + (1| tree_num), subset = decomp_day == "5", data = na.omit(merged.true_home_z.df))
od_day7.meta_lmer1=lmer(od_corrected_b_n ~ treatment + (1 | tree_id) + (1| tree_num), subset = decomp_day == "7", data = na.omit(merged.true_home_z.df))
od_day11.meta_lmer1=lmer(od_corrected_b_n ~ treatment + (1 | tree_id) + (1| tree_num), subset = decomp_day == "11", data = na.omit(merged.true_home_z.df))
od_day17.meta_lmer1=lmer(od_corrected_b_n ~ treatment + (1 | tree_id) + (1| tree_num), subset = decomp_day == "17", data = na.omit(merged.true_home_z.df))

#z score vs od model comparison
AIC(z_day1.meta_lmer1,z_day3.meta_lmer1,z_day5.meta_lmer1,z_day7.meta_lmer1,z_day11.meta_lmer1,z_day17.meta_lmer1,od_day1.meta_lmer1,od_day3.meta_lmer1,od_day5.meta_lmer1,od_day7.meta_lmer1,od_day11.meta_lmer1,od_day17.meta_lmer1)

### od wins again

#anova vs lmer comparison
AIC(od_day1.meta_aov1,od_day3.meta_aov1,od_day5.meta_aov1,od_day7.meta_aov1,od_day11.meta_aov1,od_day17.meta_aov1,
  
od_day1.meta_lmer1,od_day3.meta_lmer1,od_day5.meta_lmer1,od_day7.meta_lmer1,od_day11.meta_lmer1,od_day17.meta_lmer1)


############ anova with od corrected wins it all

# showing the models again
od_day1.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "1", data = na.omit(merged.true_home_z.df))
od_day3.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "3", data = na.omit(merged.true_home_z.df))
od_day5.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "5", data = na.omit(merged.true_home_z.df))
od_day7.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "7", data = na.omit(merged.true_home_z.df))
od_day11.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "11", data = na.omit(merged.true_home_z.df))
od_day17.meta_aov1=aov(od_corrected_b_n ~ treatment, subset = decomp_day == "17", data = na.omit(merged.true_home_z.df))

# model outputs with model checks
summary(od_day1.meta_aov1)
plot(resid(od_day1.meta_aov1))
# F(1,78) = 4.79, p = 0.03

#looking at the mean OD
mean(merged.true_home_z.df[merged.true_home_z.df$decomp_day == "1" & merged.true_home_z.df$treatment == "P",]$od_corrected_b_n)
  #1.13

mean(merged.true_home_z.df[merged.true_home_z.df$decomp_day == "1" & merged.true_home_z.df$treatment == "AB",]$od_corrected_b_n)
  #1.33

mean(merged.true_home_z.df[merged.true_home_z.df$group=="H" & merged.true_home_z.df$treatment == "AB",]$od_corrected_b_n)

summary(od_day3.meta_aov1)
plot(resid(od_day3.meta_aov1))
#NS

summary(od_day5.meta_aov1)
plot(resid(od_day5.meta_aov1))
# F(1,78) = 8.23, p = 0.005

#looking at the mean OD
mean(merged.true_home_z.df[merged.true_home_z.df$decomp_day == "5" & merged.true_home_z.df$treatment == "P",]$od_corrected_b_n)
  #2.42

mean(merged.true_home_z.df[merged.true_home_z.df$decomp_day == "5" & merged.true_home_z.df$treatment == "AB",]$od_corrected_b_n)
  #1.91

((2.42-1.91)/(2.42)*100)

summary(od_day7.meta_aov1)
plot(resid(od_day7.meta_aov1))
#NS

summary(od_day11.meta_aov1)
plot(resid(od_day11.meta_aov1))
#NS

summary(od_day17.meta_aov1)
plot(resid(od_day17.meta_aov1))
#NS

#plot
trt.only_boxplot=merged.true_home_z.df%>%
    na.omit() %>%
  ggplot(aes(x = treatment, y = z_score, fill = treatment, group = treatment)) +
  geom_boxplot(alpha= 0.5)+
  xlab("treatment")+
  ggtitle("PSM metabolization between treatments P vs. AB")+
    ylab(expression("standardized optical density (OD"[450~nm]*")"))+
  scale_fill_manual(values = c("#CC79A7", "#009E73")) +
    geom_hline(aes(yintercept = 0, linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
facet_wrap(.~decomp_day, nrow = 2, labeller = labeller(decomp_day = c("1" = "Day 1", "3" = "Day 3","5" = "Day 5","7" = "Day 7","11" = "Day 11", "17" = "Day 17")))+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )+
  Fig.formatting

#merge P vs AB and H vs AW plots
meta_box.plot=
  plot_grid(
 aw.h.trt_boxplot,
   trt.only_boxplot,
  rel_widths = c(8,8),
  nrow=2
)
meta_box.plot

ggsave("figures/meta_box.plot.pdf", meta_box.plot, width = 16, height = 18)


```

----- will likely delete below chunks----

old version??
```{r}

#z score
##### Day 1
#HOK 1 subset
d1_hok1.df <- data.frame(meta.450.df[meta.450.df$deploy == "HOK" & meta.450.df$site_num == "1" & meta.450.df$decomp_day == "1", ])
d3_hok1.df <- data.frame(meta.450.df[meta.450.df$deploy == "HOK" & meta.450.df$site_num == "1" & meta.450.df$decomp_day == "3", ])
d5_hok1.df <- data.frame(meta.450.df[meta.450.df$deploy == "HOK" & meta.450.df$site_num == "1" & meta.450.df$decomp_day == "5", ])
d7_hok1.df <- data.frame(meta.450.df[meta.450.df$deploy == "HOK" & meta.450.df$site_num == "1" & meta.450.df$decomp_day == "7", ])
d11_hok1.df <- data.frame(meta.450.df[meta.450.df$deploy == "HOK" & meta.450.df$site_num == "1" & meta.450.df$decomp_day == "11", ])
d17_hok1.df <- data.frame(meta.450.df[meta.450.df$deploy == "HOK" & meta.450.df$site_num == "1" & meta.450.df$decomp_day == "17", ])
# Calculate z-scores 
d1_hok1.df=d1_hok1.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d3_hok1.df=d3_hok1.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d5_hok1.df=d5_hok1.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d7_hok1.df=d7_hok1.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d11_hok1.df=d11_hok1.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d17_hok1.df=d17_hok1.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))


#HOK 2 subset
d1_hok2.df <- data.frame(meta.450.df[meta.450.df$deploy == "HOK" & meta.450.df$site_num == "2" & meta.450.df$decomp_day == "1", ])
d3_hok2.df <- data.frame(meta.450.df[meta.450.df$deploy == "HOK" & meta.450.df$site_num == "2" & meta.450.df$decomp_day == "3", ])
d5_hok2.df <- data.frame(meta.450.df[meta.450.df$deploy == "HOK" & meta.450.df$site_num == "2" & meta.450.df$decomp_day == "5", ])
d7_hok2.df <- data.frame(meta.450.df[meta.450.df$deploy == "HOK" & meta.450.df$site_num == "2" & meta.450.df$decomp_day == "7", ])
d11_hok2.df <- data.frame(meta.450.df[meta.450.df$deploy == "HOK" & meta.450.df$site_num == "2" & meta.450.df$decomp_day == "11", ])
d17_hok2.df <- data.frame(meta.450.df[meta.450.df$deploy == "HOK" & meta.450.df$site_num == "2" & meta.450.df$decomp_day == "17", ])
# Calculate z-scores 
d1_hok2.df=d1_hok2.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d3_hok2.df=d3_hok2.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d5_hok2.df=d5_hok2.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d7_hok2.df=d7_hok2.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d11_hok2.df=d11_hok2.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d17_hok2.df=d17_hok2.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))

#merge all hok
all.hok.df=rbind(d1_hok1.df,
                           d3_hok1.df,
                           d5_hok1.df,
                           d7_hok1.df,
                           d11_hok1.df,
                           d17_hok1.df,
                           
                          d1_hok2.df,
                           d3_hok2.df,
                           d5_hok2.df,
                           d7_hok2.df,
                           d11_hok2.df,
                           d17_hok2.df)

#SEK 1 subset
d1_sek1.df <- data.frame(meta.450.df[meta.450.df$deploy == "SEK" & meta.450.df$site_num == "1" & meta.450.df$decomp_day == "1", ])
d3_sek1.df <- data.frame(meta.450.df[meta.450.df$deploy == "SEK" & meta.450.df$site_num == "1" & meta.450.df$decomp_day == "3", ])
d5_sek1.df <- data.frame(meta.450.df[meta.450.df$deploy == "SEK" & meta.450.df$site_num == "1" & meta.450.df$decomp_day == "5", ])
d7_sek1.df <- data.frame(meta.450.df[meta.450.df$deploy == "SEK" & meta.450.df$site_num == "1" & meta.450.df$decomp_day == "7", ])
d11_sek1.df <- data.frame(meta.450.df[meta.450.df$deploy == "SEK" & meta.450.df$site_num == "1" & meta.450.df$decomp_day == "11", ])
d17_sek1.df <- data.frame(meta.450.df[meta.450.df$deploy == "SEK" & meta.450.df$site_num == "1" & meta.450.df$decomp_day == "17", ])
# Calculate z-scores 
d1_sek1.df=d1_sek1.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d3_sek1.df=d3_sek1.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d5_sek1.df=d5_sek1.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d7_sek1.df=d7_sek1.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d11_sek1.df=d11_sek1.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d17_sek1.df=d17_sek1.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))


#SEK 2 subset
d1_sek2.df <- data.frame(meta.450.df[meta.450.df$deploy == "SEK" & meta.450.df$site_num == "2" & meta.450.df$decomp_day == "1", ])
d3_sek2.df <- data.frame(meta.450.df[meta.450.df$deploy == "SEK" & meta.450.df$site_num == "2" & meta.450.df$decomp_day == "3", ])
d5_sek2.df <- data.frame(meta.450.df[meta.450.df$deploy == "SEK" & meta.450.df$site_num == "2" & meta.450.df$decomp_day == "5", ])
d7_sek2.df <- data.frame(meta.450.df[meta.450.df$deploy == "SEK" & meta.450.df$site_num == "2" & meta.450.df$decomp_day == "7", ])
d11_sek2.df <- data.frame(meta.450.df[meta.450.df$deploy == "SEK" & meta.450.df$site_num == "2" & meta.450.df$decomp_day == "11", ])
d17_sek2.df <- data.frame(meta.450.df[meta.450.df$deploy == "SEK" & meta.450.df$site_num == "2" & meta.450.df$decomp_day == "17", ])
# Calculate z-scores 
d1_sek2.df=d1_sek2.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d3_sek2.df=d3_sek2.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d5_sek2.df=d5_sek2.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d7_sek2.df=d7_sek2.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d11_sek2.df=d11_sek2.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))
d17_sek2.df=d17_sek2.df%>%
  na.omit()%>%
  mutate(z_score= (od_corrected_b_n - mean(od_corrected_b_n))/sd(od_corrected_b_n))


#merge all hok
all.sek.df=rbind(d1_sek1.df,
                           d3_sek1.df,
                           d5_sek1.df,
                           d7_sek1.df,
                           d11_sek1.df,
                           d17_sek1.df,
                           
                          d1_sek2.df,
                           d3_sek2.df,
                           d5_sek2.df,
                           d7_sek2.df,
                           d11_sek2.df,
                           d17_sek2.df)

#merge z scored dfs
merged_z.df = rbind(all.hok.df, all.sek.df)

 


#all combinations with meta.df
means_per_day <- meta.450.df %>%
  group_by(decomp_day) %>%
  summarise(mean_od = mean(od_corrected_b_n, na.rm = TRUE))

meta.450.df%>%
  na.omit()%>%
  ggplot(aes(x= treatment, y = od_corrected_b_n, color = group))+
  geom_boxplot()+
  facet_wrap(.~decomp_day)+
  scale_color_colorblind()+
  geom_hline(data= means_per_day, aes(yintercept = mean_od, linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  theme_classic()

d1_all.meta_aov=aov(od_corrected_b_n~new.trt*group, subset = decomp_day == "1", data = na.omit(meta.450.df))

d1_all.meta_lmer=lmer(od_corrected_b_n~new.trt*group + (1|deploy) + (1|site_num) + (1| tree_num) + (1 | tree_id), subset = decomp_day == "1", data = na.omit(meta.450.df))

d3_all.meta_lmer=lmer(od_corrected_b_n~new.trt*group + (1|deploy) + (1|site_num) + (1| tree_num) + (1 | tree_id), subset = decomp_day == "3", data = na.omit(meta.450.df))


plot(resid(d1_all.meta_lmer))
summary(d3_all.meta_lmer)

AIC(d3_all.meta_aov, d3_all.meta_lmer)

d3_all.meta_aov=aov(od_corrected_b_n~new.trt*group, subset = decomp_day == "3", data = na.omit(meta.450.df))
TukeyHSD(d3_all.meta_aov)
summary(d3_all.meta_aov)

hist(resid(d3_all.meta_aov))
plot(resid(d3_all.meta_aov))
# z score
means_per_day <- merged_z.df %>%
  group_by(decomp_day) %>%
  summarise(mean_z = mean(z_score, na.rm = TRUE))


merged_z.df%>%
  na.omit()%>%
  filter(hours =="24")%>%
  ggplot(aes(x= new.trt, y = z_score, color = group))+
  geom_boxplot()+
  facet_wrap(.~decomp_day)+
  scale_color_colorblind()+
           geom_hline(data= means_per_day, aes(yintercept = mean_z, linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  theme_classic()

d1_all.meta_z_aov=aov(z_score~new.trt*group, subset = decomp_day == "1", data = na.omit(merged_z.df))

d3_all.meta_z_aov=aov(z_score~new.trt*group, subset = decomp_day == "3", data = na.omit(merged_z.df))
hist(resid(d3_all.meta_z_aov))

plot(resid(d3_all.meta_z_aov))

summary(all.meta_z_aov)

AIC(d3_all.meta_aov, d3_all.meta_z_aov)

plot(resid(all.meta_z_aov))
plot(all.meta_aov)


```




------------------- % mass loss data -------------------------------

Load mass data 
```{r}
#load mass data
mass.df=read.csv("/Users/cjspiegel/Desktop/GitHub/rad_alder2.0/data/leaf_mass.csv")
#check for any white spaces and clean up
columns_with_whitespace <- map_lgl(mass.df, ~ any(str_detect(.x, "^\\s+|\\s+$")))
columns_with_whitespace

#correction factor adjusting for blotted and fresh dry mass
mass.df= mass.df%>%
  mutate(final_correct = (0.941*(final_mass)-0.00337))

# calculate % mass loss 
mass.df <- mass.df %>%
  mutate(perc.mass_loss = ((initial_mass - final_correct) / initial_mass)*100)

#check distribution/normality
mass.df%>%
  pull(perc.mass_loss)%>%
  hist()

mass.df%>%
  pull(perc.mass_loss)%>%
  normalTest(method = "da")

#look at range of mass loss
mass.df%>%
  pull(perc.mass_loss)%>%
  range()

#even with the mass correction there are negative values, so we can shift the range of the data while maintaining the overall distribution using a constant 
c <- abs(min(mass.df$perc.mass_loss)) + 1  
#replace with shifted values
mass.df <- mass.df %>%
  mutate(perc.mass_loss = perc.mass_loss + c)

#apply transformation
mass.df%>%
  mutate(mass_trans = log(perc.mass_loss))

#look at range and normality again
mass.df%>%
  pull(perc.mass_loss)%>%
  normalTest(method = "da")

#look at range of mass loss
mass.df%>%
  pull(perc.mass_loss)%>%
  range()

#apply logit and arcsine transformation
mass.df<- mass.df%>%
  mutate(prop.mass_loss = perc.mass_loss / 100)%>%
  mutate(logit_trans = log(prop.mass_loss / (1 - prop.mass_loss)))%>%
  mutate(arc_trans = asin(sqrt(prop.mass_loss)))

# Find the optimal lambda for Box-Cox transformation
# Using a simple model with an intercept to find the lambda
boxcox_result <- boxcox(lm(prop.mass_loss ~ 1, data = mass.df))
lambda <- boxcox_result$x[which.max(boxcox_result$y)]

# Apply the Box-Cox transformation
mass.df <- mass.df %>%
  group_by(treatment, tree_id, deploy, site_num, tree_num, hfa)%>%
  mutate(box_trans = ifelse(lambda == 0, log(prop.mass_loss), (prop.mass_loss^lambda - 1) / lambda))

#check normality
mass.df%>%
  pull(box_trans)%>%
  normalTest(method = "da")

mass.df%>%
  filter(treatment == "P" & hfa == "H")%>%
  pull(box_trans)%>%
  normalTest(method = "da")

#back-transformation
(lambda * box_trans + 1)^(1/lambda)


#subset P treatment only for "true" HFA  
mass.present.df=mass.df %>%
  filter(treatment == "P")

#subset AB treatment only for HFA  
mass.absent.df=mass.df %>%
  filter(treatment == "AB")


```

quick data visualization
```{r}
mass.df%>%
  filter(hfa == "H")%>%
  ggplot(aes(treatment, box_trans, color = treatment))+
  stat_summary(fun = mean, geom = "point", size = 6, position = position_dodge(width = 0.5)) +
   stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.4, position = position_dodge(width = 0.5), size = 1.2) +
  scale_color_viridis_d()

```


Incorporating stats lecture notes
```{r}
hist(mass.df[mass.df$treatment=="P",]$perc.mass_loss)
hist(mass.df[mass.df$treatment=="AB",]$perc.mass_loss)

p.group<- mass.df[mass.df$treatment=="P",]$perc.mass_loss
ab.group<- mass.df[mass.df$treatment=="AB",]$perc.mass_loss

groups<-c(p.group,ab.group)

hist(groups)
abline(v=median(p.group),col="lightgreen",lwd=2)
abline(v=median(ab.group),col="darkolivegreen",lwd=2)
deltamed<-median(p.group)-median(ab.group)# The medinas are different! But is it significant??

trt<-c(rep("P",40),rep("AB",40))

cbind(trt,groups)

sampled_medians<-NA

for(i in 1:100000){
  tempdat<-sample(x = groups,size = 80,replace = F)
  sampled_medians[i]<-median(tempdat[1:40])-median(tempdat[41:80])
}

hist(sampled_medians)
abline(v=deltamed,lwd=2,col='darkorchid')
abline(v=-deltamed,lwd=2,col='darkorchid')


(sum(sampled_medians>deltamed)+sum(sampled_medians<-deltamed))/100000 # p value



p.med<- median(mass.df[mass.df$treatment=="P",]$perc.mass_loss)
ab.med<- median(mass.df[mass.df$treatment=="AB",]$perc.mass_loss)

delta.med<- p.med-ab.med

#how often would I get a delta median of 0.3686405 or more extreme if the null is true?
set.seed(26)
G1<-rexp(15,rate = 2)#Make up some non normal data.
G2<-rexp(15,rate = 12)

hist(G1)
hist(G2)


totalgroups<-c(G1,G2)
hist(totalgroups)
abline(v=median(G1),col="lightgreen",lwd=2)
abline(v=median(G2),col="darkolivegreen",lwd=2)
deltamed<-median(G1)-median(G2)# The medinas are different! But is it significant??

#how often would I get a delta median of 0.3686405 or more extreme if the null is true?

group<-c(rep("G1",15),rep("G2",15))
cbind(group,totalgroups)


group<-c(rep("G1",15),rep("G2",15))
cbind(group,totalgroups)




sampled_medians<-NA

for(i in 1:100000){
  tempdat<-sample(x = totalgroups,size = 30,replace = F)
  sampled_medians[i]<-median(tempdat[1:15])-median(tempdat[16:30])
}

hist(sampled_medians)
abline(v=deltamed,lwd=2,col='darkorchid')
abline(v=-deltamed,lwd=2,col='darkorchid')


(sum(sampled_medians>deltamed)+sum(sampled_medians<-deltamed))/100000 # p value


mass.df %>%
  filter(treatment == "P") %>%
  group_by(tree_id, deploy, site_num) %>%
  mutate(lambda = boxcox(perc.mass_loss ~ 1)$x[which.max(boxcox(perc.mass_loss ~ 1)$y)],
         trans.mass = ((perc.mass_loss^lambda) - 1) / lambda)%>%
  pull(trans.mass)%>%
  hist()


normalTest(mass.df$perc.mass_loss, method = "da")

power.t.test(n=80, sd=sd(mass.df$perc.mass_loss), sig.level = 0.05, power=.9)

t.test((mass.deploy.merged.df[mass.deploy.merged.df$treatment =="P",]$perc.mass_loss),(mass.deploy.merged.df[mass.deploy.merged.df$treatment =="AB",]$perc.mass_loss))

mass.deploy.merged.df %>%
  filter(hfa == "H")%>%
  ggplot(aes(x = treatment, y = z_score, color = treatment)) +
    geom_boxplot()+
  geom_point() 

```


**Subset dataframes to z score by deployment site (all HOK 1, all HOK 2, etc...)**

Z scoring controls for site variability, and allows for a better comparison of treatments. But how exactly?

Z-scoring is a statistical measure that quantifies how far away a particular data point is from the mean of a dataset in terms of standard deviations (i.e., the spread of the data points from the mean). It's a way to standardize data and make it more comparable across different scales or distributions. Here's how z-scoring works:

1) calculate the mean and standard deviation: for the variable you want to z-score (in this case mass loss by deployment site), calculate its mean (average) and standard deviation. These values provide information about the central tendency (i.e., the center/midpoint of the data or a value around which the data clusters) and the spread of the data.

2) subtract the mean: for each data point, subtract the mean of the variable. This step shifts the data so that the new mean becomes 0.

3) divide by the standard deviation: after subtracting the mean, divide the result by the standard deviation. This step scales the data based on the spread of the original data, so that the new data points are expressed in terms of standard deviations from the mean.

Mathematically, the z-score (Z) for a data point (X) with mean (μ) and standard deviation (σ) is calculated using the formula:

Z = (X - μ) / σ

The resulting z-score indicates how many standard deviations the original data point is away from the mean. If the z-score is positive, it means the data point is above the mean, and if it's negative, it's below the mean.

Note: z-scoring assumes a roughly normal distribution of the data.

Below, the percent mass loss for each deployment site is z scored. Additionally, the larger dataframe has been subset to only include P treatments so that the "true" HFA can be calculated.
```{r}
#check for distribution of mass loss
hist(mass.df$perc.mass_loss)
  #roughly normal...that's good!

#####Begin z scoring
#HOK 1 subset
mass.hok1.df <- data.frame(mass.df[mass.df$deploy == "HOK" & mass.df$site_num == "1", ])
# Calculate z-scores 
mass.hok1.df=mass.hok1.df%>%
  mutate(z_score= (perc.mass_loss - mean(perc.mass_loss))/sd(perc.mass_loss))


#HOK 1 P subset
mass.hok1.present.df = data.frame(mass.hok1.df[mass.hok1.df$deploy == "HOK" & mass.hok1.df$treatment == "P" & mass.hok1.df$site_num == "1", ])
# Calculate z-scores 
mass.hok1.present.df=mass.hok1.present.df%>%
  mutate(z_score= (perc.mass_loss - mean(perc.mass_loss))/sd(perc.mass_loss))
  #HOK 1 AB subet
mass.hok1.absent.df = data.frame(mass.hok1.df[mass.hok1.df$deploy == "HOK" & mass.hok1.df$treatment == "AB" & mass.hok1.df$site_num == "1", ])


#HOK 2 subset
mass.hok2.df <- data.frame(mass.df[mass.df$deploy == "HOK" & mass.df$site_num == "2", ])
# Calculate z-scores 
mass.hok2.df=mass.hok2.df%>%
  mutate(z_score= (perc.mass_loss - mean(perc.mass_loss))/sd(perc.mass_loss))


#HOK 2 P subset
mass.hok2.present.df =data.frame(mass.hok2.df[mass.hok2.df$deploy == "HOK" & mass.hok2.df$treatment == "P" & mass.hok2.df$site_num == "2", ])
# Calculate z-scores 
mass.hok2.present.df=mass.hok2.present.df%>%
  mutate(z_score= (perc.mass_loss - mean(perc.mass_loss))/sd(perc.mass_loss))
  #HOK 2 AB subset
mass.hok2.absent.df =data.frame(mass.hok2.df[mass.hok2.df$deploy == "HOK" & mass.hok2.df$treatment == "AB" & mass.hok2.df$site_num == "2", ])

#SEK 1 subset
mass.sek1.df <- data.frame(mass.df[mass.df$deploy == "SEK" & mass.df$site_num == "1", ])
# Calculate z-scores 
mass.sek1.df=mass.sek1.df%>%
  mutate(z_score= (perc.mass_loss - mean(perc.mass_loss))/sd(perc.mass_loss))


#SEK 1 P subset
mass.sek1.present.df = data.frame(mass.sek1.df[mass.sek1.df$deploy == "SEK" & mass.sek1.df$treatment == "P" & mass.sek1.df$site_num == "1", ])
# Calculate z-scores 
mass.sek1.present.df=mass.sek1.present.df%>%
  mutate(z_score= (perc.mass_loss - mean(perc.mass_loss))/sd(perc.mass_loss))
  #SEK 1 AB subset
mass.sek1.absent.df = data.frame(mass.sek1.df[mass.sek1.df$deploy == "SEK" & mass.sek1.df$treatment == "AB" & mass.sek1.df$site_num == "1", ])


#SEK 2 subset
mass.sek2.df <- data.frame(mass.df[mass.df$deploy == "SEK" & mass.df$site_num == "2", ])
# Calculate z-scores 
mass.sek2.df=mass.sek2.df%>%
  mutate(z_score= (perc.mass_loss - mean(perc.mass_loss))/sd(perc.mass_loss))


#SEK 2 P subset
mass.sek2.present.df = data.frame(mass.sek2.df[mass.sek2.df$deploy == "SEK" & mass.sek2.df$treatment == "P" & mass.sek2.df$site_num == "2", ])
# Calculate z-scores 
mass.sek2.present.df=mass.sek2.present.df%>%
  mutate(z_score= (perc.mass_loss - mean(perc.mass_loss))/sd(perc.mass_loss))
  #SEK 2 AB subset
mass.sek2.absent.df = data.frame(mass.sek2.df[mass.sek2.df$deploy == "SEK" & mass.sek2.df$treatment == "AB" & mass.sek2.df$site_num == "2", ])

##merge all sites
mass.deploy.merged.df=rbind(mass.hok1.df, mass.hok2.df, mass.sek1.df, mass.sek2.df)

mass.deploy.merged.df=mass.deploy.merged.df %>%
  mutate(hfa = ifelse(hfa == "A", "AW", "H"))

mass.deploy.merged.df <- mass.deploy.merged.df %>% 
  mutate(treatment = factor(treatment, levels = c("AB", "P")))%>%
           mutate(hfa = factor(hfa, levels = c("H", "AW")))


mass.deploy.merged.df$treatment=as.factor(as.factor(mass.deploy.merged.df$treatment))
mass.deploy.merged.df$tree_id=as.factor(as.factor(mass.deploy.merged.df$tree_id))
mass.deploy.merged.df$deploy=as.factor(as.factor(mass.deploy.merged.df$deploy))
mass.deploy.merged.df$hfa=as.factor(as.factor(mass.deploy.merged.df$hfa))

#merge all P treatment sites 
mass.present.deploy.merged.df=rbind(mass.hok1.present.df, mass.hok2.present.df, mass.sek1.present.df, mass.sek2.present.df)
mass.present.deploy.merged.df$treatment=as.factor(mass.present.deploy.merged.df$treatment)
mass.present.deploy.merged.df$tree_id=as.factor(mass.present.deploy.merged.df$tree_id)
mass.present.deploy.merged.df$deploy=as.factor(mass.present.deploy.merged.df$deploy)
mass.present.deploy.merged.df$hfa=as.factor(mass.present.deploy.merged.df$hfa)

#merge all AB treatment sites 
mass.absent.deploy.merged.df=rbind(mass.hok1.absent.df, mass.hok2.absent.df, mass.sek1.absent.df, mass.sek2.absent.df)
mass.absent.deploy.merged.df$treatment=as.factor(mass.absent.deploy.merged.df$treatment)
mass.absent.deploy.merged.df$tree_id=as.factor(mass.absent.deploy.merged.df$tree_id)
mass.absent.deploy.merged.df$deploy=as.factor(mass.absent.deploy.merged.df$deploy)
mass.absent.deploy.merged.df$hfa=as.factor(mass.absent.deploy.merged.df$hfa)

hist(mass.deploy.merged.df$z_score)

hist(mass.deploy.merged.df$perc.mass_loss)

mass.paired.df<- mass.deploy.merged.df


mass.deploy.merged.df<- mass.deploy.merged.df %>%
  group_by(treatment, tree_id, deploy, site_num, hfa) %>%
  mutate(fold.change = final_correct/initial_mass)%>%
    mutate(log.fold.change = log2(fold.change))

mass.deploy.merged.df %>%
  filter(hfa == "H") %>%
  ggplot(aes(x = treatment, y = log.fold.change, color = treatment, fill = treatment)) +
  stat_summary(fun = mean, geom = "point", shape = 8, size = 4) +
  geom_boxplot(alpha = 0.2) +
  geom_point(alpha = 0.2)

mass.deploy.merged.df %>%
  filter(hfa == "H") %>%
  ggplot(aes(x = treatment, y = log.fold.change, color = treatment, fill = treatment)) +
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = 0.2) +
  stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = "point", shape = 20, size = 4) +
  geom_point(alpha = 0.2)


```



```{r}
mass.deploy.merged.df %>% 
  mutate(treatment = factor(treatment, levels = c("P", "AB")))%>%
           mutate(hfa = factor(hfa, levels =c("H", "AW")))

#model exploration
p.mass_aov1=aov(z_score ~ hfa, data = na.omit(mass.deploy.merged.df[mass.deploy.merged.df$treatment=="P",]))
summary(p.mass_aov1)
m2=lmer(perc.mass_loss ~ hfa + (1 | tree_id) + (1 | tree_num) + (1 | deploy) + (1 | site_num), data = na.omit(mass.deploy.merged.df[mass.deploy.merged.df$treatment=="P",]) )
summary(m2)
m3=lmer(z_score ~ hfa + (1 | tree_num) , data = na.omit(mass.deploy.merged.df[mass.deploy.merged.df$treatment=="P",]) )
summary(m3)

t.test(na.omit(mass.deploy.merged.df[mass.deploy.merged.df$treatment=="P" & mass.deploy.merged.df$hfa=="H",]$perc.mass_loss),na.omit(mass.deploy.merged.df[mass.deploy.merged.df$treatment=="P" & mass.deploy.merged.df$hfa=="AW",]$perc.mass_loss))

p.mass_aov=aov(perc.mass_loss ~ hfa, data = na.omit(mass.deploy.merged.df[mass.deploy.merged.df$treatment=="P",]))
summary(p.mass_aov)

#model aov 1
summary(p.mass_aov1)
p.mass_tHSD=TukeyHSD(p.mass_aov1, ordered = F, conf.level = 0.95)
p.cld <- multcompLetters4(p.mass_aov1, p.mass_tHSD)

# table with factors and 3rd quantile
p.mass.table <- mass.deploy.merged.df%>%
    filter(treatment == "P")%>%
  dplyr::group_by(hfa) %>%
  dplyr::summarise(mean=mean(perc.mass_loss), quant = quantile(perc.mass_loss, probs = 0.75)) %>%
  dplyr::arrange(desc(mean))

# extracting the compact letter display and adding to the Tk table
p.cld <- as.data.frame.list(p.cld$hfa)
p.mass.table$cld <- p.cld$Letters

#treatment only
mass.deploy.merged.df%>%
  ggplot(aes(x=hfa, y = perc.mass_loss, fill = hfa))+
   stat_boxplot(geom ='errorbar', width = 0.1) + 
  geom_boxplot(alpha = 0.5, width = 0.6)+
     geom_point(aes(shape = as.factor(site_num)), position = position_jitter(width = 0.2)) +
    ggtitle("Present-only")+
  xlab("")+
  ylab("% mass loss")+
   coord_cartesian(ylim = c(0,70))+
    labs(shape = "site", fill = "treatment") +  # Change "Your New Legend Title" to your desired title
  scale_fill_colorblind()+
  geom_hline(data = mass.deploy.merged.df[mass.deploy.merged.df$treatment=="P",], aes(yintercept = mean(perc.mass_loss), linetype = "Average"), color = "red", linetype = "dotted", size= 1) +
    geom_text(data = p.mass.table, aes(y = quant, label = cld), color = "black", fontface= "bold",size = 7, vjust=-4, hjust =0.35)+
  Fig.formatting
present.z_contrast.mass.plot

#model exploration
ab.mass_aov1=aov(z_score ~ hfa, data = na.omit(mass.deploy.merged.df[mass.deploy.merged.df$treatment=="AB",]))
m2=lmer(perc.mass_loss ~ hfa + (1 | tree_id) + (1 | tree_num) + (1 | deploy) + (1 | site_num), data = na.omit(mass.deploy.merged.df[mass.deploy.merged.df$treatment=="P",]) )
m3=lmer(z_score ~ hfa + (1 | tree_num) , data = na.omit(mass.deploy.merged.df[mass.deploy.merged.df$treatment=="P",]) )

#model aov 1
summary(ab.mass_aov1)
ab.mass_tHSD=TukeyHSD(ab.mass_aov1, ordered = F, conf.level = 0.95)
ab.cld <- multcompLetters4(ab.mass_aov1, ab.mass_tHSD)

# table with factors and 3rd quantile
ab.mass.table <- mass.deploy.merged.df%>%
  filter(treatment == "AB")%>%
  dplyr::group_by(hfa) %>%
  dplyr::summarise(mean=mean(perc.mass_loss), quant = quantile(perc.mass_loss, probs = 0.75)) %>%
  dplyr::arrange(desc(mean))

# extracting the compact letter display and adding to the Tk table
ab.cld <- as.data.frame.list(ab.cld$hfa)
ab.mass.table$cld <- ab.cld$Letters

#absent only
absent.z_contrast.mass.plot=mass.deploy.merged.df%>%
  filter(treatment == "AB")%>%
  ggplot(aes(x=hfa, y = perc.mass_loss, fill = hfa))+
  stat_boxplot(geom ='errorbar', width = 0.1) + 
  geom_boxplot(alpha = 0.5, width = 0.6)+
     geom_point(aes(shape = as.factor(site_num)), position = position_jitter(width = 0.2)) +
    ggtitle("Absent-only")+
  xlab("")+
  ylab("")+
  coord_cartesian(ylim = c(0,70))+
    labs(shape = "site", fill = "treatment") +  # Change "Your New Legend Title" to your desired title
  scale_fill_colorblind()+
  geom_hline(data = mass.deploy.merged.df[mass.deploy.merged.df$treatment=="AB",], aes(yintercept = mean(perc.mass_loss), linetype = "Average"), color = "red", linetype = "dotted", size= 1) +
    geom_text(data = p.mass.table, aes(y = quant, label = cld), color = "black", fontface= "bold",size = 7, vjust=-5.5, hjust =0.35)+
  Fig.formatting

absent.z_contrast.mass.plot

mass_extract.legend <- get_legend(
  # create some space to the left of the legend
 present.z_contrast.mass.plot  + theme(legend.box.margin = margin(0, 0, 0, 10)))


mass.loss.plot=plot_grid(
  present.z_contrast.mass.plot + theme(legend.position = "none"), 
  absent.z_contrast.mass.plot + theme(legend.position = "none"),
  mass_extract.legend, 
  ncol=3,
  rel_widths = c(8,8,3))

ggsave("figures/mass.loss.plot.pdf", mass.loss.plot, width = 20, height = 6)

#### anova for treatment P vs AB only
m4=lmer(z_score ~ treatment + (1 | hfa) , data = na.omit(mass.deploy.merged.df))
aov4=aov(z_score ~ hfa*treatment , data = na.omit(mass.deploy.merged.df))
trt.aov=aov(z_score ~ treatment , data = na.omit(mass.deploy.merged.df))

#model aov 1
summary(trt.aov)
trt.mass_tHSD=TukeyHSD(trt.aov, ordered = F, conf.level = 0.95)
trt.cld <- multcompLetters4(trt.aov, trt.mass_tHSD)

# table with factors and 3rd quantile
trt.mass.table <- mass.deploy.merged.df%>%
  dplyr::group_by(treatment) %>%
  dplyr::summarise(mean=mean(perc.mass_loss), quant = quantile(perc.mass_loss, probs = 0.75)) %>%
  dplyr::arrange(desc(mean))

# extracting the compact letter display and adding to the Tk table
trt.cld <- as.data.frame.list(trt.cld$treatment)
trt.mass.table$cld <- trt.cld$Letters

#use ANOVA
TukeyHSD(aov4)

mass.deploy.merged.df%>%
  ggplot(aes(x=treatment, y = perc.mass_loss, fill = treatment))+
  stat_boxplot(geom ='errorbar', width = 0.1) + 
  geom_boxplot(alpha = 0.5, width = 0.6)+
     geom_point(aes(shape = as.factor(site_num)), position = position_jitter(width = 0.13)) +
    ggtitle("Present vs. absent")+
  xlab("treatment")+
  ylab("% mass loss")+
  coord_cartesian(ylim = c(0,70))+
    labs(shape = "site", fill = "treatment") +  # Change "Your New Legend Title" to your desired title
scale_fill_manual(values  = c("#CC79A7", "#009E73"))+
  geom_hline(data = mass.deploy.merged.df, aes(yintercept = mean(perc.mass_loss), linetype = "Average"), color = "red", linetype = "dotted", size= 1) +
    geom_text(data = trt.mass.table, aes(y = quant, label = cld), color = "black", fontface= "bold",size = 7, vjust=-5.5, hjust =0.35)+
  Fig.formatting

ggsave("figures/trt.mass_loss.plot.pdf", trt.mass_loss.plot, width = 20, height = 6)


#mean 
mean(mass.deploy.merged.df[mass.deploy.merged.df$treatment=="P",]$perc.mass_loss)
mean(mass.deploy.merged.df[mass.deploy.merged.df$treatment=="AB",]$perc.mass_loss)
#33-40 = 7 % difference



```





----------- START OF HFAI CALCULATIONS ----------------------------
**Background information regarding Home-field Advantage:**

The Home Field Advantage Index (HFAI) derived from Ayres et al. (2009) uses the relative mass loss values (rml) of species A and B at different sites. The HFAI therefore represents the difference in the rate of litter decomposition between two different sites ("Hoko" and "Sekiu") for both species A and B. Species A and B, in this case, are alder trees of different origin. For example, species A is Hoko alder and species B is Sekiu alder. There are 10 alder trees per river, representing biological replicates. So, the HFAI quantifies the *advantage* or *disadvantage* of each "species" in their respective home environment compared to an away environment.

Interpreting HFAI values involves considering their sign and magnitude:

**Positive** HFAI Values:
Positive values indicate that both species A and B experience faster decomposition rates at their home site compared to the away site. This suggests that both species are better adapted to their home environment in terms of litter decomposition.

**Negative** HFAI Values:
Negative values indicate that both species A and B experience slower decomposition rates at their home site (HF disadvantage (HFDA)) compared to the away site. This suggests that both species might not be well-suited for decomposition in their own environment and may decompose more efficiently in a different environment.

**Magnitude** of HFAI:
The magnitude of the HFAI values indicates the strength of the advantage or disadvantage. Larger absolute values (positive or negative) suggest a greater difference in decomposition rates between the home and away sites.


Calculating HFA Index (HFAI) from Ayres et al. (2009):

There are two equations from which HFAI is derived: the relative mass loss (rml) of species decomposing at home and away site, and the scaling equation which allows for interpretaibility of the home-field advantage. Below is a brief summary of the components found in the derivations:

Aa: This represents the percent mass loss of leaf litter from species A (HOK) when it's decomposing at site a (HOK, or the area dominated by species A). This value is given as a percentage.

Ba: This represents the percent mass loss of leaf litter from species B (SEK) when it's decomposing at site a This value is also given as a percentage.

(Aa + Ba): This is the sum of the percent mass loss of leaf litter from both species A and B when they're decomposing at site a, or HOK and SEK leaf packs at HOK.

(Aa / (Aa + Ba) * 100): This is the full equation that calculates the proportion of the mass loss contributed by species A at site a, relative to the **total mass** loss by both species A and B combined at that site. This percentage value indicates how much of the total mass loss at site a is due to species A.

A similar equation is calculated for species B decomposing at site a. The variables are substituted accordingly.

Armla and Armlb; Brlma, Brmlb: These are the relative mass loss values for species A and B, respectively, when they are decomposing at site a (dominated by species A) or site b (dominated by species B). These values are expressed as percentages of total mass loss at their respective sites.

(((ARMLa + BRMLb)^2 / (ARMLb + BRMLa)^2) * 100)-100: This is the full equation that calculates the squared ratio of the combined relative mass loss of species A at site a and species B at site b (i.e., home), divided by the squared ratio of the combined relative mass loss of species A at site b and species B at site a (i.e., away).

100 is subtracted from the value obtained. This is done to measure the percentage difference in mass loss at the home site (site dominated by the species) compared to the away site (site dominated by the other species). If the value is positive, it indicates that the litter decomposes faster at its home site, showing a home-field advantage. If the value is negative, it suggests that decomposition is slower at the home site, indicating a home-field disadvantage.

The equation calculates the Home-Field Advantage Index (HFAI) by comparing the relative mass loss of litter from two species at their home and away sites. The result is expressed as a percentage, indicating how much faster (or slower) the decomposition occurs at the home site compared to the away site.

create df subsets
```{r}
#HOK 1 subset
mass.hok1.df <- data.frame(mass.df[mass.df$deploy == "HOK" & mass.df$site_num == "1", ])

#HOK 1 P subset
mass.hok1.present.df = data.frame(mass.hok1.df[mass.hok1.df$deploy == "HOK" & mass.hok1.df$treatment == "P" & mass.hok1.df$site_num == "1", ])
#HOK 1 AB subet
mass.hok1.absent.df = data.frame(mass.hok1.df[mass.hok1.df$deploy == "HOK" & mass.hok1.df$treatment == "AB" & mass.hok1.df$site_num == "1", ])

#HOK 2 subset
mass.hok2.df <- data.frame(mass.df[mass.df$deploy == "HOK" & mass.df$site_num == "2", ])
#HOK 2 P subset
mass.hok2.present.df =data.frame(mass.hok2.df[mass.hok2.df$deploy == "HOK" & mass.hok2.df$treatment == "P" & mass.hok2.df$site_num == "2", ])
#HOK 2 AB subset
mass.hok2.absent.df =data.frame(mass.hok2.df[mass.hok2.df$deploy == "HOK" & mass.hok2.df$treatment == "AB" & mass.hok2.df$site_num == "2", ])

#SEK 1 subset
mass.sek1.df <- data.frame(mass.df[mass.df$deploy == "SEK" & mass.df$site_num == "1", ])
#SEK 1 P subset
mass.sek1.present.df = data.frame(mass.sek1.df[mass.sek1.df$deploy == "SEK" & mass.sek1.df$treatment == "P" & mass.sek1.df$site_num == "1", ])
#SEK 1 AB subset
mass.sek1.absent.df = data.frame(mass.sek1.df[mass.sek1.df$deploy == "SEK" & mass.sek1.df$treatment == "AB" & mass.sek1.df$site_num == "1", ])


#SEK 2 subset
mass.sek2.df <- data.frame(mass.df[mass.df$deploy == "SEK" & mass.df$site_num == "2", ])
#SEK 2 P subset
mass.sek2.present.df = data.frame(mass.sek2.df[mass.sek2.df$deploy == "SEK" & mass.sek2.df$treatment == "P" & mass.sek2.df$site_num == "2", ])
#SEK 2 AB subset
mass.sek2.absent.df = data.frame(mass.sek2.df[mass.sek2.df$deploy == "SEK" & mass.sek2.df$treatment == "AB" & mass.sek2.df$site_num == "2", ])

```


NEW: use this! This is a now a proper test dataframe with for loop!

NOTICE: THIS IS FOR SITE 1:

Updated 12/12/23: generate **present**, site a (HOK 1)
```{r}
########################
mass.hok1.present.df <- mass.hok1.present.df %>%
  mutate(ayres = ifelse(hfa == "H", "Aa", ifelse(hfa == "A", "Ba", NA)))
  #since we're at site a, the notation follows species A at a (Aa) or species B at a (Ba)

# Create a new column combining tree_num and ayres with a period in between
mass.hok1.present.df$ayres.tree <- paste(mass.hok1.present.df$ayres, mass.hok1.present.df$tree_num, sep = ".")

# Define the range for X and Y (1 to 5)
X_values <- 1:5
Y_values <- 1:5

# Initialize empty vectors to store names and values for Armla
names_vector_armla <- character(0)
values_vector_armla <- numeric(0)
treatment_vector_armla <- character(0)

names_vector_fold_change <- character(0)
values_vector_fold_change <- numeric(0)
treatment_vector_fold_change <- character(0)


# Loop through all combinations of X and Y for Aa and Ba for Armla
for (X in X_values) {
  for (Y in Y_values) {
    Aa_column <- paste("Aa.", X, sep = "")
    Ba_column <- paste("Ba.", Y, sep = "")
    
    # Print the current combination for verification
    cat("Calculating Armla for Aa_column =", Aa_column, "and Ba_column =", Ba_column, "\n")

    # Calculate the result for Armla for the current combination
    p.site_1.armla_result <- ((mass.hok1.present.df[mass.hok1.present.df$ayres.tree == Aa_column, "perc.mass_loss"]) / 
                     (mass.hok1.present.df[mass.hok1.present.df$ayres.tree == Aa_column, "perc.mass_loss"] + 
                      mass.hok1.present.df[mass.hok1.present.df$ayres.tree == Ba_column, "perc.mass_loss"])) * 100
    
    # Calculate log fold change
    fold_change_result <- log2((mass.hok1.present.df[mass.hok1.present.df$ayres.tree == Aa_column, "perc.mass_loss"]) / (mass.hok1.present.df[mass.hok1.present.df$ayres.tree == Ba_column, "perc.mass_loss"]))
    
     # Create a new name for the fold change results
    fold_change_name <- paste("Armla.fold_change", X, Y, sep = ".")


    # Print the Armla equation for verification
    cat("Armla Equation: (", Aa_column, "/(", Aa_column, "+", Ba_column, ")) * 100 = ", p.site_1.armla_result, "\n")

    # Create a new name for the results
    armla_name <- paste("Armla", X, Y, sep = ".")
    
    # Extract the treatment from mass.hok1.present.df for the current combination
    treatment_name <- mass.hok1.present.df[mass.hok1.present.df$ayres.tree == Aa_column, "treatment"]

    # Append the names and values to the respective vectors for Armla
    names_vector_armla <- c(names_vector_armla, armla_name)
    values_vector_armla <- c(values_vector_armla, p.site_1.armla_result)
    treatment_vector_armla <- c(treatment_vector_armla, treatment_name)
    
    # Append the names and values to the respective vectors for fold change
    names_vector_fold_change <- c(names_vector_fold_change, fold_change_name)
    values_vector_fold_change <- c(values_vector_fold_change, 
                                   
    fold_change_result)
    treatment_vector_fold_change <- c(treatment_vector_fold_change, treatment_name)
    
    
    # Print the Armla dataframe
print("Armla DataFrame:")
print(p.site_1.armla_result)

  }
}

# Create dataframe for Armla

p.site_1.armla_df <- data.frame(names = names_vector_armla, values = values_vector_armla, treatment = treatment_vector_armla)

p.site_1.armla.fold_change_df <- data.frame(names = names_vector_fold_change, values = values_vector_fold_change, treatment = treatment_vector_fold_change)

p.site_1.armla_df <- rbind(p.site_1.armla_df, p.site_1.armla.fold_change_df)


# Initialize empty vectors to store names and values for Brmla
names_vector_brmla <- character(0)
values_vector_brmla <- numeric(0)
treatment_vector_brmla <- character(0)

names_vector_fold_change <- character(0)
values_vector_fold_change <- numeric(0)
treatment_vector_fold_change <- character(0)


# Loop through all combinations of X and Y for Aa and Ba for Brmla
for (X in X_values) {
  for (Y in Y_values) {
    Ba_column <- paste("Ba.", X, sep = "")
    Aa_column <- paste("Aa.", Y, sep = "")
    
    # Print the current combination for verification
    cat("Calculating Brmla for Ba_column =", Ba_column, "and Aa_column =", Aa_column, "\n")

    # Calculate the result for Brmla for the current combination
    p.site_1.brmla_result <- ((mass.hok1.present.df[mass.hok1.present.df$ayres.tree == Ba_column, "perc.mass_loss"]) / 
                     (mass.hok1.present.df[mass.hok1.present.df$ayres.tree == Ba_column, "perc.mass_loss"] + 
                      mass.hok1.present.df[mass.hok1.present.df$ayres.tree == Aa_column, "perc.mass_loss"])) * 100
    
      # Calculate log fold change
    fold_change_result <- log2((mass.hok1.present.df[mass.hok1.present.df$ayres.tree == Ba_column, "perc.mass_loss"]) / (mass.hok1.present.df[mass.hok1.present.df$ayres.tree == Aa_column, "perc.mass_loss"]))
    
     # Create a new name for the fold change results
    fold_change_name <- paste("Brmla.fold_change", X, Y, sep = ".")

    # Print the Brmla equation for verification
    cat("Brmla Equation: (", Ba_column, "/(", Ba_column, "+", Aa_column, ")) * 100 = ", p.site_1.brmla_result, "\n")

    # Create a new name for the results
    brmla_name <- paste("Brmla", X, Y, sep = ".")
    
    # Extract the treatment from mass.hok1.present.df for the current combination
    treatment_name <- mass.hok1.present.df[mass.hok1.present.df$ayres.tree == Ba_column, "treatment"]

    # Append the names and values to the respective vectors for Brmla
    names_vector_brmla <- c(names_vector_brmla, brmla_name)
    values_vector_brmla <- c(values_vector_brmla, p.site_1.brmla_result)
    treatment_vector_brmla <- c(treatment_vector_brmla, treatment_name)
    
     # Append the names and values to the respective vectors for fold change
    names_vector_fold_change <- c(names_vector_fold_change, fold_change_name)
    values_vector_fold_change <- c(values_vector_fold_change, 
                                   
    fold_change_result)
    treatment_vector_fold_change <- c(treatment_vector_fold_change, treatment_name)
    
    
       # Print the Armla dataframe
print("Brmla DataFrame:")
print(p.site_1.brmla_result)

  }
}

# Create dataframe for Brmla
p.site_1.brmla_df <- data.frame(names = names_vector_brmla, values = values_vector_brmla, treatment = treatment_vector_brmla)

p.site_1.brmla.fold_change_df <- data.frame(names = names_vector_fold_change, values = values_vector_fold_change, treatment = treatment_vector_fold_change)

p.site_1.brmla_df <- rbind(p.site_1.brmla_df, p.site_1.brmla.fold_change_df)


# Merge the dataframes for Armla and Brmla
p.site_1.armla.brmla_df <- rbind(p.site_1.armla_df, p.site_1.brmla_df)

```


Updated 12/12/23: generate **absent**, site a (HOK 1)
```{r}
########################
mass.hok1.absent.df <- mass.hok1.absent.df %>%
  mutate(ayres = ifelse(hfa == "H", "Aa", ifelse(hfa == "A", "Ba", NA)))
  #since we're at site a, the notation follows species A at a (Aa) or species B at a (Ba)

# Create a new column combining tree_num and ayres with a period in between
mass.hok1.absent.df$ayres.tree <- paste(mass.hok1.absent.df$ayres, mass.hok1.absent.df$tree_num, sep = ".")

# Define the range for X and Y (1 to 5)
X_values <- 1:5
Y_values <- 1:5

# Initialize empty vectors to store names and values for Armla
names_vector_armla <- character(0)
values_vector_armla <- numeric(0)
treatment_vector_armla <- character(0)

names_vector_fold_change <- character(0)
values_vector_fold_change <- numeric(0)
treatment_vector_fold_change <- character(0)

# Loop through all combinations of X and Y for Aa and Ba for Armla
for (X in X_values) {
  for (Y in Y_values) {
    Aa_column <- paste("Aa.", X, sep = "")
    Ba_column <- paste("Ba.", Y, sep = "")
    
    # Print the current combination for verification
    cat("Calculating Armla for Aa_column =", Aa_column, "and Ba_column =", Ba_column, "\n")

    # Calculate the result for Armla for the current combination
    ab.site_1_armla_result <- ((mass.hok1.absent.df[mass.hok1.absent.df$ayres.tree == Aa_column, "perc.mass_loss"]) / 
                     (mass.hok1.absent.df[mass.hok1.absent.df$ayres.tree == Aa_column, "perc.mass_loss"] + 
                      mass.hok1.absent.df[mass.hok1.absent.df$ayres.tree == Ba_column, "perc.mass_loss"])) * 100

    # Print the Armla equation for verification
    cat("Armla Equation: (", Aa_column, "/(", Aa_column, "+", Ba_column, ")) * 100 = ", ab.site_1_armla_result, "\n")
    
     # Calculate log fold change
    fold_change_result <- log2((mass.hok1.present.df[mass.hok1.absent.df$ayres.tree == Aa_column, "perc.mass_loss"]) / (mass.hok1.absent.df[mass.hok1.absent.df$ayres.tree == Ba_column, "perc.mass_loss"]))
    
     # Create a new name for the fold change results
    fold_change_name <- paste("Armla.fold_change", X, Y, sep = ".")


    # Create a new name for the results
    armla_name <- paste("Armla", X, Y, sep = ".")
    
    # Extract the treatment from mass.hok1.present.df for the current combination
    treatment_name <- mass.hok1.absent.df[mass.hok1.absent.df$ayres.tree == Aa_column, "treatment"]

    # Append the names and values to the respective vectors for Armla
    names_vector_armla <- c(names_vector_armla, armla_name)
    values_vector_armla <- c(values_vector_armla, ab.site_1_armla_result)
    treatment_vector_armla <- c(treatment_vector_armla, treatment_name)
    # Print the Armla dataframe
print("Armla DataFrame:")
print(ab.site_1_armla_result)

  }
}

# Create dataframe for Armla

ab.site_1.armla_df <- data.frame(names = names_vector_armla, values = values_vector_armla, treatment = treatment_vector_armla)

ab.site_1.armla.fold_change_df <- data.frame(names = names_vector_fold_change, values = values_vector_fold_change, treatment = treatment_vector_fold_change)

ab.site_1.armla_df <- rbind(ab.site_1.armla_df, ab.site_1.armla.fold_change_df)


# Initialize empty vectors to store names and values for Brmla
names_vector_brmla <- character(0)
values_vector_brmla <- numeric(0)
treatment_vector_brmla <- character(0)

names_vector_fold_change <- character(0)
values_vector_fold_change <- numeric(0)
treatment_vector_fold_change <- character(0)

# Loop through all combinations of X and Y for Aa and Ba for Brmla
for (X in X_values) {
  for (Y in Y_values) {
    Ba_column <- paste("Ba.", X, sep = "")
    Aa_column <- paste("Aa.", Y, sep = "")
    
    # Print the current combination for verification
    cat("Calculating Brmla for Ba_column =", Ba_column, "and Aa_column =", Aa_column, "\n")

    # Calculate the result for Brmla for the current combination
    ab.site_1_brmla_result <- ((mass.hok1.absent.df[mass.hok1.absent.df$ayres.tree == Ba_column, "perc.mass_loss"]) / 
                     (mass.hok1.absent.df[mass.hok1.absent.df$ayres.tree == Ba_column, "perc.mass_loss"] + 
                      mass.hok1.absent.df[mass.hok1.absent.df$ayres.tree == Aa_column, "perc.mass_loss"])) * 100

    # Print the Brmla equation for verification
    cat("Brmla Equation: (", Ba_column, "/(", Ba_column, "+", Aa_column, ")) * 100 = ", ab.site_1_brmla_result, "\n")
    
    
    # Calculate log fold change
    fold_change_result <- log2((mass.hok1.present.df[mass.hok1.absent.df$ayres.tree == Ba_column, "perc.mass_loss"]) / (mass.hok1.absent.df[mass.hok1.absent.df$ayres.tree == Aa_column, "perc.mass_loss"]))
    
     # Create a new name for the fold change results
    fold_change_name <- paste("Brmla.fold_change", X, Y, sep = ".")


    # Create a new name for the results
    brmla_name <- paste("Brmla", X, Y, sep = ".")
    
    # Extract the treatment from mass.hok1.absent.df for the current combination
    treatment_name <- mass.hok1.absent.df[mass.hok1.absent.df$ayres.tree == Ba_column, "treatment"]

    # Append the names and values to the respective vectors for Brmla
    names_vector_brmla <- c(names_vector_brmla, brmla_name)
    values_vector_brmla <- c(values_vector_brmla, ab.site_1_brmla_result)
    treatment_vector_brmla <- c(treatment_vector_brmla, treatment_name)
    
    
names_vector_fold_change <- character(0)
values_vector_fold_change <- numeric(0)
treatment_vector_fold_change <- character(0)
    
       # Print the Armla dataframe
print("Brmla DataFrame:")
print(ab.site_1_brmla_result)

  }
}

# Create dataframe for Brmla
ab.site_1.brmla_df <- data.frame(names = names_vector_brmla, values = values_vector_brmla, treatment = treatment_vector_brmla)

ab.site_1.brmla.fold_change_df <- data.frame(names = names_vector_fold_change, values = values_vector_fold_change, treatment = treatment_vector_fold_change)

ab.site_1.brmla_df <- rbind(ab.site_1.brmla_df, ab.site_1.brmla.fold_change_df)

# Merge the dataframes for Armla and Brmla
ab.site_1.armla.brmla_df <- rbind(ab.site_1.armla_df, ab.site_1.brmla_df)

```


Updated 12/12/23: generate **present**, site b (SEK 1)
```{r}
########################
mass.sek1.present.df <- mass.sek1.present.df %>%
  mutate(ayres = ifelse(hfa == "H", "Bb", ifelse(hfa == "A", "Ab", NA)))
  #since we're at site b, the notation follows species A at b (Hoko to Sekiu) or species B at b (Sekiu to Sekiu)

# Create a new column combining tree_num and ayres with a period in between
mass.sek1.present.df$ayres.tree <- paste(mass.sek1.present.df$ayres, mass.sek1.present.df$tree_num, sep = ".")

# Define the range for X and Y (1 to 5)
X_values <- 1:5
Y_values <- 1:5

# Initialize empty vectors to store names and values for Armla
names_vector_brmlb <- character(0)
values_vector_brmlb <- numeric(0)
treatment_vector_brmlb <- character(0)

# Loop through all combinations of X and Y for Aa and Ba for Armla
for (X in X_values) {
  for (Y in Y_values) {
    Bb_column <- paste("Bb.", X, sep = "")
    Ab_column <- paste("Ab.", Y, sep = "")
    
    # Print the current combination for verification
    cat("Calculating Brmlb for Bb_column =", Bb_column, "and Ab_column =", Ab_column, "\n")

    # Calculate the result for Armla for the current combination
    p.site_1.brmlb_result <- ((mass.sek1.present.df[mass.sek1.present.df$ayres.tree == Bb_column, "perc.mass_loss"]) / 
                     (mass.sek1.present.df[mass.sek1.present.df$ayres.tree == Bb_column, "perc.mass_loss"] + 
                      mass.sek1.present.df[mass.sek1.present.df$ayres.tree == Ab_column, "perc.mass_loss"])) * 100

    # Print the Armla equation for verification
    cat("Brmlb Equation: (", Bb_column, "/(", Bb_column, "+", Ab_column, ")) * 100 = ", p.site_1.brmlb_result, "\n")

    # Create a new name for the results
    brmlb_name <- paste("Brmlb", X, Y, sep = ".")
    
    # Extract the treatment from mass.hok1.present.df for the current combination
    treatment_name <- mass.sek1.present.df[mass.sek1.present.df$ayres.tree == Bb_column, "treatment"]

    # Append the names and values to the respective vectors for Armla
    names_vector_brmlb <- c(names_vector_brmlb, brmlb_name)
    values_vector_brmlb <- c(values_vector_brmlb, p.site_1.brmlb_result)
    treatment_vector_brmlb <- c(treatment_vector_brmlb, treatment_name)
    # Print the Armla dataframe
print("Brmlb DataFrame:")
print(p.site_1.brmlb_result)

  }
}

# Create dataframe for Armla

p.site_1.brmlb_df <- data.frame(names = names_vector_brmlb, values = values_vector_brmlb, treatment = treatment_vector_brmlb)

# Initialize empty vectors to store names and values for Brmla
names_vector_armlb <- character(0)
values_vector_armlb <- numeric(0)
treatment_vector_armlb <- character(0)

# Loop through all combinations of X and Y for Aa and Ba for Brmla
for (X in X_values) {
  for (Y in Y_values) {
    Ab_column <- paste("Ab.", X, sep = "")
    Bb_column <- paste("Bb.", Y, sep = "")
    
    # Print the current combination for verification
    cat("Calculating Armlb for Ab_column =", Ab_column, "and Bb_column =", Bb_column, "\n")

    # Calculate the result for Brmla for the current combination
    p.site_1.armlb_result <- ((mass.sek1.present.df[mass.sek1.present.df$ayres.tree == Ab_column, "perc.mass_loss"]) / 
                     (mass.sek1.present.df[mass.sek1.present.df$ayres.tree == Ab_column, "perc.mass_loss"] + 
                      mass.sek1.present.df[mass.sek1.present.df$ayres.tree == Bb_column, "perc.mass_loss"])) * 100

    # Print the Brmla equation for verification
    cat("Armlb Equation: (", Ab_column, "/(", Ab_column, "+", Bb_column, ")) * 100 = ", p.site_1.armlb_result, "\n")

    # Create a new name for the results
    armlb_name <- paste("Armlb", X, Y, sep = ".")
    
    # Extract the treatment from mass.hok2.present.df for the current combination
    treatment_name <- mass.sek1.present.df[mass.sek1.present.df$ayres.tree == Ab_column, "treatment"]

    # Append the names and values to the respective vectors for Brmla
    names_vector_armlb <- c(names_vector_armlb, armlb_name)
    values_vector_armlb <- c(values_vector_armlb, p.site_1.armlb_result)
    treatment_vector_armlb <- c(treatment_vector_armlb, treatment_name)
    
       # Print the Armla dataframe
print("Armlb DataFrame:")
print(p.site_1.armlb_result)

  }
}

# Create dataframe for Brmla
p.site_1.armlb_df <- data.frame(names = names_vector_armlb, values = values_vector_armlb, treatment = treatment_vector_armlb)

# Merge the dataframes for Armla and Brmla
p.site_1.brmlb.armlb_df <- rbind(p.site_1.brmlb_df, p.site_1.armlb_df)

```


Updated 12/12/23: generate **absent**, site b (SEK 1)
```{r}
########################
mass.sek1.absent.df <- mass.sek1.absent.df %>%
  mutate(ayres = ifelse(hfa == "H", "Bb", ifelse(hfa == "A", "Ab", NA)))
  #since we're at site a, the notation follows species A at a (Aa) or species B at a (Ba)

# Create a new column combining tree_num and ayres with a period in between
mass.sek1.absent.df$ayres.tree <- paste(mass.sek1.absent.df$ayres, mass.sek1.absent.df$tree_num, sep = ".")

# Define the range for X and Y (1 to 5)
X_values <- 1:5
Y_values <- 1:5

# Initialize empty vectors to store names and values for Armla
names_vector_brmlb <- character(0)
values_vector_brmlb <- numeric(0)
treatment_vector_brmlb <- character(0)

# Loop through all combinations of X and Y for Aa and Ba for Armla
for (X in X_values) {
  for (Y in Y_values) {
    Bb_column <- paste("Bb.", X, sep = "")
    Ab_column <- paste("Ab.", Y, sep = "")
    
    # Print the current combination for verification
    cat("Calculating Brmlb for Bb_column =", Bb_column, "and Ab_column =", Ab_column, "\n")

    # Calculate the result for Armla for the current combination
    ab.site_1.brmlb_result <- ((mass.sek1.absent.df[mass.sek1.absent.df$ayres.tree == Bb_column, "perc.mass_loss"]) / 
                     (mass.sek1.absent.df[mass.sek1.absent.df$ayres.tree == Bb_column, "perc.mass_loss"] + 
                      mass.sek1.absent.df[mass.sek1.absent.df$ayres.tree == Ab_column, "perc.mass_loss"])) * 100

    # Print the Armla equation for verification
    cat("Brmlb Equation: (", Bb_column, "/(", Bb_column, "+", Ab_column, ")) * 100 = ", ab.site_1.brmlb_result, "\n")

    # Create a new name for the results
    brmlb_name <- paste("Brmlb", X, Y, sep = ".")
    
    # Extract the treatment from mass.hok1.present.df for the current combination
    treatment_name <- mass.sek1.absent.df[mass.sek1.absent.df$ayres.tree == Bb_column, "treatment"]

    # Append the names and values to the respective vectors for Armla
    names_vector_brmlb <- c(names_vector_brmlb, brmlb_name)
    values_vector_brmlb <- c(values_vector_brmlb, ab.site_1.brmlb_result)
    treatment_vector_brmlb <- c(treatment_vector_brmlb, treatment_name)
    # Print the Armla dataframe
print("Brmlb DataFrame:")
print(ab.site_1.brmlb_result)

  }
}

# Create dataframe for Armla

ab.site_1.brmlb_df <- data.frame(names = names_vector_brmlb, values = values_vector_brmlb, treatment = treatment_vector_brmlb)

# Initialize empty vectors to store names and values for Brmla
names_vector_armlb <- character(0)
values_vector_armlb <- numeric(0)
treatment_vector_armlb <- character(0)

# Loop through all combinations of X and Y for Aa and Ba for Brmla
for (X in X_values) {
  for (Y in Y_values) {
    Ab_column <- paste("Ab.", X, sep = "")
    Bb_column <- paste("Bb.", Y, sep = "")
    
    # Print the current combination for verification
    cat("Calculating Armlb for Ab_column =", Ab_column, "and Bb_column =", Bb_column, "\n")

    # Calculate the result for Brmla for the current combination
    ab.site_1.armlb_result <- ((mass.sek1.absent.df[mass.sek1.absent.df$ayres.tree == Ab_column, "perc.mass_loss"]) / 
                     (mass.sek1.absent.df[mass.sek1.absent.df$ayres.tree == Ab_column, "perc.mass_loss"] + 
                      mass.sek1.absent.df[mass.sek1.absent.df$ayres.tree == Bb_column, "perc.mass_loss"])) * 100

    # Print the Brmla equation for verification
    cat("Armlb Equation: (", Ab_column, "/(", Ab_column, "+", Bb_column, ")) * 100 = ", ab.site_1.armlb_result, "\n")

    # Create a new name for the results
    armlb_name <- paste("Armlb", X, Y, sep = ".")
    
    # Extract the treatment from mass.hok2.present.df for the current combination
    treatment_name <- mass.sek1.absent.df[mass.sek1.absent.df$ayres.tree == Ab_column, "treatment"]

    # Append the names and values to the respective vectors for Brmla
    names_vector_armlb <- c(names_vector_armlb, armlb_name)
    values_vector_armlb <- c(values_vector_armlb, ab.site_1.armlb_result)
    treatment_vector_armlb <- c(treatment_vector_armlb, treatment_name)
    
       # Print the Armla dataframe
print("Armlb DataFrame:")
print(ab.site_1.armlb_result)

  }
}

# Create dataframe for Brmla
ab.site_1.armlb_df <- data.frame(names = names_vector_armlb, values = values_vector_armlb, treatment = treatment_vector_armlb)

# Merge the dataframes for Armla and Brmla
ab.site_1.brmlb.armlb_df <- rbind(ab.site_1.brmlb_df, ab.site_1.armlb_df)

```


updated 12/12/23: merge **present**, site a and b (aka HOK 1 and SEK 1) dataframes 
```{r}
#merge both present site 1 dataframes
mass.present.site1.df=rbind(p.site_1.armla.brmla_df, p.site_1.brmlb.armlb_df)
head(mass.present.site1.df)
# Define the range for X and Y (1 to 5)
X_values <- 1:5
Y_values <- 1:5

# Create an empty dataframe to store the results
result_df_1 <- data.frame(names = character(0), values = numeric(0), treatment = character(0))

# Loop through all combinations of X and Y for Armla, Brmla, Brmlb, and Armlb
for (X in X_values) {
  for (Y in Y_values) {
    armla_name <- paste("Armla.", X, ".", Y, sep = "")
    brmla_name <- paste("Brmla.", X, ".", Y, sep = "")
    brmlb_name <- paste("Brmlb.", X, ".", Y, sep = "")
    armlb_name <- paste("Armlb.", X, ".", Y, sep = "")
    
    # Calculate the result for the current combination
    result <- 
((
  (mass.present.site1.df[mass.present.site1.df$names == armla_name, "values"] +
      mass.present.site1.df[mass.present.site1.df$names == brmlb_name, "values"])/2)/ (
      (mass.present.site1.df[mass.present.site1.df$names == armlb_name, "values"] +
      mass.present.site1.df[mass.present.site1.df$names == brmla_name, "values"])/2
    )*100
)-100
    
     # Create a new name (letter) for the result
    result_name <- LETTERS[(X - 1) * 5 + Y]
    
  # Get the treatment for the current combination
    treatment_name <- mass.present.site1.df[mass.present.site1.df$names == armla_name, "treatment"]
    
    # Print the full equation output
    cat("Calculating for Armla =", armla_name, "Brmlb =", brmlb_name, "Armlb =", armlb_name, "Brmla =", brmla_name)
    cat("Equation:", "(((", armla_name, " + ", brmlb_name, "/2) / (", armlb_name, " + ", brmla_name, "/2)) * 100 - 100")
    cat("Result =", result, "\n")
 
# Append the name and value to the result dataframe
    result_df_1 <- rbind(result_df_1, data.frame(names = result_name, values = result, treatment= treatment_name))  }
}


# View the resulting dataframe
result_df_1
```


updated 12/12/23: merge **absent**, merging HOK 1 and SEK 1 dataframe
```{r}
#merge both present site 1 dataframes
mass.absent.site1.df=rbind(ab.site_1.armla.brmla_df, ab.site_1.brmlb.armlb_df)

# Create an empty dataframe to store the results
result_ab_df_1 <- data.frame(names = character(0), values = numeric(0), treatment = character (0))

# Loop through all combinations of X and Y for Armla, Brmla, Brmlb, and Armlb
for (X in X_values) {
  for (Y in Y_values) {
    armla_name <- paste("Armla.", X, ".", Y, sep = "")
    brmla_name <- paste("Brmla.", X, ".", Y, sep = "")
    brmlb_name <- paste("Brmlb.", X, ".", Y, sep = "")
    armlb_name <- paste("Armlb.", X, ".", Y, sep = "")
    
    # Calculate the result for the current combination
    result <- 
((
  (mass.absent.site1.df[mass.absent.site1.df$names == armla_name, "values"] +
      mass.absent.site1.df[mass.absent.site1.df$names == brmlb_name, "values"])/2)/ (
      (mass.absent.site1.df[mass.absent.site1.df$names == armlb_name, "values"] +
      mass.absent.site1.df[mass.absent.site1.df$names == brmla_name, "values"])/2
    )*100
)-100
     # Create a new name (letter) for the result
result_name <- paste0(LETTERS[(X - 1) * 5 + Y], "_1")

# Get the treatment for the current combination
    treatment_name <- mass.absent.site1.df[mass.absent.site1.df$names == armla_name, "treatment"]
    

    # Append the name and value to the result dataframe
    result_ab_df_1 <- rbind(result_ab_df_1, data.frame(names = result_name, values = result, treatment= treatment_name))
  }
}


# View the resulting dataframe
result_ab_df_1


```


###Site 2
Updated 12/12/23: generate **present**, site a (HOK 2)
```{r}
########################
mass.hok2.present.df <- mass.hok2.present.df %>%
  mutate(ayres = ifelse(hfa == "H", "Aa", ifelse(hfa == "A", "Ba", NA)))
  #since we're at site a, the notation follows species A at a (Aa) or species B at a (Ba)

# Create a new column combining tree_num and ayres with a period in between
mass.hok2.present.df$ayres.tree <- paste(mass.hok2.present.df$ayres, mass.hok2.present.df$tree_num, sep = ".")

# Define the range for X and Y (1 to 5)
X_values <- 1:5
Y_values <- 1:5

# Initialize empty vectors to store names and values for Armla
names_vector_armla <- character(0)
values_vector_armla <- numeric(0)
treatment_vector_armla <- character(0)

# Loop through all combinations of X and Y for Aa and Ba for Armla
for (X in X_values) {
  for (Y in Y_values) {
    Aa_column <- paste("Aa.", X, sep = "")
    Ba_column <- paste("Ba.", Y, sep = "")
    
    # Print the current combination for verification
    cat("Calculating Armla for Aa_column =", Aa_column, "and Ba_column =", Ba_column, "\n")

    # Calculate the result for Armla for the current combination
    p.site_2.armla_result <- ((mass.hok2.present.df[mass.hok2.present.df$ayres.tree == Aa_column, "perc.mass_loss"]) / 
                     (mass.hok2.present.df[mass.hok2.present.df$ayres.tree == Aa_column, "perc.mass_loss"] + 
                      mass.hok2.present.df[mass.hok2.present.df$ayres.tree == Ba_column, "perc.mass_loss"])) * 100

    # Print the Armla equation for verification
    cat("Armla Equation: (", Aa_column, "/(", Aa_column, "+", Ba_column, ")) * 100 = ", p.site_2.armla_result, "\n")

    # Create a new name for the results
    armla_name <- paste("Armla", X, Y, sep = ".")
    
    # Extract the treatment from mass.hok1.present.df for the current combination
    treatment_name <- mass.hok2.present.df[mass.hok2.present.df$ayres.tree == Aa_column, "treatment"]

    # Append the names and values to the respective vectors for Armla
    names_vector_armla <- c(names_vector_armla, armla_name)
    values_vector_armla <- c(values_vector_armla, p.site_2.armla_result)
    treatment_vector_armla <- c(treatment_vector_armla, treatment_name)
    # Print the Armla dataframe
print("Armla DataFrame:")
print(p.site_2.armla_result)

  }
}

# Create dataframe for Armla

p.site_2.armla_df <- data.frame(names = names_vector_armla, values = values_vector_armla, treatment = treatment_vector_armla)

# Initialize empty vectors to store names and values for Brmla
names_vector_brmla <- character(0)
values_vector_brmla <- numeric(0)
treatment_vector_brmla <- character(0)

# Loop through all combinations of X and Y for Aa and Ba for Brmla
for (X in X_values) {
  for (Y in Y_values) {
    Ba_column <- paste("Ba.", X, sep = "")
    Aa_column <- paste("Aa.", Y, sep = "")
    
    # Print the current combination for verification
    cat("Calculating Brmla for Ba_column =", Ba_column, "and Aa_column =", Aa_column, "\n")

    # Calculate the result for Brmla for the current combination
    p.site_2.brmla_result <- ((mass.hok2.present.df[mass.hok2.present.df$ayres.tree == Ba_column, "perc.mass_loss"]) / 
                     (mass.hok2.present.df[mass.hok2.present.df$ayres.tree == Ba_column, "perc.mass_loss"] + 
                      mass.hok2.present.df[mass.hok2.present.df$ayres.tree == Aa_column, "perc.mass_loss"])) * 100

    # Print the Brmla equation for verification
    cat("Brmla Equation: (", Ba_column, "/(", Ba_column, "+", Aa_column, ")) * 100 = ", p.site_2.brmla_result, "\n")

    # Create a new name for the results
    brmla_name <- paste("Brmla", X, Y, sep = ".")
    
    # Extract the treatment from mass.hok2.present.df for the current combination
    treatment_name <- mass.hok2.present.df[mass.hok2.present.df$ayres.tree == Ba_column, "treatment"]

    # Append the names and values to the respective vectors for Brmla
    names_vector_brmla <- c(names_vector_brmla, brmla_name)
    values_vector_brmla <- c(values_vector_brmla, p.site_2.brmla_result)
    treatment_vector_brmla <- c(treatment_vector_brmla, treatment_name)
    
       # Print the Armla dataframe
print("Brmla DataFrame:")
print(p.site_2.brmla_result)

  }
}

# Create dataframe for Brmla
p.site_2.brmla_df <- data.frame(names = names_vector_brmla, values = values_vector_brmla, treatment = treatment_vector_brmla)

# Merge the dataframes for Armla and Brmla
p.site_2.armla.brmla_df <- rbind(p.site_2.armla_df, p.site_2.brmla_df)

```


Updated 12/12/23: generate **absent**, site a (HOK 2)
```{r}
########################
mass.hok2.absent.df <- mass.hok2.absent.df %>%
  mutate(ayres = ifelse(hfa == "H", "Aa", ifelse(hfa == "A", "Ba", NA)))
  #since we're at site a, the notation follows species A at a (Aa) or species B at a (Ba)

# Create a new column combining tree_num and ayres with a period in between
mass.hok2.absent.df$ayres.tree <- paste(mass.hok2.absent.df$ayres, mass.hok2.absent.df$tree_num, sep = ".")

# Define the range for X and Y (1 to 5)
X_values <- 1:5
Y_values <- 1:5

# Initialize empty vectors to store names and values for Armla
names_vector_armla <- character(0)
values_vector_armla <- numeric(0)
treatment_vector_armla <- character(0)

# Loop through all combinations of X and Y for Aa and Ba for Armla
for (X in X_values) {
  for (Y in Y_values) {
    Aa_column <- paste("Aa.", X, sep = "")
    Ba_column <- paste("Ba.", Y, sep = "")
    
    # Print the current combination for verification
    cat("Calculating Armla for Aa_column =", Aa_column, "and Ba_column =", Ba_column, "\n")

    # Calculate the result for Armla for the current combination
    ab.site_2.armla_result <- ((mass.hok2.absent.df[mass.hok2.absent.df$ayres.tree == Aa_column, "perc.mass_loss"]) / 
                     (mass.hok2.absent.df[mass.hok2.absent.df$ayres.tree == Aa_column, "perc.mass_loss"] + 
                      mass.hok2.absent.df[mass.hok2.absent.df$ayres.tree == Ba_column, "perc.mass_loss"])) * 100

    # Print the Armla equation for verification
    cat("Armla Equation: (", Aa_column, "/(", Aa_column, "+", Ba_column, ")) * 100 = ", ab.site_2.armla_result, "\n")

    # Create a new name for the results
    armla_name <- paste("Armla", X, Y, sep = ".")
    
    # Extract the treatment from mass.hok1.present.df for the current combination
    treatment_name <- mass.hok2.absent.df[mass.hok2.absent.df$ayres.tree == Aa_column, "treatment"]

    # Append the names and values to the respective vectors for Armla
    names_vector_armla <- c(names_vector_armla, armla_name)
    values_vector_armla <- c(values_vector_armla, ab.site_2.armla_result)
    treatment_vector_armla <- c(treatment_vector_armla, treatment_name)
    # Print the Armla dataframe
print("Armla DataFrame:")
print(ab.site_2.armla_result)

  }
}

# Create dataframe for Armla

ab.site_2.armla_df <- data.frame(names = names_vector_armla, values = values_vector_armla, treatment = treatment_vector_armla)

# Initialize empty vectors to store names and values for Brmla
names_vector_brmla <- character(0)
values_vector_brmla <- numeric(0)
treatment_vector_brmla <- character(0)

# Loop through all combinations of X and Y for Aa and Ba for Brmla
for (X in X_values) {
  for (Y in Y_values) {
    Ba_column <- paste("Ba.", X, sep = "")
    Aa_column <- paste("Aa.", Y, sep = "")
    
    # Print the current combination for verification
    cat("Calculating Brmla for Ba_column =", Ba_column, "and Aa_column =", Aa_column, "\n")

    # Calculate the result for Brmla for the current combination
    ab.site_2.brmla_result <- ((mass.hok2.absent.df[mass.hok2.absent.df$ayres.tree == Ba_column, "perc.mass_loss"]) / 
                     (mass.hok2.absent.df[mass.hok2.absent.df$ayres.tree == Ba_column, "perc.mass_loss"] + 
                      mass.hok2.absent.df[mass.hok2.absent.df$ayres.tree == Aa_column, "perc.mass_loss"])) * 100

    # Print the Brmla equation for verification
    cat("Brmla Equation: (", Ba_column, "/(", Ba_column, "+", Aa_column, ")) * 100 = ", ab.site_2.brmla_result, "\n")

    # Create a new name for the results
    brmla_name <- paste("Brmla", X, Y, sep = ".")
    
    # Extract the treatment from mass.hok2.present.df for the current combination
    treatment_name <- mass.hok2.absent.df[mass.hok2.absent.df$ayres.tree == Ba_column, "treatment"]

    # Append the names and values to the respective vectors for Brmla
    names_vector_brmla <- c(names_vector_brmla, brmla_name)
    values_vector_brmla <- c(values_vector_brmla, ab.site_2.brmla_result)
    treatment_vector_brmla <- c(treatment_vector_brmla, treatment_name)
    
       # Print the Armla dataframe
print("Brmla DataFrame:")
print(ab.site_2.brmla_result)

  }
}

# Create dataframe for Brmla
ab.site_2.brmla_df <- data.frame(names = names_vector_brmla, values = values_vector_brmla, treatment = treatment_vector_brmla)

# Merge the dataframes for Armla and Brmla
ab.site_2.armla.brmla_df <- rbind(ab.site_2.armla_df, ab.site_2.brmla_df)

```


Updated 12/12/23: generate **present**, site b (SEK 2)
```{r}
########################
mass.sek2.present.df <- mass.sek2.present.df %>%
  mutate(ayres = ifelse(hfa == "H", "Bb", ifelse(hfa == "A", "Ab", NA)))
  #since we're at site a, the notation follows species A at a (Aa) or species B at a (Ba)

# Create a new column combining tree_num and ayres with a period in between
mass.sek2.present.df$ayres.tree <- paste(mass.sek2.present.df$ayres, mass.sek2.present.df$tree_num, sep = ".")

# Define the range for X and Y (1 to 5)
X_values <- 1:5
Y_values <- 1:5

# Initialize empty vectors to store names and values for Armla
names_vector_brmlb <- character(0)
values_vector_brmlb <- numeric(0)
treatment_vector_brmlb <- character(0)

# Loop through all combinations of X and Y for Aa and Ba for Armla
for (X in X_values) {
  for (Y in Y_values) {
    Bb_column <- paste("Bb.", X, sep = "")
    Ab_column <- paste("Ab.", Y, sep = "")
    
    # Print the current combination for verification
    cat("Calculating Brmlb for Bb_column =", Bb_column, "and Ab_column =", Ab_column, "\n")

    # Calculate the result for Armla for the current combination
    p.site_2.brmlb_result <- ((mass.sek2.present.df[mass.sek2.present.df$ayres.tree == Bb_column, "perc.mass_loss"]) / 
                     (mass.sek2.present.df[mass.sek2.present.df$ayres.tree == Bb_column, "perc.mass_loss"] + 
                      mass.sek2.present.df[mass.sek2.present.df$ayres.tree == Ab_column, "perc.mass_loss"])) * 100

    # Print the Armla equation for verification
    cat("Brmlb Equation: (", Bb_column, "/(", Bb_column, "+", Ab_column, ")) * 100 = ", p.site_2.brmlb_result, "\n")

    # Create a new name for the results
    brmlb_name <- paste("Brmlb", X, Y, sep = ".")
    
    # Extract the treatment from mass.hok1.present.df for the current combination
    treatment_name <- mass.sek2.present.df[mass.sek2.present.df$ayres.tree == Bb_column, "treatment"]

    # Append the names and values to the respective vectors for Armla
    names_vector_brmlb <- c(names_vector_brmlb, brmlb_name)
    values_vector_brmlb <- c(values_vector_brmlb, p.site_2.brmlb_result)
    treatment_vector_brmlb <- c(treatment_vector_brmlb, treatment_name)
    # Print the Armla dataframe
print("Brmlb DataFrame:")
print(p.site_2.brmlb_result)

  }
}

# Create dataframe for Armla

p.site_2.brmlb_df <- data.frame(names = names_vector_brmlb, values = values_vector_brmlb, treatment = treatment_vector_brmlb)

# Initialize empty vectors to store names and values for Brmla
names_vector_armlb <- character(0)
values_vector_armlb <- numeric(0)
treatment_vector_armlb <- character(0)

# Loop through all combinations of X and Y for Aa and Ba for Brmla
for (X in X_values) {
  for (Y in Y_values) {
    Ab_column <- paste("Ab.", X, sep = "")
    Bb_column <- paste("Bb.", Y, sep = "")
    
    # Print the current combination for verification
    cat("Calculating Armlb for Ab_column =", Ab_column, "and Bb_column =", Bb_column, "\n")

    # Calculate the result for Brmla for the current combination
    p.site_2.armlb_result <- ((mass.sek2.present.df[mass.sek2.present.df$ayres.tree == Ab_column, "perc.mass_loss"]) / 
                     (mass.sek2.present.df[mass.sek2.present.df$ayres.tree == Ab_column, "perc.mass_loss"] + 
                      mass.sek2.present.df[mass.sek2.present.df$ayres.tree == Bb_column, "perc.mass_loss"])) * 100

    # Print the Brmla equation for verification
    cat("Armlb Equation: (", Ab_column, "/(", Ab_column, "+", Bb_column, ")) * 100 = ", p.site_2.armlb_result, "\n")

    # Create a new name for the results
    armlb_name <- paste("Armlb", X, Y, sep = ".")
    
    # Extract the treatment from mass.hok2.present.df for the current combination
    treatment_name <- mass.sek2.present.df[mass.sek2.present.df$ayres.tree == Ab_column, "treatment"]

    # Append the names and values to the respective vectors for Brmla
    names_vector_armlb <- c(names_vector_armlb, armlb_name)
    values_vector_armlb <- c(values_vector_armlb, p.site_2.armlb_result)
    treatment_vector_armlb <- c(treatment_vector_armlb, treatment_name)
    
       # Print the Armla dataframe
print("Armlb DataFrame:")
print(p.site_2.armlb_result)

  }
}

# Create dataframe for Brmla
p.site_2.armlb_df <- data.frame(names = names_vector_armlb, values = values_vector_armlb, treatment = treatment_vector_armlb)

# Merge the dataframes for Armla and Brmla
p.site_2.brmlb.armlb_df <- rbind(p.site_2.brmlb_df, p.site_2.armlb_df)

```


Updated 12/12/23: generate **absent**, site b (SEK 2)
```{r}
########################
mass.sek2.absent.df <- mass.sek2.absent.df %>%
  mutate(ayres = ifelse(hfa == "H", "Bb", ifelse(hfa == "A", "Ab", NA)))
  #since we're at site a, the notation follows species A at a (Aa) or species B at a (Ba)

# Create a new column combining tree_num and ayres with a period in between
mass.sek2.absent.df$ayres.tree <- paste(mass.sek2.absent.df$ayres, mass.sek2.absent.df$tree_num, sep = ".")

# Define the range for X and Y (1 to 5)
X_values <- 1:5
Y_values <- 1:5

# Initialize empty vectors to store names and values for Armla
names_vector_brmlb <- character(0)
values_vector_brmlb <- numeric(0)
treatment_vector_brmlb <- character(0)

# Loop through all combinations of X and Y for Aa and Ba for Armla
for (X in X_values) {
  for (Y in Y_values) {
    Bb_column <- paste("Bb.", X, sep = "")
    Ab_column <- paste("Ab.", Y, sep = "")
    
    # Print the current combination for verification
    cat("Calculating Brmlb for Bb_column =", Bb_column, "and Ab_column =", Ab_column, "\n")

    # Calculate the result for Armla for the current combination
    ab.site_2.brmlb_result <- ((mass.sek2.absent.df[mass.sek2.absent.df$ayres.tree == Bb_column, "perc.mass_loss"]) / 
                     (mass.sek2.absent.df[mass.sek2.absent.df$ayres.tree == Bb_column, "perc.mass_loss"] + 
                      mass.sek2.absent.df[mass.sek2.absent.df$ayres.tree == Ab_column, "perc.mass_loss"])) * 100

    # Print the Armla equation for verification
    cat("Brmlb Equation: (", Bb_column, "/(", Bb_column, "+", Ab_column, ")) * 100 = ", ab.site_2.brmlb_result, "\n")

    # Create a new name for the results
    brmlb_name <- paste("Brmlb", X, Y, sep = ".")
    
    # Extract the treatment from mass.hok1.present.df for the current combination
    treatment_name <- mass.sek2.absent.df[mass.sek2.absent.df$ayres.tree == Bb_column, "treatment"]

    # Append the names and values to the respective vectors for Armla
    names_vector_brmlb <- c(names_vector_brmlb, brmlb_name)
    values_vector_brmlb <- c(values_vector_brmlb, ab.site_2.brmlb_result)
    treatment_vector_brmlb <- c(treatment_vector_brmlb, treatment_name)
    # Print the Armla dataframe
print("Brmlb DataFrame:")
print(ab.site_2.brmlb_result)

  }
}

# Create dataframe for Armla

ab.site_2.brmlb_df <- data.frame(names = names_vector_brmlb, values = values_vector_brmlb, treatment = treatment_vector_brmlb)

# Initialize empty vectors to store names and values for Brmla
names_vector_armlb <- character(0)
values_vector_armlb <- numeric(0)
treatment_vector_armlb <- character(0)

# Loop through all combinations of X and Y for Aa and Ba for Brmla
for (X in X_values) {
  for (Y in Y_values) {
    Ab_column <- paste("Ab.", X, sep = "")
    Bb_column <- paste("Bb.", Y, sep = "")
    
    # Print the current combination for verification
    cat("Calculating Armlb for Ab_column =", Ab_column, "and Bb_column =", Bb_column, "\n")

    # Calculate the result for Brmla for the current combination
    ab.site_2.armlb_result <- ((mass.sek2.absent.df[mass.sek2.absent.df$ayres.tree == Ab_column, "perc.mass_loss"]) / 
                     (mass.sek2.absent.df[mass.sek2.absent.df$ayres.tree == Ab_column, "perc.mass_loss"] + 
                      mass.sek2.absent.df[mass.sek2.absent.df$ayres.tree == Bb_column, "perc.mass_loss"])) * 100

    # Print the Brmla equation for verification
    cat("Armlb Equation: (", Ab_column, "/(", Ab_column, "+", Bb_column, ")) * 100 = ", ab.site_2.armlb_result, "\n")

    # Create a new name for the results
    armlb_name <- paste("Armlb", X, Y, sep = ".")
    
    # Extract the treatment from mass.hok2.present.df for the current combination
    treatment_name <- mass.sek2.absent.df[mass.sek2.absent.df$ayres.tree == Ab_column, "treatment"]

    # Append the names and values to the respective vectors for Brmla
    names_vector_armlb <- c(names_vector_armlb, armlb_name)
    values_vector_armlb <- c(values_vector_armlb, ab.site_2.armlb_result)
    treatment_vector_armlb <- c(treatment_vector_armlb, treatment_name)
    
       # Print the Armla dataframe
print("Armlb DataFrame:")
print(ab.site_2.armlb_result)

  }
}

# Create dataframe for Brmla
ab.site_2.armlb_df <- data.frame(names = names_vector_armlb, values = values_vector_armlb, treatment = treatment_vector_armlb)

# Merge the dataframes for Armla and Brmla
ab.site_2.brmlb.armlb_df <- rbind(ab.site_2.brmlb_df, ab.site_2.armlb_df)

```


updated 12/12/23: merge **present**, site a and b (aka HOK 2 and SEK 2) dataframes 
```{r}
#merge both present site 1 dataframes
mass.present.site2.df=rbind(p.site_2.armla.brmla_df, p.site_2.brmlb.armlb_df)
mass.present.site2.df
# Define the range for X and Y (1 to 5)
X_values <- 1:5
Y_values <- 1:5

# Create an empty dataframe to store the results
result_df_2 <- data.frame(names = character(0), values = numeric(0), treatment = character(0))

# Loop through all combinations of X and Y for Armla, Brmla, Brmlb, and Armlb
for (X in X_values) {
  for (Y in Y_values) {
    armla_name <- paste("Armla.", X, ".", Y, sep = "")
    brmla_name <- paste("Brmla.", X, ".", Y, sep = "")
    brmlb_name <- paste("Brmlb.", X, ".", Y, sep = "")
    armlb_name <- paste("Armlb.", X, ".", Y, sep = "")
    
    # Calculate the result for the current combination
    result <- 
((
  (mass.present.site2.df[mass.present.site2.df$names == armla_name, "values"] +
      mass.present.site2.df[mass.present.site2.df$names == brmlb_name, "values"])/2)/ (
      (mass.present.site2.df[mass.present.site2.df$names == armlb_name, "values"] +
      mass.present.site2.df[mass.present.site2.df$names == brmla_name, "values"])/2
    )*100
)-100
     # Create a new name (letter) for the result
    result_name <- paste0(LETTERS[(X - 1) * 5 + Y], "_2")
    
  # Get the treatment for the current combination
    treatment_name <- mass.present.site2.df[mass.present.site2.df$names == armla_name, "treatment"]
 
# Append the name and value to the result dataframe
    result_df_2 <- rbind(result_df_2, data.frame(names = result_name, values = result, treatment= treatment_name))  }
}


# View the resulting dataframe

print(result_df_2)



```


NEW: use this! merging HOK 2 and SEK 2 dataframe
merge **absent**, merging HOK 2 and SEK 2 dataframe
```{r}
#merge both present site 1 dataframes
mass.absent.site2.df=rbind(ab.site_2.armla.brmla_df, ab.site_2.brmlb.armlb_df)
mass.absent.site2.df
# Define the range for X and Y (1 to 5)
X_values <- 1:5
Y_values <- 1:5

# Create an empty dataframe to store the results
result_ab_df_2 <- data.frame(names = character(0), values = numeric(0), treatment = character(0))

# Loop through all combinations of X and Y for Armla, Brmla, Brmlb, and Armlb
for (X in X_values) {
  for (Y in Y_values) {
    armla_name <- paste("Armla.", X, ".", Y, sep = "")
    brmla_name <- paste("Brmla.", X, ".", Y, sep = "")
    brmlb_name <- paste("Brmlb.", X, ".", Y, sep = "")
    armlb_name <- paste("Armlb.", X, ".", Y, sep = "")
    
    # Calculate the result for the current combination
    result <- 
((
  (mass.absent.site2.df[mass.absent.site2.df$names == armla_name, "values"] +
      mass.absent.site2.df[mass.absent.site2.df$names == brmlb_name, "values"])/2)/ (
      (mass.absent.site2.df[mass.absent.site2.df$names == armlb_name, "values"] +
      mass.absent.site2.df[mass.absent.site2.df$names == brmla_name, "values"])/2
    )*100
)-100
     # Create a new name (letter) for the result
    result_name <- paste0(LETTERS[(X - 1) * 5 + Y], "_3")
    
  # Get the treatment for the current combination
    treatment_name <- mass.absent.site2.df[mass.absent.site2.df$names == armla_name, "treatment"]
 
# Append the name and value to the result dataframe
    result_ab_df_2 <- rbind(result_ab_df_2, data.frame(names = result_name, values = result, treatment= treatment_name))  }
}


# View the resulting dataframe
result_ab_df_2

```


NEW: use this! merging all dataframes (Sites 1 and 2; includes P and AB)
merge all sites; HFAI plots
```{r}
#combine sites 1 and 2 including P and AB
hfai.allsites.df=rbind(result_df_1, result_df_2, result_ab_df_1, result_ab_df_2)
hfai.allsites.df$treatment=as.factor(hfai.allsites.df$treatment)
hfai.allsites.df

#new HFA fig format
hfa.fig.formatting <- theme_classic() +
  theme(
    text = element_text(size = 25),
    legend.text.align = 0,
    panel.border = element_rect(fill = NA, colour = "black", size = 1),
    aspect.ratio = 1,
    axis.ticks.length.y = unit(0.25, "cm"),
    axis.text.y = element_text(margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour = "black", size = 20),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()  # Add this line to remove x-axis ticks
  ) +
  theme(legend.key.size = unit(0.4, "cm"), legend.position = "right") +
  theme(aspect.ratio = 0.4)+
  theme( plot.margin = margin(r = 1 ))

```


5/7/24 explore the data with NEW stat knowledge
```{r}
hfai.allsites.plot

hfai.allsites.plot


min(hfai.allsites_removed$values)
   
   hfai.allsites.df%>%
     pull(values)%>%
     range()

ggsave("figures/hfai.allsites.plot.pdf", hfai.allsites.plot, width = 8, height = 6)

#normality
hist(hfai.allsites.df[hfai.allsites.df$treatment=="P",]$values)
hist(hfai.allsites.df[hfai.allsites.df$treatment=="AB",]$values)
#subset by treatment
present<- hfai.allsites.df[hfai.allsites.df$treatment=="P",]$values
absent<- hfai.allsites.df[hfai.allsites.df$treatment=="AB",]$values
#normality
normalTest(present, method = "da")
#model
m1<- lm(values ~ treatment, data = hfai.allsites.df)
plot(m1)

#transform
hist((present))

log2(mean(present)/mean(absent))

hfai.allsites.df<- hfai.allsites.df %>%
   group_by(treatment)%>%
  mutate(trans.val = log2(values))

hfai.allsites.df %>%
   group_by(treatment)%>%
  mutate(fold.change = log2(treatment == "P", values)- log2(treatment == "AB", values))
 
 hfai.allsites.df %>%
  ggplot(aes(x = treatment, y = trans.val, color = treatment, fill = treatment)) +
  geom_violin(width= 0.4, alpha = 0.4) +
  geom_point(alpha = 0.3, position = position_jitter(width = 0.1), size = 2) +  stat_summary(fun = mean, geom = "point", shape = 23, size = 3, color = "black", position = position_dodge(width = 0.4)) +
  scale_color_manual(values = c("#CC79A7", "#009E73"), labels = c("absent", "present")) +
  scale_fill_manual(values = c("#CC79A7", "#009E73"), labels = c("absent", "present")) +
  xlab("") +
  ylab("magnitude of decomposition at home (%)") +
  theme_bw() +
  theme(axis.text = element_text(size = 12)) +
  theme(legend.position = "right") +
   theme(plot.margin = unit(c(2, 2, 2, 2), "lines"))



#remove outliers based on leverage
hfai.allsites_removed<-hfai.allsites.df[-c(26, 27, 28,29, 30), ]
#normality
present_rm<- hfai.allsites_removed[hfai.allsites_removed$treatment=="P",]$values
absent_rm<- hfai.allsites_removed[hfai.allsites_removed$treatment=="AB",]$values
normalTest(present_rm, method = "da")
#removed model
m1<- lm(values ~ treatment, data = hfai.allsites_removed)
plot(m1)
summary(m1)
#means
mean_p<- mean(present_rm)
mean_ab<- mean(absent_rm)

mean(hfai.allsites_removed$values)
sd(hfai.allsites_removed$values)
hist(hfai.allsites_removed$values)

#plot
hfai.allsites_removed.plot<- hfai.allsites_removed %>%
  filter(!is.na(values)) %>%
ggplot(aes(x = treatment, y = values, color = treatment, shape = treatment)) +
    stat_summary(fun = "mean", geom = "point", size = 6, position = position_dodge(width = 0.5)) +
  stat_summary(fun.data = "mean_cl_normal", geom = "errorbar", width = 0.2, position = position_dodge(width = 0.5), size = 1.2) +
  scale_color_manual(values = c("AB" = "black", "P" = "grey60"), labels = c("absent", "present")) +
    scale_shape_manual(values = c("AB" = 17, "P" = 16), labels = c("absent", "present")) +
geom_hline(aes(yintercept = 0), color = "red3", linetype = "dashed") +
   labs(x = "Treatment", y = "Magnitude of decomposition (%)", color = "Treatment", shape = "Treatment" ) +
  guides(color = guide_legend(override.aes = list(shape = c(17, 16))))+
    scale_y_continuous(breaks = seq(-20, 20, by = 5))+
  theme_bw() +
  theme(axis.text = element_text(size = 18),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18))
  
 hfai.allsites_removed %>%
  filter(treatment == "P") %>%
  summarise(
    mean_value = mean(values, na.rm = TRUE),
    lower_ci = mean_cl_normal(values)$ymin,
    upper_ci = mean_cl_normal(values)$ymax
  )
 
# Filter the data for treatment "P"
filtered_data <- hfai.allsites_removed %>%
  filter(treatment == "AB") %>%
  pull(values)

# Calculate the mean
mean<- mean(filtered_data, na.rm = TRUE)

# Calculate the standard deviation
sd_value <- sd(filtered_data, na.rm = TRUE)

# Calculate the standard error
n <- length(filtered_data<0)
se <- sd_value / sqrt(n)

group_P <- hfai.allsites_removed$values[hfai.allsites_removed$treatment == "P"]
group_AB <- hfai.allsites_removed$values[hfai.allsites_removed$treatment == "AB"]

# Perform the t-test
t.test(group_P, group_AB)





hfai.allsites.plot

ggsave("figures/hfai.allsites_removed.plot.png", hfai.allsites_removed.plot, width = 8, height = 6)



```


P only HFAI analysis
```{r}
####################  P ONLY ###################
#filter P treatment only for HFA effect
hfai.present.allsites.df=hfai.allsites.df%>%
  filter(treatment == "P")

# Filter the dataframe to include only positive cases
positive_present_df <- hfai.present.allsites.df[hfai.present.allsites.df$values > 0, ]

# Calculate the mean and standard error (SE)
mean_hfa <- mean(positive_present_df$values)
se_hfa <- sd(positive_present_df$values) / sqrt(nrow(positive_present_df))
# Perform a t-test
t_test_present_result <- t.test(positive_present_df$values, mu = 0)
t_test_present_result



# Format the t-test result
t_test_label <- paste("p =", formatC(t_test_present_result$p.value, format = "e", digits = 2), ",", "t-test =", round(t_test_present_result$statistic, 2))
# Format the t-test result
p_value <- t_test_present_result$p.value
formatted_p_value <- if (p_value < 0.0001) {
  "p < 0.0001"
} else {
  paste("p =", formatC(p_value, digits = 1))
}


#positive and negative values
total_positive <- sum(hfai.present.allsites.df$values > 0)
total_negative <- sum(hfai.present.allsites.df$values < 0)
# Calculate the percentage of positive values relative to negative
percentage_positive <- (total_positive / (total_positive + total_negative)) * 100
percentage_negative <- (total_negative / (total_negative + total_positive)) * 100
# 72% positive
# 28% negative
```

Plot P only
```{r}


#just P treatment
hfai.present.allsites.plot
ggplot(hfai.present.allsites.df, aes(x = reorder(names, values), y = values, fill = treatment)) +
scale_fill_manual(values = c("#E69F00"))+
geom_bar(stat = "identity", position ="dodge", alpha = 0.5) +
  xlab("") +
  ylab("% faster decomposition at home") +
  geom_vline(xintercept = 14.5, linetype = "dashed", color = "red")+
  scale_x_discrete(expand=c(0.02,0.02))+
  hfa.fig.formatting

hfai.present.allsites.plot

ggsave("figures/hfai.present.allsites.plot.pdf", hfai.present.allsites.plot, width = 14, height = 6)

#just P treatment with coord_flip
ggplot(hfai.present.allsites.df, aes(x = reorder(names, values), y = values, fill = treatment)) +
  scale_fill_manual(values = "grey")+
  geom_bar(stat = "identity", position ="dodge", alpha = 0.5) +
  coord_flip()+
  xlab("") +
  ylab("% faster decomposition at home") +
  theme_minimal() +
  theme(text = element_text(size =20), 
    axis.text.y = element_blank(),
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    plot.background = element_blank())+
  geom_vline(xintercept = 14.5, linetype = "dashed", color = "red") 



```

P and AB HFAI analysis
```{r}
######################### BOTH P and AB #########################################

# Filter the dataframe to include only positive cases
positive_values <- hfai.allsites.df %>%
  filter(values > 0)

#calcualte mean HFA for P
mean_positive_P <- mean(hfai.allsites.df[hfai.allsites.df$treatment == "P",]$values)
se_positive_P <- sd(hfai.allsites.df[hfai.allsites.df$treatment == "P",]$values) / sqrt(nrow(hfai.allsites.df[hfai.allsites.df$treatment == "P",]))
# mean = 23.31, se = 5.22

#t test for P
t_test_P <- t.test(positive_values[positive_values$treatment == "P",]$values, mu = 0)

#calcualte mean HFA for AB
mean_positive_AB <- mean(hfai.allsites.df[hfai.allsites.df$treatment == "AB",]$values)
se_positive_AB <- sd(hfai.allsites.df[hfai.allsites.df$treatment == "AB",]$values) / sqrt(nrow(hfai.allsites.df[hfai.allsites.df$treatment == "AB",]))
# mean = -10.53, se = 2.52

((23.31+(-10.53))
  /(23.31))*100

t_test_AB <- t.test(positive_values[positive_values$treatment == "AB",]$values, mu = 0)

#means for P vs AB
hfai.allsites.df%>%
  filter(values > 0)%>%
  ggplot(aes(x = treatment, y=values))+
  geom_boxplot()

t_test <- t.test(hfai.allsites.df[hfai.allsites.df$treatment == "P",]$values, hfai.allsites.df[hfai.allsites.df$treatment == "AB",]$values)

t_test <- t.test(hfai.allsites.df[hfai.allsites.df$treatment == "AB",]$values, mu= 0)


hfai.allsites.df%>%
  filter(treatment == "P")%>%
  summarise(sd = sd(values))

#calculate % HFA
hfai.allsites.df%>%
  filter(treatment == "P", values < 0)%>%
n_distinct()

#total = 100, HFA: P values > 0 = 41, AB values > 0 = 14

#41 Present pos HFA so 41%
#14 Absent pos HFA so 14%

#9 Present neg HFA so 9%
#36 absent neg HFA so 36%





41+9+14+36


#positive and negative values
total_pos_P <- sum(hfai.allsites.df$values > 0 & hfai.allsites.df$treatment =="P")
total_pos_AB <- sum(hfai.allsites.df$values > 0 & hfai.allsites.df$treatment =="AB")

total_neg_P <- sum(hfai.allsites.df$values < 0 & hfai.allsites.df$treatment =="P")

total_neg_AB <- sum(hfai.allsites.df$values < 0 & hfai.allsites.df$treatment =="AB")


total <- sum(hfai.allsites.df$values)
total_neg <- sum(hfai.allsites.df$values < 0)

# Calculate the percentage of positive values relative to negative
percentage_pos_P <- ((total_pos_P) / ( total))* 100
percentage_pos_AB <- (total_pos_AB / ( total)) * 100

percentage_neg_P <- (total_neg_P / ( total)) * 100
percentage_eg_AB <- (total_neg_AB / ( total)) * 100

percentage_negative <- (total_negative / (total_negative + total_positive)) * 100

# 53% positive
# 47% negative

library(lsr)
cohensD((hfai.allsites.df$values > 0 & hfai.allsites.df$treatment =="P") ~ (hfai.allsites.df$values > 0 & hfai.allsites.df$treatment =="AB"))

t.test((positive_values[positive_values$treatment == "P",]$values), (positive_values[positive_values$treatment == "AB",]$values))

range(positive_values[positive_values$treatment == "P",]$values)


```


12/14/23: updated HFAI above, this is the final fig
```{r}
#all sites
range(hfai.allsites.df$values)

hfai.allsites.plot=hfai.allsites.df%>%
  filter(!is.na(values)) %>%
  ggplot(aes(x = reorder(names, values), y = values, fill = treatment, width = 0.85)) +
scale_fill_manual(values  = c("#CC79A7", "#009E73"))+
geom_bar(stat = "identity", position ="dodge", alpha = 0.7) +
  xlab("") +
  ylab("% faster decomposition at home") +
  theme_minimal() +
    scale_x_discrete(expand = c(0.01,0.01))+
  geom_vline(xintercept = 44.5 , linetype = "dashed", color = "red")+
  hfa.fig.formatting


hfai.allsites.df %>%
 filter(!is.na(values)) %>%
  ggplot(aes(x = names, y = values, color = treatment, fill=treatment)) +
  geom_point() +
  geom_smooth(method = "loess", span = 0.75, alpha = 0.5, aes(group = treatment)) +
  scale_color_manual(values = c("#CC79A7", "#009E73")) +
   scale_fill_manual(values = c("#CC79A7", "#009E73")) +
  scale_x_discrete(labels = NULL)+
  xlab("") +
  ylab("% Faster Decomposition at Home") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(axis.text = element_text(size = 12)) +
  theme(legend.position = "top") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red")


hfai.allsites.df %>%
  filter(!is.na(values)) %>%
  ggplot(aes(x = treatment, y = values, color = treatment, fill = treatment)) +
  geom_boxplot(width= 0.4, alpha = 0.4) +
  geom_point(alpha = 0.3, position = position_jitter(width = 0.1), size = 2) +  stat_summary(fun = mean, geom = "point", shape = 23, size = 3, color = "black", position = position_dodge(width = 0.4)) +
  scale_color_manual(values = c("#CC79A7", "#009E73")) +
  scale_fill_manual(values = c("#CC79A7", "#009E73")) +
  xlab("") +
  ylab("% Faster Decomposition at Home") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +  # Rotate x-axis labels
  theme(axis.text = element_text(size = 12)) +
  theme(legend.position = "top") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red")



hfai.allsites.df %>%
  filter(!is.na(values)) %>%
  filter(values<180) %>%
  ggplot(aes(x = treatment, y = values, color = treatment, fill = treatment)) +
  geom_violin(width= 0.4, alpha = 0.4) +
  geom_point(alpha = 0.3, position = position_jitter(width = 0.1), size = 2) +  stat_summary(fun = mean, geom = "point", shape = 23, size = 3, color = "black", position = position_dodge(width = 0.4)) +
  scale_color_manual(values = c("#CC79A7", "#009E73"), labels = c("absent", "present")) +
  scale_fill_manual(values = c("#CC79A7", "#009E73"), labels = c("absent", "present")) +
  xlab("") +
  ylab("magnitude of decomposition at home (%)") +
  theme_bw() +
  theme(axis.text = element_text(size = 12)) +
  theme(legend.position = "right") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red")+ theme(plot.margin = unit(c(2, 2, 2, 2), "lines"))

hfai.allsites.plot

filter(values<180)
hfai.allsites.plot
hfai.allsites.df %>%
  filter(!is.na(values)) %>%
ggplot(aes(x = treatment, y = values, color = treatment, shape = treatment)) +
  stat_summary(fun = mean, geom = "point", size = 6, position = position_dodge(width = 0.5)) +
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.4, position = position_dodge(width = 0.5), size = 1.2) +
  scale_color_manual(values = c("AB" = "black", "P" = "grey60"), labels = c("absent", "present")) +
    scale_shape_manual(values = c("AB" = 17, "P" = 16), labels = c("absent", "present")) +
geom_hline(aes(yintercept = mean(values)), color = "red3", linetype = "dashed") +
   labs(x = "treatment", y = "magnitude of decomposition (%)") +
  guides(color = guide_legend(override.aes = list(shape = c(17, 16))))+
  theme_bw() +
  theme(axis.text = element_text(size = 18),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18))

hfai.allsites.plot


min(hfai.allsites_removed$values)
   
   hfai.allsites.df%>%
     pull(values)%>%
     range()

ggsave("figures/hfai.allsites.plot.pdf", hfai.allsites.plot, width = 8, height = 6)

summary(hfai.allsites_removed)



```


Alder secondary metabolites from LC-MS
### Import LC-MS/MS data
```{r}
#installing and calling the necessary packages:
library(mixOmics)
library(ggpubr)
library(vegan)

### load negative mode
neg_data <- read_csv("/Users/cjspiegel/Desktop/Projects/rad_alder/lcms/Negative/Day_0/NEG_day0_trans_quant.csv") %>% arrange(Sample)
View(neg_data)
neg_metadata <- read_csv("/Users/cjspiegel/Desktop/Projects/rad_alder/lcms/Negative/Day_0/RAD_prelim_metadata_negative_rstudio.csv") %>% arrange(Sample)
all(neg_data$Sample == neg_metadata$Sample)

#merge
neg_merged.df<- merge(neg_data,neg_metadata, by = "Sample")

### load positive mode
pos_data <- read_csv("/Users/Cody1/Desktop/Projects/RAD Alder/LC-MS/RAD_positive_mode_11_3_2023_quant_copy.csv") %>% arrange(Sample)
View(pos_data)
pos_metadata <- read_csv("/Users/Cody1/Desktop/Projects/RAD Alder/LC-MS/RAD_prelim_metadata_pos.csv") %>% arrange(Sample)
all(pos_data$Sample == pos_metadata$Sample)
```


Analyze positive mode
```{r}
# Calculate the interquartile range (IQR) for each feature
pos.iqr_values <- apply(pos_data[, -c(1:5)], 2, IQR)

# Determine the cutoff threshold based on the 40% filter-out percentage
pos.filter_threshold <- quantile(pos.iqr_values, 0.4)

# Identify features to be filtered out
pos.features_to_filter <- names(pos.iqr_values[pos.iqr_values > pos.filter_threshold])

# Filter out the identified features
fltr.pos_data <- pos_data[, !(names(pos_data) %in% pos.features_to_filter)]

# Define the columns to be transformed
pos.col_trans <- names(fltr.pos_data)[2:ncol(fltr.pos_data)]

# Perform Sample normalization (Normalization by median)
pos_normalized <- fltr.pos_data %>%
  mutate(across(all_of(pos.col_trans), ~./median(.)))

# Perform Log transformation (base 10)
pos_log_transformed <- pos_normalized %>%
  mutate(across(all_of(pos.col_trans), ~log10(.)))

# Perform Auto scaling (mean-centered and divided by the standard deviation of each variable)
pos_trans.df <- pos_log_transformed %>%
  mutate(across(all_of(pos.col_trans), ~scale(.)))

# Assuming your DataFrame is named df, and the columns to be melted are MS_1, MS_2, ..., MS_9
df_long <- pos_trans.df %>%
  pivot_longer(cols = starts_with("MS"), names_to = "id", values_to = "intensity")
head(df_long)

df_long %>%
filter(Sample == "30_Pos.mzML") %>%
  dplyr::summarise(number_of_ids = n_distinct(id))


# Display the head of the long-format DataFrame
head(df_long)
str(df_long)



min(df_long$intensity)


# Now, you can plot the data
# Example plot for the first MS column
filtered_df_long <- df_long[df_long$id %in% unique(df_long$id[1:30]), ]

ggplot(filtered_df_long, aes(x = intensity, y = id)) +
  geom_boxplot()

range(df_long$intensity)

```


Day 0 alder chemistry
```{r}
### load negative mode
neg_data <- read_csv("/Users/cjspiegel/Desktop/Projects/rad_alder/lcms/Negative/Day_0/NEG_day0_trans_quant.csv") %>% arrange(Sample)
neg_metadata <- read_csv("/Users/cjspiegel/Desktop/Projects/rad_alder/lcms/Negative/Day_0/RAD_prelim_metadata_negative_rstudio.csv") %>% arrange(Sample)
all(neg_data$Sample == neg_metadata$Sample)

#make long
neg_long.df<- pivot_longer(neg_data, cols = starts_with("MS_"), 
                        names_to = "ms", values_to = "values")

#Normalize by median within each ms group
neg_long.df <- neg_long.df %>%
  group_by(ms) %>%
  mutate(trans_values = values / median(values, na.rm = TRUE))

# Step 3: Log transformation (base 10)
neg_long.df <- neg_long.df %>%
  mutate(trans_values = log10(trans_values + 1))  # Adding 1 to handle zero values before log transformation

# Step 4: Mean-centered scaling by standard deviation within each ms group
neg_long.df <- neg_long.df %>%
  group_by(ms) %>%
  mutate(trans_values = (trans_values - mean(trans_values, na.rm = TRUE)) / sd(trans_values, na.rm = TRUE))

# Step 5: Merge peak data and metadata
df_final <- merge(neg_long.df, neg_metadata, by = "Sample")

##plot to see normalization worked
#for sample
df_final%>%
ggplot(aes(y = trans_values, x = Sample)) +
  geom_boxplot(fill = "green") +
  labs(x = "Transformed Values", y = "Sample") +  
  theme_minimal()+
  coord_flip()

#desnity plot
df_final %>%
  ggplot(aes(x = trans_values)) +
  geom_density(fill = "skyblue", color = "blue", alpha = 0.5) +  # Customize fill and color
  labs(x = "Values", y = "Density") +  # Labels for axes
  theme_minimal()  # Optional: Use a minimal theme

```

Filter gallotannins, diarylheptanoids, and shikimic acids
```{r}
# Step 6: Filter for MS of interest
ms_of_interest <- c("MS_363", "MS_371", "MS_372", "MS_369", "MS_475", "MS_646", "MS_752", "MS_754", "MS_823", 
                    "MS_834", "MS_895", "MS_929", "MS_1141", "MS_1203", "MS_1205", "MS_1240", "MS_1297", 
                    "MS_1300", "MS_1422", "MS_1431", "MS_1442", "MS_1456")
df_filtered <- df_final %>% filter(ms %in% ms_of_interest)

# Example mapping table (replace with your actual data)
ms_names_mapping <- data.frame(
  MS = c("MS_363", "MS_371", "MS_372", "MS_369", "MS_475", "MS_646", "MS_752", "MS_754", "MS_823", "MS_834", 
         "MS_895", "MS_929", "MS_1141", "MS_1203", "MS_1205", "MS_1240", "MS_1297", "MS_1300", "MS_1422", 
         "MS_1431", "MS_1442", "MS_1456"),
  names = c("Shikimic acids and derivatives", "Shikimic acids and derivatives", "Shikimic acids and derivatives", 
            "Shikimic acids and derivatives", "Shikimic acids and derivatives", "Shikimic acids and derivatives", 
            "Linear diarylheptanoids", "Linear diarylheptanoids", "Linear diarylheptanoids", "Linear diarylheptanoids", 
            "Linear diarylheptanoids", "Linear diarylheptanoids", "Linear diarylheptanoids", "Gallotannins", 
            "Linear diarylheptanoids", "Linear diarylheptanoids", "Linear diarylheptanoids", "Linear diarylheptanoids", 
            "Linear diarylheptanoids", "Linear diarylheptanoids", "Gallotannins", "Gallotannins")
)

# Step 7: Merge with the mapping table to add the names column
df_filtered <- merge(df_filtered, ms_names_mapping, by.x = "ms", by.y = "MS")

# keep MS of interest
columns_to_keep <- c("Sample", "ATTRIBUTE_type", "ATTRIBUTE_TreeID", "ATTRIBUTE_Sitenum", "ATTRIBUTE_Treenum",
                          "MS_363",
                          "MS_371",
                          "MS_372",
                          "MS_369",
                          "MS_475",
                          "MS_646",
                          "MS_752",
                          "MS_754",
                          "MS_823",
                          "MS_834",
                          "MS_895",
                          "MS_929",
                          "MS_1141",
                          "MS_1203",
                          "MS_1205",
                          "MS_1240",
                          "MS_1297",
                          "MS_1300",
                          "MS_1422",
                          "MS_1431",
                          "MS_1442",
                          "MS_1456"
                          )

# Remove columns not in the specified list
filtered_df <- neg_data[, c(columns_to_keep)]
# Example mapping table (replace with your actual data)
ms_names_mapping <- data.frame(
  MS = c("MS_363",
                          "MS_371",
                          "MS_372",
                          "MS_369",
                          "MS_475",
                          "MS_646",
                          "MS_752",
                          "MS_754",
                          "MS_823",
                          "MS_834",
                          "MS_895",
                          "MS_929",
                          "MS_1141",
                          "MS_1203",
                          "MS_1205",
                          "MS_1240",
                          "MS_1297",
                          "MS_1300",
                          "MS_1422",
                          "MS_1431",
                          "MS_1442",
                          "MS_1456"),
  names = c("Shikimic acids and derivatives", 
            "Shikimic acids and derivatives", 
            "Shikimic acids and derivatives", 
            "Shikimic acids and derivatives", 
            
            "Shikimic acids and derivatives", 
            "Shikimic acids and derivatives", 
            "Linear diarylheptanoids", 
            "Linear diarylheptanoids", 
            "Linear diarylheptanoids", 
            "Linear diarylheptanoids", 
            "Linear diarylheptanoids", 
            "Linear diarylheptanoids", 
            "Linear diarylheptanoids", 
            "Gallotannins", 
            "Linear diarylheptanoids", 
            "Linear diarylheptanoids", 
            "Linear diarylheptanoids", 
            "Linear diarylheptanoids", 
            "Linear diarylheptanoids", 
            "Linear diarylheptanoids", 
            "Gallotannins", 
            "Gallotannins")
)

# Merge with filtered_df
filtered_df <- merge(filtered_df, ms_names_mapping)

#make longer df
df_long <- pivot_longer(filtered_df, cols = starts_with("MS_"), 
                        names_to = "ms", values_to = "values")

```


```{r}
#plot
day0_chem.plot<- df_filtered %>%
  ggplot(aes(x = ATTRIBUTE_type, y = trans_values, color = ATTRIBUTE_type, shape = ATTRIBUTE_type)) +
stat_summary(fun = mean, geom = "point", size = 5, position = position_dodge(width = 0.5)) +
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.4, position = position_dodge(width = 0.5), size = 1) +
  facet_wrap(.~names)+
  scale_color_manual(values = c("AB" = "black", "P" = "grey60"), labels = c("absent", "present")) +
    scale_shape_manual(values = c("AB" = 17, "P" = 16), labels = c("absent", "present")) +
  labs(y = "Normalized concentration", x = "Treatment", color = "Treatment", shape = "Treatment")+
  geom_hline(yintercept  = 0, color = "red", linetype = "dashed", alpha = 0.5)+
  guides(color = guide_legend(override.aes = list(shape = c(17, 16))))+
  theme_bw() +
  theme(axis.text = element_text(size = 18),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        strip.text = element_text(size= 18))

day0_chem.plot

ggsave("figures/day0_chem.plot.png", day0_chem.plot, width = 14, height = 7)


# Subset the data for "Linear diarylheptanoids"
compound <- "Linear diarylheptanoids"
df_sub <- df_filtered[df_filtered$names == compound, ]
# Perform t-test
t.test(values ~ ATTRIBUTE_type, data = df_sub)

# Subset the data for "Gallotannins"
compound <- "Gallotannins"
df_sub <- df_filtered[df_filtered$names == compound, ]
# Perform t-test
t.test(values ~ ATTRIBUTE_type, data = df_sub)

# Subset the data for "Shikimic acids"
compound <- "Shikimic acids and derivatives"
df_sub <- df_filtered[df_filtered$names == compound, ]
# Perform t-test
t.test(values ~ ATTRIBUTE_type, data = df_sub)

mean(df_filtered[df_filtered$ATTRIBUTE_type == "AB" & df_filtered$names == "Gallotannins", ]$values)

```


Individuals plot for each MS
```{r}
#this is an example
df_filtered %>%
  filter(ms == "MS_834")%>%
  ggplot(aes(x = ATTRIBUTE_type, y = trans_values, color = ATTRIBUTE_type, shape = ATTRIBUTE_type)) +
stat_summary(fun = mean, geom = "point", size = 5, position = position_dodge(width = 0.5)) +
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.4, position = position_dodge(width = 0.5), size = 1) +
  facet_wrap(.~names)+
  scale_color_manual(values = c("AB" = "black", "P" = "grey60"), labels = c("absent", "present")) +
    scale_shape_manual(values = c("AB" = 17, "P" = 16), labels = c("absent", "present")) +
  labs(y = "Normalized concentration", x = "Treatment", color = "Treatment", shape = "Treatment")+
  geom_hline(yintercept  = 0, color = "red", linetype = "dashed", alpha = 0.5)+
  guides(color = guide_legend(override.aes = list(shape = c(17, 16))))+
  theme_bw() +
  theme(axis.text = element_text(size = 18),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        strip.text = element_text(size= 18))

day0_chem.plot


```




```{r}
# Extract the numeric columns for PCA
tree.numeric_cols <- tree.filtered_df[, 6:ncol(tree.filtered_df)]

type.numeric_cols <- type.filtered_df[, 6:ncol(type.filtered_df)]

# Run PCA
tree.pca_result <- prcomp(tree.numeric_cols, scale. = TRUE)

type.pca_result <- prcomp(type.numeric_cols, scale. = TRUE)


#tree
ggplot() +
  geom_point(data = as.data.frame(tree.pca_result$x), 
             aes(x = PC1, y = PC2, color = tree.filtered_df$Attribute_TreeID, shape = as.factor(tree.filtered_df$Attribute_Sitenum))) +
  labs(title = "Top 40: PCA Biplot",
       x = paste0("PC1 (", round(tree.pca_result$sdev[1] / sum(tree.pca_result$sdev) * 100, 2), "%)"),
       y = paste0("PC2 (", round(tree.pca_result$sdev[2] / sum(tree.pca_result$sdev) * 100, 2), "%)")) +
  theme_minimal()+
  stat_ellipse(data = as.data.frame(tree.pca_result$x), 
               aes(x = PC1, y = PC2, color = as.factor(tree.filtered_df$Attribute_TreeID), fill = as.factor(tree.filtered_df$Attribute_TreeID)),
               show.legend =F,
               geom = "polygon", 
               alpha = 0.2,
               level = 0.95) +
  theme_minimal() +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill = "transparent"))

#type
ggplot() +
  geom_point(data = as.data.frame(type.pca_result$x), 
             aes(x = PC1, y = PC2, color = type.filtered_df$Attribute_type)) +
  labs(title = "Top 40: PCA Biplot",
       x = paste0("PC1 (", round(type.pca_result$sdev[1] / sum(type.pca_result$sdev) * 100, 2), "%)"),
       y = paste0("PC2 (", round(type.pca_result$sdev[2] / sum(type.pca_result$sdev) * 100, 2), "%)")) +
  theme_minimal()+
  stat_ellipse(data = as.data.frame(type.pca_result$x), 
               aes(x = PC1, y = PC2, color = as.factor(type.filtered_df$Attribute_type), fill = as.factor(type.filtered_df$Attribute_type)),
               show.legend =F,
               geom = "polygon", 
               alpha = 0.2,
               level = 0.95) +
  theme_minimal() +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill = "transparent"))




```



Look at individual ms
```{r}

# Select relevant columns
type.filtered_df <- neg_data_ra[, c("Sample", "ATTRIBUTE_type", "MS_363")]
View(neg_data_ra)
# Reshape data for plotting
ms_data_long <- tidyr::gather(type.filtered_df, key = "MS_Column", value = "Peak_Intensity", -c(Sample, Attribute_type))

# Plot using ggplot
ggplot(ms_data_long, aes(x = Attribute_type, y = Peak_Intensity, fill = Attribute_type)) +
  geom_boxplot(position = "identity") +
  labs(title = "Peak Intensity by Attribute Type",
       x = "Attribute Type",
       y = "Peak Intensity") +
  theme_minimal()











```




```{r}
# Assuming you have a data frame containing the loadings of MS columns in each principal component
loadings_df <- as.data.frame(pca_result$rotation[, 1:2])

type.loadings_df <- as.data.frame(type.pca_result$rotation[, 1:2])


# Assuming you have a list of MS column names
ms_columns <- c("MS_3998", "MS_3995", "MS_2909" ,"MS_478"  ,"MS_2911" ,"MS_2716" ,"MS_2720", "MS_2913" ,"MS_405" , "MS_2915" ,"MS_2905",
"MS_477"  ,"MS_2918", "MS_2917" ,"MS_2907", "MS_2916", "MS_2735", "MS_2887" ,"MS_678" , "MS_2910", "MS_2724" ,"MS_2728",
"MS_2726", "MS_2904" ,"MS_3808", "MS_1286", "MS_2886", "MS_2908" ,"MS_1050" ,"MS_3029", "MS_3025" ,"MS_2733" ,"MS_2884",
"MS_636" , "MS_2729" ,"MS_3039", "MS_3024", "MS_2715", "MS_2906" ,"MS_3034" ,"MS_679" , "MS_2714" ,"MS_2892", "MS_3027",
"MS_3650", "MS_2721" ,"MS_3953", "MS_2736", "MS_2717", "MS_2450")

type.ms_columns <- c("MS_1702", "MS_1167", "MS_1693", "MS_3914", "MS_3130", "MS_1700", "MS_1000" ,"MS_1701", "MS_1691", "MS_1672", "MS_1709",
"MS_1372", "MS_3915" ,"MS_1166", "MS_1215" ,"MS_1350", "MS_3774" ,"MS_1681" ,"MS_1313", "MS_1689", "MS_1315" ,"MS_4098",
"MS_1676", "MS_1007" ,"MS_1680" ,"MS_3778" ,"MS_3777" ,"MS_1699" ,"MS_1161" ,"MS_1004" ,"MS_1171", "MS_3918" ,"MS_1534",
"MS_1172", "MS_1393", "MS_1151" ,"MS_1687", "MS_1373" ,"MS_1399" ,"MS_1157")

# Find the corresponding loadings for MS columns
ms_loadings <- loadings_df[rownames(loadings_df) %in% ms_columns, ]

type.ms_loadings <- type.loadings_df[rownames(type.loadings_df) %in% type.ms_columns, ]


# Perform PCA
type.pca_result <- prcomp(type.loadings_df[, -c(1:5)], scale. = TRUE)

# Plot PCA
ggplot() +
  geom_point(data = as.data.frame(pca_result$x), 
             aes(x = PC1, y = PC2, color = df$Attribute_TreeID)) +
  labs(title = "PCA Biplot",
       x = paste0("PC1 (", round(pca_result$sdev[1] / sum(pca_result$sdev) * 100, 2), "%)"),
       y = paste0("PC2 (", round(pca_result$sdev[2] / sum(pca_result$sdev) * 100, 2), "%)")) +
  theme_minimal()


#looking at tree ID
ggplot() +
  geom_point(data = as.data.frame(pca_result$x), 
             aes(x = PC1, y = PC2, color = df$Attribute_type)) +
  labs(title = "Top 50 features: PCA Biplot",
       x = paste0("PC1 (", round(pca_result$sdev[1] / sum(pca_result$sdev) * 100, 2), "%)"),
       y = paste0("PC2 (", round(pca_result$sdev[2] / sum(pca_result$sdev) * 100, 2), "%)")) +
  stat_ellipse(data = as.data.frame(pca_result$x), 
               aes(x = PC1, y = PC2, color = as.factor(df$Attribute_type), fill = as.factor(df$Attribute_type)),
               show.legend =F,
               geom = "polygon", 
               alpha = 0.2,
               level = 0.95) +
  theme_minimal() +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill = "transparent"))

```



```{r}
# Generate negative mode PCA raw
neg_PCA_whole <- mixOmics::pca(column_to_rownames(neg_data, var = "Sample"), ncomp = 2, scale = TRUE)
neg_PCA_whole_scores<- data.frame(neg_PCA_whole$variates$X, neg_metadata)

#### negative PCA plot for treatment (can also change for tree ID)
neg_PCA_whole_scores%>%
  ggscatter(x = "PC1", y = "PC2", color = "Attribute_type", alpha = 0.6, 
            title = paste("PCA RAW -", "Attribute_type", sep = " "),
            xlab = paste("PC1 (", round(neg_PCA_whole$prop_expl_var$X[1]*100, digits = 1),"%)", sep = ""), 
            ylab = paste("PC2 (", round(neg_PCA_whole$prop_expl_var$X[2]*100, digits = 1),"%)", sep = ""),
            ggtheme = theme_classic()) +
  geom_point(data = neg_PCA_whole_scores %>% group_by(Attribute_type) %>% 
               summarise_at(vars(matches("PC")), mean), aes(PC1, PC2, color = Attribute_type), size = 4, shape = 8) +
  stat_ellipse(aes(PC1, PC2, color = Attribute_type), geom = "polygon", level = 0.95, alpha = 0.2) +  # Add ellipses
  theme(plot.title = element_text(size = 10), axis.title = element_text(size = 8),
        axis.text = element_text(size = 4)) + coord_fixed()

# PERMANOVA
neg_dist_metabolites <- vegdist(column_to_rownames(neg_data, var = "Sample"), method = "euclidean")
neg_permanova <- adonis2(neg_dist_metabolites ~ neg_PCA_whole_scores$Attribute_type, neg_PCA_whole_scores, na.action = na.omit)


###################################


# Generate positive mode PCA raw
pos_PCA_whole <- mixOmics::pca(column_to_rownames(pos_data, var = "Sample"), ncomp = 2, scale = TRUE)
pos_PCA_whole_scores <- data.frame(pos_PCA_whole$variates$X, pos_metadata)

#### positive PCA plot for treatment (can also change for tree ID)
pos_PCA_whole_scores %>%
  ggscatter(x = "PC1", y = "PC2", color = "Attribute_type", alpha = 0.6, 
            title = paste("PCA RAW -", "Attribute_type", sep = " "),
            xlab = paste("PC1 (", round(pos_PCA_whole$prop_expl_var$X[1]*100, digits = 1),"%)", sep = ""), 
            ylab = paste("PC2 (", round(pos_PCA_whole$prop_expl_var$X[2]*100, digits = 1),"%)", sep = ""),
            ggtheme = theme_classic()) +
  geom_point(data = pos_PCA_whole_scores %>% group_by(Attribute_type) %>%
               summarise_at(vars(matches("PC")), mean), aes(PC1, PC2, color = Attribute_type), size = 4, shape = 8)+
  stat_ellipse(aes(PC1, PC2, color = as.factor(Attribute_type)), geom = "polygon", level = 0.95, alpha = 0.2) +  # Add ellipses
  theme(plot.title = element_text(size = 10), axis.title = element_text(size = 8),
        axis.text = element_text(size = 4)) + coord_fixed()

pos_PCA_whole_scores$Attribute_Sitenum=as.factor(pos_PCA_whole_scores$Attribute_Sitenum)

pos_PCA_whole_scores %>%
  ggscatter(
    x = "PC1", y = "PC2",
    color = "Attribute_TreeID",
    shape = "Attribute_Sitenum",
    alpha = 0.6,
    title = paste("PCA RAW -", "Attribute_Sitenum", sep = " "),
    xlab = paste("PC1 (", round(pos_PCA_whole$prop_expl_var$X[1] * 100, digits = 1), "%)", sep = ""),
    ylab = paste("PC2 (", round(pos_PCA_whole$prop_expl_var$X[2] * 100, digits = 1), "%)", sep = ""),
    ggtheme = theme_classic()
  ) +geom_point(
    data = pos_PCA_whole_scores %>% 
      group_by(Attribute_TreeID, Attribute_Sitenum) %>% 
      summarise_at(vars(matches("PC")), mean),
    aes(PC1, PC2, color = Attribute_TreeID, shape = Attribute_Sitenum),
    alpha = 0.6
  )+
  stat_ellipse(aes(PC1, PC2, color = Attribute_TreeID, shape = Attribute_Sitenum), geom = "polygon", level = 0.95, alpha = 0.1) +  # Add ellipses
  theme(plot.title = element_text(size = 10), axis.title = element_text(size = 8),
        axis.text = element_text(size = 4)) + coord_fixed()


```

Negative mode stats
```{r}
### load negative mode
neg_data <- read_csv("/Users/cjspiegel/Desktop/Projects/rad_alder/lcms/Negative/Day_0/NEG_day0_trans_quant.csv") %>% arrange(Sample)
View(neg_data)
neg_metadata <- read_csv("/Users/cjspiegel/Desktop/Projects/rad_alder/lcms/Negative/Day_0/RAD_prelim_metadata_negative_rstudio.csv") %>% arrange(Sample)
all(neg_data$Sample == neg_metadata$Sample)


# Generate PCA relative abundance
neg_data_ra <- (column_to_rownames(neg_data, var = "Sample"))/rowSums(column_to_rownames(neg_data, var = "Sample"))
neg_data_ra<- neg_data_ra[, -c(632,864)]
neg_PCA_whole_ra <- mixOmics::pca(neg_data_ra, ncomp = 2, scale = TRUE)
neg_PCA_whole_ra_scores <- data.frame(neg_PCA_whole_ra$variates$X, neg_metadata)

#plot
neg_PCA_whole_ra_scores %>%
  ggscatter(x = "PC1", y = "PC2", color = "ATTRIBUTE_TreeID", alpha = 0.6, 
            title = paste("PCA RA -", "ATTRIBUTE_TreeID", sep = " "),
            xlab = paste("PC1 (", round(neg_PCA_whole_ra$prop_expl_var$X[1]*100, digits = 1),"%)", sep = ""), 
            ylab = paste("PC2 (", round(neg_PCA_whole_ra$prop_expl_var$X[2]*100, digits = 1),"%)", sep = ""),
            ggtheme = theme_classic()) +
  geom_point(data = neg_PCA_whole_ra_scores %>% group_by(ATTRIBUTE_TreeID) %>% 
               summarise_at(vars(matches("PC")), mean), aes(PC1, PC2, color = ATTRIBUTE_TreeID), size = 4, shape = 8) +
  theme(plot.title = element_text(size = 10), axis.title = element_text(size = 8),
        axis.text = element_text(size = 4)) +
  stat_ellipse(aes(PC1, PC2, color = ATTRIBUTE_TreeID), geom = "polygon", level = 0.95, alpha = 0.2) +  # Add ellipses
  theme(plot.title = element_text(size = 10), axis.title = element_text(size = 8),
        axis.text = element_text(size = 4)) + coord_fixed()

neg_PCA_whole_ra_scores$ATTRIBUTE_Sitenum=as.factor(neg_PCA_whole_ra_scores$ATTRIBUTE_Sitenum)


# plot with site
neg_PCA_whole_ra_scores %>%
  ggscatter(
    x = "PC1", y = "PC2",
    color = "ATTRIBUTE_TreeID",
    shape = "ATTRIBUTE_Sitenum",
    alpha = 0.6,
    title = paste("PCA RAW -", "ATTRIBUTE_Sitenum", sep = " "),
    xlab = paste("PC1 (", round(neg_PCA_whole_ra$prop_expl_var$X[1] * 100, digits = 1), "%)", sep = ""),
    ylab = paste("PC2 (", round(neg_PCA_whole_ra$prop_expl_var$X[2] * 100, digits = 1), "%)", sep = ""),
    ggtheme = theme_classic()
  ) +geom_point(
    data = neg_PCA_whole_ra_scores %>% 
      group_by(ATTRIBUTE_TreeID, ATTRIBUTE_Sitenum) %>% 
      summarise_at(vars(matches("PC")), mean),
    aes(PC1, PC2, color = ATTRIBUTE_TreeID, shape = ATTRIBUTE_Sitenum),
    alpha = 0.6
  )+
  stat_ellipse(aes(PC1, PC2, color = ATTRIBUTE_TreeID, shape = ATTRIBUTE_Sitenum), geom = "polygon", level = 0.95, alpha = 0.1) +  # Add ellipses
  theme(plot.title = element_text(size = 10), axis.title = element_text(size = 8),
        axis.text = element_text(size = 4)) + coord_fixed()

library(ggforce)

neg_PCA_whole_ra_scores %>%
  ggscatter(
    x = "PC1", y = "PC2",
    color = "ATTRIBUTE_TreeID",
    shape = "ATTRIBUTE_Sitenum",
    alpha = 0.6,
    title = paste("PCA RAW -", "ATTRIBUTE_Sitenum", sep = " "),
    xlab = paste("PC1 (", round(neg_PCA_whole_ra$prop_expl_var$X[1] * 100, digits = 1), "%)", sep = ""),
    ylab = paste("PC2 (", round(neg_PCA_whole_ra$prop_expl_var$X[2] * 100, digits = 1), "%)", sep = ""),
    ggtheme = theme_classic()
  ) +
  geom_point(
    data = neg_PCA_whole_ra_scores %>% 
      group_by(ATTRIBUTE_TreeID, ATTRIBUTE_Sitenum) %>% 
      summarise_at(vars(matches("PC")), mean),
    aes(PC1, PC2, color = ATTRIBUTE_TreeID, shape = ATTRIBUTE_Sitenum),
    alpha = 0.6
  ) +
  theme(plot.title = element_text(size = 10), axis.title = element_text(size = 8),
        axis.text = element_text(size = 4)) + coord_fixed()


# PERMANOVA
neg_dist_metabolites_ra <- vegdist(neg_data_ra, method = "euclidean")
neg_permanova_ra <- adonis2(neg_dist_metabolites_ra ~ neg_PCA_whole_ra_scores$ATTRIBUTE_type, neg_PCA_whole_ra_scores, na.action = na.omit)

############################

#by tree ID
adonis2(neg_dist_metabolites_ra ~ neg_PCA_whole_ra_scores$ATTRIBUTE_type, neg_PCA_whole_ra_scores, na.action = na.omit)

### Create PLSDA for AB vs No AB in HF diet mice
# Pairwise PLS_DA
data_clr_CT_MPS <- data_clr %>% dplyr::filter(neg_metadata$ATTRIBUTE_type != "H2O2")
metadata_clr_CT_MPS <- metadata %>% dplyr::filter(metadata$Attribute_type != "H2O2")


data_clr_CT_MPS <- data_clr %>% dplyr::filter(neg_data_ra)
metadata_clr_CT_MPS <- metadata %>% dplyr::filter(metadata$Attribute_type != "H2O2")

# Create PLSDA for AB vs No AB in HF diet mice
PLSDA_CT_MPS <- mixOmics::plsda(neg_data_ra, neg_metadata$ATTRIBUTE_type, ncomp = 3, scale = TRUE)
PLSDA_CT_MPS_scores <- data.frame(PLSDA_CT_MPS$variates$X, neg_metadata)

numeric_matrix <- data.matrix(neg_data_ra)
neg_data_numeric <- sapply(neg_data_ra, function(x) as.numeric(as.character(x)))

neg_PLSDA<- mixOmics::plsda(neg_data_numeric, neg_metadata$ATTRIBUTE_type, ncomp = 3, scale = TRUE)
neg_PLSDA_scores <- data.frame(neg_PLSDA$variates$X, neg_metadata)

neg_PLSDA_scores %>%
  ggscatter(x = "comp1", y = "comp2", color = "ATTRIBUTE_type", alpha = 0.6, title = "PLS-DA AB vs P",
            xlab = paste("Component 1 (", round(neg_PLSDA$prop_expl_var$X[1]*100, digits = 1),"%)", sep = ""), 
            ylab = paste("Component 2 (", round(neg_PLSDA$prop_expl_var$X[2]*100, digits = 1),"%)", sep = ""),
            legend.title = "Group", ggtheme = theme_classic()) +
  geom_point(data = neg_PLSDA_scores %>% group_by(ATTRIBUTE_type) %>% 
               summarise_at(vars(matches("comp")), mean), aes(comp1, comp2, color = ATTRIBUTE_type), size = 3, shape = 8) +
  theme(plot.title = element_text(size = 10),axis.title = element_text(size = 8),
        axis.text = element_text(size = 5)) + coord_fixed()


perf_neg_plsda <- mixOmics::perf(neg_PLSDA, validation = "Mfold", progressBar = FALSE, auc = TRUE, folds = 4, nrepeat = 100) 

plot(perf_neg_plsda, legend = FALSE)

neg_loadings <- plotLoadings(neg_PLSDA, plot = FALSE, contrib = "max") %>%
  rownames_to_column() %>% dplyr::select(rowname, GroupContrib, importance)

neg_VIPs <- as.data.frame(mixOmics::vip(neg_PLSDA))
neg_VIPs_filter <- dplyr::filter(neg_VIPs, neg_VIPs$comp1 > 1)
neg_VIPs_filter$ID <- rownames(neg_VIPs_filter)
neg_VIPs_select <- neg_VIPs_filter %>% dplyr::select(ID, comp1)
neg_VIPs_Load <- neg_VIPs_select %>% left_join(neg_loadings, by = c("ID" = "rowname")) %>% arrange(desc(comp1))
neg_VIPs_Load_top <- VIPs_CT_MPS_Load %>% head(., 50)

Loadings_CT_MPS_plot <- plotLoadings(neg_loadings, plot = FALSE, contrib = "max") %>%
  arrange(GroupContrib) %>%
  rownames_to_column(var = "Feature") %>%
  dplyr::filter(Feature %in% VIPs_CT_MPS_Load_top$ID) %>%
  ggdotchart(x = "Feature", y = "importance",
             color = "GroupContrib", sorting = "ascending",  
             dot.size = 2, add = "segments",                  
             add.params = list(color = "lightgray", size = 0.1),
             title = "Loadings PLS-DA - CT v MPS") + geom_hline(yintercept = 0, linetype = 2, color = "lightgray")





```


Positive mode stats
```{r}
# PERMANOVA
pos_dist_metabolites <- vegdist(column_to_rownames(pos_data, var = "Sample"), method = "euclidean")
pos_permanova <- adonis2(pos_dist_metabolites ~ pos_PCA_whole_scores$Attribute_type, pos_PCA_whole_scores, na.action = na.omit)

# Generate PCA relative abundance
pos_data_ra <- (column_to_rownames(pos_data, var = "Sample"))/rowSums(column_to_rownames(pos_data, var = "Sample"))
pos_PCA_whole_ra <- mixOmics::pca(pos_data_ra, ncomp = 2, scale = TRUE)
pos_PCA_whole_ra_scores <- data.frame(pos_PCA_whole_ra$variates$X, pos_metadata)

PCA_whole_ra_scores_pos %>%
  ggscatter(x = "PC1", y = "PC2", color = "Attribute_TreeID", alpha = 0.6, 
            title = paste("PCA RA -", "Attribute_TreeID", sep = " "),
            xlab = paste("PC1 (", round(PCA_whole_ra_pos$prop_expl_var$X[1]*100, digits = 1),"%)", sep = ""), 
            ylab = paste("PC2 (", round(PCA_whole_ra_pos$prop_expl_var$X[2]*100, digits = 1),"%)", sep = ""),
            ggtheme = theme_classic()) +
  geom_point(data = PCA_whole_ra_scores_pos %>% group_by(Attribute_TreeID) %>% 
               summarise_at(vars(matches("PC")), mean), aes(PC1, PC2, color = Attribute_TreeID), size = 4, shape = 8) +
  theme(plot.title = element_text(size = 10), axis.title = element_text(size = 8),
        axis.text = element_text(size = 4)) + coord_fixed() +
  theme(plot.title = element_text(size = 10), axis.title = element_text(size = 8),
        axis.text = element_text(size = 4)) +
  stat_ellipse(aes(PC1, PC2, color = Attribute_TreeID), geom = "polygon", level = 0.95, alpha = 0.2)   # Add ellipses

# PERMANOVA
pos_dist_metabolites_ra <- vegdist(pos_data_ra, method = "euclidean")
pos_permanova_ra <- adonis2(pos_dist_metabolites_ra ~ pos_PCA_whole_ra_scores$Attribute_type, pos_PCA_whole_ra_scores, na.action = na.omit)

#by tree ID
adonis2(pos_dist_metabolites_ra ~ PCA_whole_ra_scores_pos$Attribute_TreeID, PCA_whole_ra_scores_pos, na.action = na.omit)


```


isotopes
```{r}
#load data
isotope.df<- read.csv("/Users/cjspiegel/Desktop/GitHub/rad_alder2.0/data/isotopes.csv") 

#add new columns
isotope.df<- isotope.df%>%
  group_by(treatment, tree_id, site_num, tree_num)%>%
   mutate(total_c.g = total_C / 10^6,
         total_n.g = total_N / 10^6,
         c_n = total_c.g / total_n.g,
         weight.g = weight / 1000,
         perc.c = (total_c.g / weight.g) * 100,
         perc.n = (total_n.g / weight.g) * 100)

#assign class
isotope.df$treatment<- as.factor(isotope.df$treatment)
isotope.df$tree_id<- as.factor(isotope.df$tree_id)
isotope.df$site_num<- as.factor(isotope.df$site_num)
isotope.df$tree_num<- as.factor(isotope.df$tree_num)
```

figures
```{r}
#### isotope analysis
#explore the data
#checking normality
isotope.df%>%
  filter(treatment == "AB")%>%
  pull(c_n)%>%
  normalTest(method = "da")
#checking normality
isotope.df%>%
  filter(treatment == "P")%>%
  pull(perc.n)%>%
  normalTest(method = "da")
#check means
isotope.df%>%
  filter(treatment == "P")%>%
  summarise(mean(c_n))

isotope.df%>%
  filter(treatment == "AB")%>%
  summarise(mean(c_n))

####C:N stats and plot
c_n.plot<- isotope.df%>%
  ggplot(aes(treatment, c_n, color = treatment, shape = treatment))+
  stat_summary(fun = mean, geom = "point", size = 5, position = position_dodge(width = 0.5)) +
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.4, position = position_dodge(width = 0.5), size = 1) +
  scale_color_manual(values = c("AB" = "black", "P" = "grey60"), labels = c("absent", "present")) +
    scale_shape_manual(values = c("AB" = 17, "P" = 16), labels = c("absent", "present")) +
geom_hline(aes(yintercept = mean(c_n)), color = "red3", linetype = "dashed") +
   labs(x = "Treatment", y = "C:N") +
  guides(color = guide_legend(override.aes = list(shape = c(17, 16))))+
  theme_bw() +
  theme(axis.text = element_text(size = 18),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18))
c_n.plot

ggsave("figures/c_n.plot.png", c_n.plot, width = 14, height = 7)

#c:n stats
t.test(isotope.df[isotope.df$treatment == "P",]$c_n,isotope.df[isotope.df$treatment == "AB",]$c_n)
  
  
```


```{r}
#### isotope analysis
#explore the data
#checking normality
isotope.df%>%
  filter(treatment == "AB")%>%
  pull(perc.n)%>%
  normalTest(method = "da")
#checking normality
isotope.df%>%
  filter(treatment == "P")%>%
  pull(perc.n)%>%
  normalTest(method = "da")

####percent N stats and plot
perc_n.plot<- isotope.df%>%
  ggplot(aes(treatment, perc.n, color = treatment, shape = treatment))+
  stat_summary(fun = mean, geom = "point", size = 5, position = position_dodge(width = 0.5)) +
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.4, position = position_dodge(width = 0.5), size = 1) +
  scale_color_manual(values = c("AB" = "black", "P" = "grey60"), labels = c("absent", "present")) +
    scale_shape_manual(values = c("AB" = 17, "P" = 16), labels = c("absent", "present")) +
geom_hline(aes(yintercept = mean(perc.n)), color = "red3", linetype = "dashed") +
    scale_y_continuous(breaks = seq(1.7, 2.75, by = 0.06))+
   labs(x = "Treatment", y = "Nitrogen (%)") +
  guides(color = guide_legend(override.aes = list(shape = c(17, 16))))+
  theme_bw() +
  theme(axis.text = element_text(size = 18),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18))

ggsave("figures/perc_n.plot.png", perc_n.plot, width = 14, height = 7)

t.test(isotope.df[isotope.df$treatment == "P",]$perc.n,isotope.df[isotope.df$treatment == "AB",]$perc.n)
  


```


```{r}
#C:N ratio
c_n.aov=aov(c_n ~ treatment, data =isotope.df)
c_n.tHSD=TukeyHSD(c_n.aov, ordered = F, conf.level = 0.95)
c_n.cld <- multcompLetters4(c_n.aov, c_n.tHSD)

# table with factors and 3rd quantile
c_n.table <- isotope.df%>%
  dplyr::group_by(treatment) %>%
  dplyr::summarise(mean=mean(c_n), quant = quantile(c_n, probs = 0.75)) %>%
  dplyr::arrange(desc(mean))

# extracting the compact letter display and adding to the Tk table
c_n.cld <- as.data.frame.list(c_n.cld$treatment)
c_n.table$cld <- c_n.cld$Letters
#plot

C_N.plot=isotope.df %>%
  ggplot(aes(x = treatment, y = c_n, color= treatment, fill = treatment)) +
      geom_boxplot(alpha = 0.6, outlier.shape = NA) +
  geom_point(data = isotope.df %>%
               dplyr::group_by(treatment) %>%
               dplyr::summarize(mean_c_n = mean(c_n)),
             aes(y = mean_c_n), shape = 23, size = 3, color = "black", position = position_dodge(width = 0.4)) +
 geom_point(alpha = 0.6, position = position_jitter(width = 0.1), size = 2) +
  xlab("treatment")+
  ylab("C:N")+
scale_color_manual(values = c("#CC79A7", "#009E73"), labels = c("absent", "present")) +
    scale_fill_manual(values = c("#CC79A7", "#009E73"), labels = c("absent", "present")) +
  theme(plot.title = element_text(face = "bold"))+
  geom_text(data = c_n.table, aes(y = quant, label = cld), color = "blue", fontface= "bold",size = 5, vjust=-2.5, hjust =-0.76)+
  scale_x_discrete(labels = c("absent", "present"))+
  theme_bw()+
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    strip.text = element_text(size = 16)
  )


summary(c_n.aov)
plot(resid(c_n.aov))
c_n.t_test=t.test(isotope.df[isotope.df$treatment == "P",]$c_n, isotope.df[isotope.df$treatment == "AB",]$c_n)
c_n.lmer=lmer(c_n ~ treatment  + ( 1 | tree_id) + (1 | tree_num) + (1 | site_num), data =isotope.df)
c_n.lmer2=lmer(c_n ~ treatment  + ( 1 | tree_id) + (1 | tree_num) + (1 | site_num), data =isotope.df)
c_n.lmer3=lmer(c_n ~ treatment  + ( 1 | tree_id) + (1 | tree_num), data =isotope.df)
c_n.lmer4=lmer(c_n ~ treatment  + ( 1 | tree_id), data =isotope.df)
c_n.lmer5=lmer(c_n ~ treatment  + (1 | tree_num) + (1 | site_num), data =isotope.df)
c_n.lmer6=lmer(c_n ~ treatment  + (1 | tree_num), data =isotope.df)
c_n.lmer7=lmer(c_n ~ treatment  + (1 | site_num), data =isotope.df)
c_n.lmer8=lmer(c_n ~ treatment  + ( 1 | tree_id) + (1 | site_num), data =isotope.df)


AIC(c_n.aov, c_n.lmer,c_n.lmer2,c_n.lmer3,c_n.lmer4,c_n.lmer5,c_n.lmer6,c_n.lmer7,c_n.lmer8)

#d13C
d13C.aov=aov(d13C ~ treatment, data =isotope.df)
d13C.tHSD=TukeyHSD(d13C.aov, ordered = F, conf.level = 0.95)
d13C.cld <- multcompLetters4(d13C.aov, d13C.tHSD)

# table with factors and 3rd quantile
d13C.table <- isotope.df%>%
  dplyr::group_by(treatment) %>%
  dplyr::summarise(mean=mean(d13C), quant = quantile(d13C, probs = 0.75)) %>%
  dplyr::arrange(desc(mean))

# extracting the compact letter display and adding to the Tk table
d13C.cld <- as.data.frame.list(d13C.cld$treatment)
d13C.table$cld <- d13C.cld$Letters
#plot

d13C.plot=isotope.df %>%
  ggplot(aes(x = treatment, y = d13C, fill = treatment)) +
  geom_boxplot(alpha = 0.6) +
  xlab("treatment")+
  ylab("d13C")+
  geom_point(aes(shape = as.factor(site_num)), position = position_jitter(width = 0.15))+
scale_color_manual(values = c("#CC79A7", "#009E73")) +
    scale_fill_manual(values = c("#CC79A7", "#009E73")) +
  geom_hline(aes(yintercept = mean(d13C), linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  theme_classic()+
  theme(plot.title = element_text(face = "bold"))+
  geom_text(data = d13C.table, aes(y = quant, label = cld), color = "blue", fontface= "bold",size = 5, vjust=-2, hjust =-0.76)+
  theme_classic()



#d15N
d15N.aov=aov(d15N ~ treatment, data =isotope.df)
d15N.tHSD=TukeyHSD(d15N.aov, ordered = F, conf.level = 0.95)
d15N.cld <- multcompLetters4(d15N.aov, d15N.tHSD)

# table with factors and 3rd quantile
d15N.table <- isotope.df%>%
  dplyr::group_by(treatment) %>%
  dplyr::summarise(mean=mean(d15N), quant = quantile(d15N, probs = 0.75)) %>%
  dplyr::arrange(desc(mean))

# extracting the compact letter display and adding to the Tk table
d15N.cld <- as.data.frame.list(d15N.cld$treatment)
d15N.table$cld <- d15N.cld$Letters

#plot
d15N.plot=isotope.df %>%
  ggplot(aes(x = treatment, y = d15N, fill = treatment)) +
  geom_boxplot(alpha = 0.6) +
  xlab("treatment")+
  ylab("d15N")+
  geom_point(aes(shape = as.factor(site_num)), position = position_jitter(width = 0.15))+
scale_color_manual(values = c("#CC79A7", "#009E73")) +
    scale_fill_manual(values = c("#CC79A7", "#009E73")) +
  geom_hline(aes(yintercept = mean(d15N), linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  theme_classic()+
  theme(plot.title = element_text(face = "bold"))+
  geom_text(data = d15N.table, aes(y = quant, label = cld), color = "blue", fontface= "bold",size = 5, vjust=-2, hjust =-0.76)+
  theme_classic()

# %C
perc.C.aov=aov(perc.C ~ treatment, data =isotope.df)
perc.C.tHSD=TukeyHSD(perc.C.aov, ordered = F, conf.level = 0.95)
perc.C.cld <- multcompLetters4(perc.C.aov, d15N.tHSD)

# table with factors and 3rd quantile
perc.C.table <- isotope.df%>%
  dplyr::group_by(treatment) %>%
  dplyr::summarise(mean=mean(perc.C), quant = quantile(perc.C, probs = 0.75)) %>%
  dplyr::arrange(desc(mean))

# extracting the compact letter display and adding to the Tk table
perc.C.cld <- as.data.frame.list(perc.C.cld$treatment)
perc.C.table$cld <- perc.C.cld$Letters

#plot
perc.C.plot=isotope.df %>%
  ggplot(aes(x = treatment, y = perc.C, fill = treatment)) +
  geom_boxplot(alpha = 0.6) +
  xlab("treatment")+
  ylab("% C")+
  geom_point(aes(shape = as.factor(site_num)), position = position_jitter(width = 0.15))+
scale_color_manual(values = c("#CC79A7", "#009E73")) +
    scale_fill_manual(values = c("#CC79A7", "#009E73")) +
  geom_hline(aes(yintercept = mean(perc.C), linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  theme_classic()+
  theme(plot.title = element_text(face = "bold"))+
  geom_text(data = perc.C.table, aes(y = quant, label = cld), color = "blue", fontface= "bold",size = 5, vjust=-2, hjust =-0.76)+
  theme_classic()


# %N
perc.N.aov=aov(perc.N ~ treatment, data =isotope.df)
perc.N.tHSD=TukeyHSD(perc.N.aov, ordered = F, conf.level = 0.95)
perc.N.cld <- multcompLetters4(perc.N.aov, d15N.tHSD)

# table with factors and 3rd quantile
perc.N.table <- isotope.df%>%
  dplyr::group_by(treatment) %>%
  dplyr::summarise(mean=mean(perc.N), quant = quantile(perc.N, probs = 0.75)) %>%
  dplyr::arrange(desc(mean))

# extracting the compact letter display and adding to the Tk table
perc.N.cld <- as.data.frame.list(perc.N.cld$treatment)
perc.N.table$cld <- perc.N.cld$Letters

#plot
perc.N.plot=isotope.df %>%
  ggplot(aes(x = treatment, y = perc.N, fill = treatment)) +
  geom_boxplot(alpha = 0.6) +
  xlab("treatment")+
  ylab("% N")+
  geom_point(aes(shape = as.factor(site_num)), position = position_jitter(width = 0.15))+
 scale_color_manual(values = c("#CC79A7", "#009E73")) +
    scale_fill_manual(values = c("#CC79A7", "#009E73")) +
  geom_hline(aes(yintercept = mean(perc.N), linetype = "Average"), color = alpha("red", 1), linetype = "dashed") +
  theme_classic()+
  theme(plot.title = element_text(face = "bold"))+
  geom_text(data = perc.N.table, aes(y = quant, label = cld), color = "blue", fontface= "bold",size = 5, vjust=-2, hjust =-0.76)+
  theme_classic()

prelim.isotope.plot=plot_grid(
  C_N.plot,
  d13C.plot,
  d15N.plot,
  perc.C.plot,
  perc.N.plot,
  rel_widths = c(8,8,8,8,8))
  
  
ggsave("figures/prelim.isotope.plot.pdf", prelim.isotope.plot, width = 18, height = 12)



```



Playing around with mzMine
```{r}   

norm <- read.csv("/Users/Cody1/Desktop/Projects/RAD Alder/LC-MS/RAD_negative_mode_11_3_2023_quant_copy.csv")
norm <- norm %>% dplyr::select(-X)
norm <- norm %>% rename_with(~str_replace_all(., ".mzML.Peak.area", ""))
norm <- norm %>% dplyr::select(-(row.m.z:correlation.group.ID), -(best.ion:neutral.M.mass))
norm <- norm %>% mutate(across(row.ID:annotation.network.number, as.character))
norm

lib<- read.delim("/Users/Cody1/Downloads/ProteoSAFe-FEATURE-BASED-MOLECULAR-NETWORKING-6622b124-view_all_clusters_withID/DB_result/411d53da00ef4c329314baffe5ce6812.tsv")


# Merge the data frames based on common column "row.ID" in df1 and "scan" in df2
merged_df <- norm %>%
  inner_join(lib, by = c(as.integer("row.ID") = "X.Scan."))

# Select the columns of interest
result_df <- merged_df %>%
  select(row.ID, compound_name, compound_class, starts_with("sample"))

print(result_df)




```

